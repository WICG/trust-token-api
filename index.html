<!doctype html><html lang="en">
 <head>
  <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
  <title>Private State Token API</title>
  <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport">
  <link href="https://www.w3.org/StyleSheets/TR/2021/cg-draft" rel="stylesheet">
  <meta content="Bikeshed version bf22245b8, updated Tue Apr 18 15:53:37 2023 -0700" name="generator">
  <link href="https://wicg.github.io/trust-token-api/" rel="canonical">
  <meta content="9927f3ca4f2f7280285653ed5d47aed0c8f9fbf1" name="document-revision">
<style>/* style-autolinks */
.css.css, .property.property, .descriptor.descriptor {
    color: var(--a-normal-text);
    font-size: inherit;
    font-family: inherit;
}
.css::before, .property::before, .descriptor::before {
    content: "‘";
}
.css::after, .property::after, .descriptor::after {
    content: "’";
}
.property, .descriptor {
    /* Don't wrap property and descriptor names */
    white-space: nowrap;
}
.type { /* CSS value <type> */
    font-style: italic;
}
pre .property::before, pre .property::after {
    content: "";
}
[data-link-type="property"]::before,
[data-link-type="propdesc"]::before,
[data-link-type="descriptor"]::before,
[data-link-type="value"]::before,
[data-link-type="function"]::before,
[data-link-type="at-rule"]::before,
[data-link-type="selector"]::before,
[data-link-type="maybe"]::before {
    content: "‘";
}
[data-link-type="property"]::after,
[data-link-type="propdesc"]::after,
[data-link-type="descriptor"]::after,
[data-link-type="value"]::after,
[data-link-type="function"]::after,
[data-link-type="at-rule"]::after,
[data-link-type="selector"]::after,
[data-link-type="maybe"]::after {
    content: "’";
}

[data-link-type].production::before,
[data-link-type].production::after,
.prod [data-link-type]::before,
.prod [data-link-type]::after {
    content: "";
}

[data-link-type=element],
[data-link-type=element-attr] {
    font-family: Menlo, Consolas, "DejaVu Sans Mono", monospace;
    font-size: .9em;
}
[data-link-type=element]::before { content: "<" }
[data-link-type=element]::after  { content: ">" }

[data-link-type=biblio] {
    white-space: pre;
}
</style>
<style>/* style-colors */

/* Any --*-text not paired with a --*-bg is assumed to have a transparent bg */
:root {
    color-scheme: light dark;

    --text: black;
    --bg: white;

    --unofficial-watermark: url(https://www.w3.org/StyleSheets/TR/2016/logos/UD-watermark);

    --logo-bg: #1a5e9a;
    --logo-active-bg: #c00;
    --logo-text: white;

    --tocnav-normal-text: #707070;
    --tocnav-normal-bg: var(--bg);
    --tocnav-hover-text: var(--tocnav-normal-text);
    --tocnav-hover-bg: #f8f8f8;
    --tocnav-active-text: #c00;
    --tocnav-active-bg: var(--tocnav-normal-bg);

    --tocsidebar-text: var(--text);
    --tocsidebar-bg: #f7f8f9;
    --tocsidebar-shadow: rgba(0,0,0,.1);
    --tocsidebar-heading-text: hsla(203,20%,40%,.7);

    --toclink-text: var(--text);
    --toclink-underline: #3980b5;
    --toclink-visited-text: var(--toclink-text);
    --toclink-visited-underline: #054572;

    --heading-text: #005a9c;

    --hr-text: var(--text);

    --algo-border: #def;

    --del-text: red;
    --del-bg: transparent;
    --ins-text: #080;
    --ins-bg: transparent;

    --a-normal-text: #034575;
    --a-normal-underline: #bbb;
    --a-visited-text: var(--a-normal-text);
    --a-visited-underline: #707070;
    --a-hover-bg: rgba(75%, 75%, 75%, .25);
    --a-active-text: #c00;
    --a-active-underline: #c00;

    --blockquote-border: silver;
    --blockquote-bg: transparent;
    --blockquote-text: currentcolor;

    --issue-border: #e05252;
    --issue-bg: #fbe9e9;
    --issue-text: var(--text);
    --issueheading-text: #831616;

    --example-border: #e0cb52;
    --example-bg: #fcfaee;
    --example-text: var(--text);
    --exampleheading-text: #574b0f;

    --note-border: #52e052;
    --note-bg: #e9fbe9;
    --note-text: var(--text);
    --noteheading-text: hsl(120, 70%, 30%);
    --notesummary-underline: silver;

    --assertion-border: #aaa;
    --assertion-bg: #eee;
    --assertion-text: black;

    --advisement-border: orange;
    --advisement-bg: #fec;
    --advisement-text: var(--text);
    --advisementheading-text: #b35f00;

    --warning-border: red;
    --warning-bg: hsla(40,100%,50%,0.95);
    --warning-text: var(--text);

    --amendment-border: #330099;
    --amendment-bg: #F5F0FF;
    --amendment-text: var(--text);
    --amendmentheading-text: #220066;

    --def-border: #8ccbf2;
    --def-bg: #def;
    --def-text: var(--text);
    --defrow-border: #bbd7e9;

    --datacell-border: silver;

    --indexinfo-text: #707070;

    --indextable-hover-text: black;
    --indextable-hover-bg: #f7f8f9;

    --outdatedspec-bg: rgba(0, 0, 0, .5);
    --outdatedspec-text: black;
    --outdated-bg: maroon;
    --outdated-text: white;
    --outdated-shadow: red;

    --editedrec-bg: darkorange;
}
</style>
<style>/* style-counters */
body {
    counter-reset: example figure issue;
}
.issue {
    counter-increment: issue;
}
.issue:not(.no-marker)::before {
    content: "Issue " counter(issue);
}

.example {
    counter-increment: example;
}
.example:not(.no-marker)::before {
    content: "Example " counter(example);
}
.invalid.example:not(.no-marker)::before,
.illegal.example:not(.no-marker)::before {
    content: "Invalid Example" counter(example);
}

figcaption {
    counter-increment: figure;
}
figcaption:not(.no-marker)::before {
    content: "Figure " counter(figure) " ";
}
</style>
<style>/* style-dfn-panel */
:root {
    --dfnpanel-bg: #ddd;
    --dfnpanel-text: var(--text);
}
.dfn-panel {
    position: absolute;
    z-index: 35;
    width: 20em;
    width: 300px;
    height: auto;
    max-height: 500px;
    overflow: auto;
    padding: 0.5em 0.75em;
    font: small Helvetica Neue, sans-serif, Droid Sans Fallback;
    background: var(--dfnpanel-bg);
    color: var(--dfnpanel-text);
    border: outset 0.2em;
    white-space: normal; /* in case it's moved into a pre */
}
.dfn-panel:not(.on) { display: none; }
.dfn-panel * { margin: 0; padding: 0; text-indent: 0; }
.dfn-panel > b { display: block; }
.dfn-panel a { color: var(--dfnpanel-text); }
.dfn-panel a:not(:hover) { text-decoration: none !important; border-bottom: none !important; }
.dfn-panel > b + b { margin-top: 0.25em; }
.dfn-panel ul { padding: 0 0 0 1em; list-style: none; }
.dfn-panel li a {
    white-space: pre;
    display: inline-block;
    max-width: calc(300px - 1.5em - 1em);
    overflow: hidden;
    text-overflow: ellipsis;
}

.dfn-panel.activated {
    display: inline-block;
    position: fixed;
    left: .5em;
    bottom: 2em;
    margin: 0 auto;
    max-width: calc(100vw - 1.5em - .4em - .5em);
    max-height: 30vh;
}

.dfn-paneled[role="button"] { cursor: pointer; }
</style>
<style>/* style-issues */
a[href].issue-return {
    float: right;
    float: inline-end;
    color: var(--issueheading-text);
    font-weight: bold;
    text-decoration: none;
}
</style>
<style>/* style-md-lists */
/* This is a weird hack for me not yet following the commonmark spec
   regarding paragraph and lists. */
[data-md] > :first-child {
    margin-top: 0;
}
[data-md] > :last-child {
    margin-bottom: 0;
}
</style>
<style>/* style-selflinks */

:root {
    --selflink-text: white;
    --selflink-bg: gray;
    --selflink-hover-text: black;
}
.heading, .issue, .note, .example, li, dt {
    position: relative;
}
a.self-link {
    position: absolute;
    top: 0;
    left: calc(-1 * (3.5rem - 26px));
    width: calc(3.5rem - 26px);
    height: 2em;
    text-align: center;
    border: none;
    transition: opacity .2s;
    opacity: .5;
}
a.self-link:hover {
    opacity: 1;
}
.heading > a.self-link {
    font-size: 83%;
}
.example > a.self-link,
.note > a.self-link,
.issue > a.self-link {
    /* These blocks are overflow:auto, so positioning outside
       doesn't work. */
    left: auto;
    right: 0;
}
li > a.self-link {
    left: calc(-1 * (3.5rem - 26px) - 2em);
}
dfn > a.self-link {
    top: auto;
    left: auto;
    opacity: 0;
    width: 1.5em;
    height: 1.5em;
    background: var(--selflink-bg);
    color: var(--selflink-text);
    font-style: normal;
    transition: opacity .2s, background-color .2s, color .2s;
}
dfn:hover > a.self-link {
    opacity: 1;
}
dfn > a.self-link:hover {
    color: var(--selflink-hover-text);
}

a.self-link::before            { content: "¶"; }
.heading > a.self-link::before { content: "§"; }
dfn > a.self-link::before      { content: "#"; }
</style>
<style>/* style-syntax-highlighting */

            pre.idl.highlight {
                background: var(--borderedblock-bg, var(--def-bg));
            }
            
code.highlight { padding: .1em; border-radius: .3em; }
pre.highlight, pre > code.highlight { display: block; padding: 1em; margin: .5em 0; overflow: auto; border-radius: 0; }

.highlight:not(.idl) { background: rgba(0, 0, 0, .03); }
c-[a] { color: #990055 } /* Keyword.Declaration */
c-[b] { color: #990055 } /* Keyword.Type */
c-[c] { color: #708090 } /* Comment */
c-[d] { color: #708090 } /* Comment.Multiline */
c-[e] { color: #0077aa } /* Name.Attribute */
c-[f] { color: #669900 } /* Name.Tag */
c-[g] { color: #222222 } /* Name.Variable */
c-[k] { color: #990055 } /* Keyword */
c-[l] { color: #000000 } /* Literal */
c-[m] { color: #000000 } /* Literal.Number */
c-[n] { color: #0077aa } /* Name */
c-[o] { color: #999999 } /* Operator */
c-[p] { color: #999999 } /* Punctuation */
c-[s] { color: #a67f59 } /* Literal.String */
c-[t] { color: #a67f59 } /* Literal.String.Single */
c-[u] { color: #a67f59 } /* Literal.String.Double */
c-[cp] { color: #708090 } /* Comment.Preproc */
c-[c1] { color: #708090 } /* Comment.Single */
c-[cs] { color: #708090 } /* Comment.Special */
c-[kc] { color: #990055 } /* Keyword.Constant */
c-[kn] { color: #990055 } /* Keyword.Namespace */
c-[kp] { color: #990055 } /* Keyword.Pseudo */
c-[kr] { color: #990055 } /* Keyword.Reserved */
c-[ld] { color: #000000 } /* Literal.Date */
c-[nc] { color: #0077aa } /* Name.Class */
c-[no] { color: #0077aa } /* Name.Constant */
c-[nd] { color: #0077aa } /* Name.Decorator */
c-[ni] { color: #0077aa } /* Name.Entity */
c-[ne] { color: #0077aa } /* Name.Exception */
c-[nf] { color: #0077aa } /* Name.Function */
c-[nl] { color: #0077aa } /* Name.Label */
c-[nn] { color: #0077aa } /* Name.Namespace */
c-[py] { color: #0077aa } /* Name.Property */
c-[ow] { color: #999999 } /* Operator.Word */
c-[mb] { color: #000000 } /* Literal.Number.Bin */
c-[mf] { color: #000000 } /* Literal.Number.Float */
c-[mh] { color: #000000 } /* Literal.Number.Hex */
c-[mi] { color: #000000 } /* Literal.Number.Integer */
c-[mo] { color: #000000 } /* Literal.Number.Oct */
c-[sb] { color: #a67f59 } /* Literal.String.Backtick */
c-[sc] { color: #a67f59 } /* Literal.String.Char */
c-[sd] { color: #a67f59 } /* Literal.String.Doc */
c-[se] { color: #a67f59 } /* Literal.String.Escape */
c-[sh] { color: #a67f59 } /* Literal.String.Heredoc */
c-[si] { color: #a67f59 } /* Literal.String.Interpol */
c-[sx] { color: #a67f59 } /* Literal.String.Other */
c-[sr] { color: #a67f59 } /* Literal.String.Regex */
c-[ss] { color: #a67f59 } /* Literal.String.Symbol */
c-[vc] { color: #0077aa } /* Name.Variable.Class */
c-[vg] { color: #0077aa } /* Name.Variable.Global */
c-[vi] { color: #0077aa } /* Name.Variable.Instance */
c-[il] { color: #000000 } /* Literal.Number.Integer.Long */
</style>
<style>/* style-darkmode */

@media (prefers-color-scheme: dark) {
    :root {
        --text: #ddd;
        --bg: black;

        --unofficial-watermark: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='400'%3E%3Cg fill='%23100808' transform='translate(200 200) rotate(-45) translate(-200 -200)' stroke='%23100808' stroke-width='3'%3E%3Ctext x='50%25' y='220' style='font: bold 70px sans-serif; text-anchor: middle; letter-spacing: 6px;'%3EUNOFFICIAL%3C/text%3E%3Ctext x='50%25' y='305' style='font: bold 70px sans-serif; text-anchor: middle; letter-spacing: 6px;'%3EDRAFT%3C/text%3E%3C/g%3E%3C/svg%3E");

        --logo-bg: #1a5e9a;
        --logo-active-bg: #c00;
        --logo-text: white;

        --tocnav-normal-text: #999;
        --tocnav-normal-bg: var(--bg);
        --tocnav-hover-text: var(--tocnav-normal-text);
        --tocnav-hover-bg: #080808;
        --tocnav-active-text: #f44;
        --tocnav-active-bg: var(--tocnav-normal-bg);

        --tocsidebar-text: var(--text);
        --tocsidebar-bg: #080808;
        --tocsidebar-shadow: rgba(255,255,255,.1);
        --tocsidebar-heading-text: hsla(203,20%,40%,.7);

        --toclink-text: var(--text);
        --toclink-underline: #6af;
        --toclink-visited-text: var(--toclink-text);
        --toclink-visited-underline: #054572;

        --heading-text: #8af;

        --hr-text: var(--text);

        --algo-border: #456;

        --del-text: #f44;
        --del-bg: transparent;
        --ins-text: #4a4;
        --ins-bg: transparent;

        --a-normal-text: #6af;
        --a-normal-underline: #555;
        --a-visited-text: var(--a-normal-text);
        --a-visited-underline: var(--a-normal-underline);
        --a-hover-bg: rgba(25%, 25%, 25%, .2);
        --a-active-text: #f44;
        --a-active-underline: var(--a-active-text);

        --borderedblock-bg: rgba(255, 255, 255, .05);

        --blockquote-border: silver;
        --blockquote-bg: var(--borderedblock-bg);
        --blockquote-text: currentcolor;

        --issue-border: #e05252;
        --issue-bg: var(--borderedblock-bg);
        --issue-text: var(--text);
        --issueheading-text: hsl(0deg, 70%, 70%);

        --example-border: hsl(50deg, 90%, 60%);
        --example-bg: var(--borderedblock-bg);
        --example-text: var(--text);
        --exampleheading-text: hsl(50deg, 70%, 70%);

        --note-border: hsl(120deg, 100%, 35%);
        --note-bg: var(--borderedblock-bg);
        --note-text: var(--text);
        --noteheading-text: hsl(120, 70%, 70%);
        --notesummary-underline: silver;

        --assertion-border: #444;
        --assertion-bg: var(--borderedblock-bg);
        --assertion-text: var(--text);

        --advisement-border: orange;
        --advisement-bg: #222218;
        --advisement-text: var(--text);
        --advisementheading-text: #f84;

        --warning-border: red;
        --warning-bg: hsla(40,100%,20%,0.95);
        --warning-text: var(--text);

        --amendment-border: #330099;
        --amendment-bg: #080010;
        --amendment-text: var(--text);
        --amendmentheading-text: #cc00ff;

        --def-border: #8ccbf2;
        --def-bg: #080818;
        --def-text: var(--text);
        --defrow-border: #136;

        --datacell-border: silver;

        --indexinfo-text: #aaa;

        --indextable-hover-text: var(--text);
        --indextable-hover-bg: #181818;

        --outdatedspec-bg: rgba(255, 255, 255, .5);
        --outdatedspec-text: black;
        --outdated-bg: maroon;
        --outdated-text: white;
        --outdated-shadow: red;

        --editedrec-bg: darkorange;
    }
    /* In case a transparent-bg image doesn't expect to be on a dark bg,
       which is quite common in practice... */
    img { background: white; }
}

@media (prefers-color-scheme: dark) {
    :root {
        --selflink-text: black;
        --selflink-bg: silver;
        --selflink-hover-text: white;
    }
}

@media (prefers-color-scheme: dark) {
    :root {
        --dfnpanel-bg: #222;
        --dfnpanel-text: var(--text);
    }
}

@media (prefers-color-scheme: dark) {
    .highlight:not(.idl) { background: rgba(255, 255, 255, .05); }

    c-[a] { color: #d33682 } /* Keyword.Declaration */
    c-[b] { color: #d33682 } /* Keyword.Type */
    c-[c] { color: #2aa198 } /* Comment */
    c-[d] { color: #2aa198 } /* Comment.Multiline */
    c-[e] { color: #268bd2 } /* Name.Attribute */
    c-[f] { color: #b58900 } /* Name.Tag */
    c-[g] { color: #cb4b16 } /* Name.Variable */
    c-[k] { color: #d33682 } /* Keyword */
    c-[l] { color: #657b83 } /* Literal */
    c-[m] { color: #657b83 } /* Literal.Number */
    c-[n] { color: #268bd2 } /* Name */
    c-[o] { color: #657b83 } /* Operator */
    c-[p] { color: #657b83 } /* Punctuation */
    c-[s] { color: #6c71c4 } /* Literal.String */
    c-[t] { color: #6c71c4 } /* Literal.String.Single */
    c-[u] { color: #6c71c4 } /* Literal.String.Double */
    c-[ch] { color: #2aa198 } /* Comment.Hashbang */
    c-[cp] { color: #2aa198 } /* Comment.Preproc */
    c-[cpf] { color: #2aa198 } /* Comment.PreprocFile */
    c-[c1] { color: #2aa198 } /* Comment.Single */
    c-[cs] { color: #2aa198 } /* Comment.Special */
    c-[kc] { color: #d33682 } /* Keyword.Constant */
    c-[kn] { color: #d33682 } /* Keyword.Namespace */
    c-[kp] { color: #d33682 } /* Keyword.Pseudo */
    c-[kr] { color: #d33682 } /* Keyword.Reserved */
    c-[ld] { color: #657b83 } /* Literal.Date */
    c-[nc] { color: #268bd2 } /* Name.Class */
    c-[no] { color: #268bd2 } /* Name.Constant */
    c-[nd] { color: #268bd2 } /* Name.Decorator */
    c-[ni] { color: #268bd2 } /* Name.Entity */
    c-[ne] { color: #268bd2 } /* Name.Exception */
    c-[nf] { color: #268bd2 } /* Name.Function */
    c-[nl] { color: #268bd2 } /* Name.Label */
    c-[nn] { color: #268bd2 } /* Name.Namespace */
    c-[py] { color: #268bd2 } /* Name.Property */
    c-[ow] { color: #657b83 } /* Operator.Word */
    c-[mb] { color: #657b83 } /* Literal.Number.Bin */
    c-[mf] { color: #657b83 } /* Literal.Number.Float */
    c-[mh] { color: #657b83 } /* Literal.Number.Hex */
    c-[mi] { color: #657b83 } /* Literal.Number.Integer */
    c-[mo] { color: #657b83 } /* Literal.Number.Oct */
    c-[sa] { color: #6c71c4 } /* Literal.String.Affix */
    c-[sb] { color: #6c71c4 } /* Literal.String.Backtick */
    c-[sc] { color: #6c71c4 } /* Literal.String.Char */
    c-[dl] { color: #6c71c4 } /* Literal.String.Delimiter */
    c-[sd] { color: #6c71c4 } /* Literal.String.Doc */
    c-[se] { color: #6c71c4 } /* Literal.String.Escape */
    c-[sh] { color: #6c71c4 } /* Literal.String.Heredoc */
    c-[si] { color: #6c71c4 } /* Literal.String.Interpol */
    c-[sx] { color: #6c71c4 } /* Literal.String.Other */
    c-[sr] { color: #6c71c4 } /* Literal.String.Regex */
    c-[ss] { color: #6c71c4 } /* Literal.String.Symbol */
    c-[fm] { color: #268bd2 } /* Name.Function.Magic */
    c-[vc] { color: #cb4b16 } /* Name.Variable.Class */
    c-[vg] { color: #cb4b16 } /* Name.Variable.Global */
    c-[vi] { color: #cb4b16 } /* Name.Variable.Instance */
    c-[vm] { color: #cb4b16 } /* Name.Variable.Magic */
    c-[il] { color: #657b83 } /* Literal.Number.Integer.Long */
}
</style>
 <body class="h-entry">
  <div class="head">
   <p data-fill-with="logo"><a class="logo" href="https://www.w3.org/"> <img alt="W3C" height="48" src="https://www.w3.org/StyleSheets/TR/2021/logos/W3C" width="72"> </a> </p>
   <h1 class="p-name no-ref" id="title">Private State Token API</h1>
   <p id="w3c-state"><a href="https://www.w3.org/standards/types#CG-DRAFT">Draft Community Group Report</a>, <time class="dt-updated" datetime="2023-04-20">20 April 2023</time></p>
   <div data-fill-with="spec-metadata">
    <dl>
     <dt>This version:
     <dd><a class="u-url" href="https://wicg.github.io/trust-token-api/">https://wicg.github.io/trust-token-api/</a>
     <dt>Issue Tracking:
     <dd><a href="https://github.com/WICG/trust-token-api/issues/">GitHub</a>
     <dt class="editor">Editors:
     <dd class="editor p-author h-card vcard"><a class="p-name fn u-email email" href="mailto:aykutb@google.com">Aykut Bulut</a> (<a class="p-org org" href="https://www.google.com/">Google</a>)
     <dd class="editor p-author h-card vcard"><a class="p-name fn u-email email" href="mailto:svaldez@google.com">Steven Valdez</a> (<a class="p-org org" href="https://www.google.com/">Google</a>)
     <dt>Participate:
     <dd><a href="https://github.com/WICG/trust-token-api">GitHub WICG/trust-token-api</a> (<a href="https://github.com/WICG/trust-token-api/issues/new">new issue</a>, <a href="https://github.com/WICG/trust-token-api/issues?state=open">open issues</a>)
     <dt>Commits:
     <dd><a href="https://github.com/WICG/trust-token-api/commits/main/spec.bs">GitHub spec.bs commits</a>
    </dl>
   </div>
   <div data-fill-with="warning"></div>
   <p class="copyright" data-fill-with="copyright"><a href="http://www.w3.org/Consortium/Legal/ipr-notice#Copyright">Copyright</a> © 2023 the Contributors to the Private State Token API Specification, published by the <a href="https://www.w3.org/community/wicg/">Web Platform Incubator Community Group</a> under the <a href="https://www.w3.org/community/about/agreements/cla/">W3C Community Contributor License Agreement (CLA)</a>.
A human-readable <a href="http://www.w3.org/community/about/agreements/cla-deed/">summary</a> is available. </p>
   <hr title="Separator for header">
  </div>
  <div class="p-summary" data-fill-with="abstract">
   <h2 class="no-num no-toc no-ref heading settled" id="abstract"><span class="content">Abstract</span></h2>
   <p>The Private State Token API is a web platform API that allows propagating a limited amount of signals across sites, using the Privacy Pass protocol as an underlying primitive.</p>
  </div>
  <div data-fill-with="at-risk"></div>
  <h2 class="no-num no-toc no-ref heading settled" id="status"><span class="content">Status of this document</span></h2>
  <div data-fill-with="status">
   <p> This specification was published by the <a href="https://www.w3.org/community/wicg/">Web Platform Incubator Community Group</a>.
  It is not a W3C Standard nor is it on the W3C Standards Track.

  Please note that under the <a href="https://www.w3.org/community/about/agreements/cla/">W3C Community Contributor License Agreement (CLA)</a> there is a limited opt-out and other conditions apply.

  Learn more about <a href="http://www.w3.org/community/">W3C Community and Business Groups</a>. </p>
   <p></p>
  </div>
  <div data-fill-with="at-risk"></div>
  <nav data-fill-with="table-of-contents" id="toc">
   <h2 class="no-num no-toc no-ref" id="contents">Table of Contents</h2>
   <ol class="toc" role="directory">
    <li><a href="#goals"><span class="secno">1</span> <span class="content">Goals</span></a>
    <li><a href="#background"><span class="secno">2</span> <span class="content">Background</span></a>
    <li>
     <a href="#issuer-public-keys"><span class="secno">3</span> <span class="content">Issuer Public Keys</span></a>
     <ol class="toc">
      <li><a href="#issuer-registration"><span class="secno">3.1</span> <span class="content">Issuer Key Fetching/Registration</span></a>
     </ol>
    <li><a href="#algorithms"><span class="secno">4</span> <span class="content">Algorithms</span></a>
    <li>
     <a href="#fetch-integration"><span class="secno">5</span> <span class="content">Integration with Fetch</span></a>
     <ol class="toc">
      <li><a href="#definitions"><span class="secno">5.1</span> <span class="content">Definitions</span></a>
      <li><a href="#fetch-request"><span class="secno">5.2</span> <span class="content">Modifications to request</span></a>
      <li><a href="#http-network-or-cache-fetch"><span class="secno">5.3</span> <span class="content">Modifications to http-network-or-cache fetch</span></a>
      <li><a href="#http-fetch"><span class="secno">5.4</span> <span class="content">Modifications to HTTP fetch steps</span></a>
     </ol>
    <li>
     <a href="#issuing-protocol"><span class="secno">6</span> <span class="content">Issuing Protocol</span></a>
     <ol class="toc">
      <li><a href="#issue-request"><span class="secno">6.1</span> <span class="content">Creating An Issue Request</span></a>
      <li><a href="#issuer-signing-tokens"><span class="secno">6.2</span> <span class="content">Issuer Signing Tokens</span></a>
      <li><a href="#issue-response"><span class="secno">6.3</span> <span class="content">Handling Issue Responses</span></a>
     </ol>
    <li>
     <a href="#redeeming-tokens"><span class="secno">7</span> <span class="content">Redeeming Tokens</span></a>
     <ol class="toc">
      <li><a href="#redeem-response"><span class="secno">7.1</span> <span class="content">Handling Redeem Responses</span></a>
      <li><a href="#redemption-records"><span class="secno">7.2</span> <span class="content">Redemption Records</span></a>
      <li><a href="#the-document-object"><span class="secno">7.3</span> <span class="content">Changes to <code class="idl"><span>Document</span></code></span></a>
     </ol>
    <li>
     <a href="#query-apis"><span class="secno">8</span> <span class="content">Query APIs</span></a>
     <ol class="toc">
      <li><a href="#token-query"><span class="secno">8.1</span> <span class="content">Token Query</span></a>
      <li><a href="#redemption-record-query"><span class="secno">8.2</span> <span class="content">Redemption Record Query</span></a>
     </ol>
    <li>
     <a href="#pst-http-header-fields"><span class="secno">9</span> <span class="content">Private State Token HTTP Header Fields</span></a>
     <ol class="toc">
      <li><a href="#sec-private-state-token"><span class="secno">9.1</span> <span class="content">The 'Sec-Private-State-Token' Header Field</span></a>
      <li><a href="#sec-private-state-token-lifetime"><span class="secno">9.2</span> <span class="content">The 'Sec-Private-State-Token-Lifetime' Header Field</span></a>
      <li><a href="#sec-private-state-token-crypto-version"><span class="secno">9.3</span> <span class="content">The 'Sec-Private-State-Token-Crypto-Version' Header Field</span></a>
      <li><a href="#sec-redemption-record"><span class="secno">9.4</span> <span class="content">The 'Sec-Redemption-Record' Header Field</span></a>
     </ol>
    <li>
     <a href="#privacy"><span class="secno">10</span> <span class="content">Privacy Considerations</span></a>
     <ol class="toc">
      <li><a href="#unlinkability"><span class="secno">10.1</span> <span class="content">Unlinkability</span></a>
      <li>
       <a href="#limit-encoded-info"><span class="secno">10.2</span> <span class="content">Limiting Encoded Information</span></a>
       <ol class="toc">
        <li><a href="#side-channel-fingerprinting"><span class="secno">10.2.1</span> <span class="content">Potential Attack: Side Channel Fingerprinting</span></a>
       </ol>
      <li>
       <a href="#cross-site-info"><span class="secno">10.3</span> <span class="content">Cross-site Information Transfer</span></a>
       <ol class="toc">
        <li><a href="#api-usage-limits"><span class="secno">10.3.1</span> <span class="content">Mitigation: Dynamic Issuance/Redemption Limits</span></a>
        <li><a href="#per-issuer-limits"><span class="secno">10.3.2</span> <span class="content">Mitigation: Per-Site Issuer Limits</span></a>
       </ol>
     </ol>
    <li>
     <a href="#security"><span class="secno">11</span> <span class="content">Security Considerations</span></a>
     <ol class="toc">
      <li><a href="#token-exhaustion"><span class="secno">11.1</span> <span class="content">Preventing Token Exhaustion</span></a>
      <li><a href="#preventing-double-spend"><span class="secno">11.2</span> <span class="content">Preventing Double Spending</span></a>
     </ol>
    <li>
     <a href="#iana-considerations"><span class="secno">12</span> <span class="content">IANA Considerations</span></a>
     <ol class="toc">
      <li><a href="#iana-sec-private-state-token"><span class="secno">12.1</span> <span class="content">'Sec-Private-State-Token' Header Field</span></a>
      <li><a href="#iana-sec-private-state-token-lifetime"><span class="secno">12.2</span> <span class="content">'Sec-Private-State-Token-Lifetime' Header Field</span></a>
      <li><a href="#iana-sec-private-state-token-crypto-version"><span class="secno">12.3</span> <span class="content">'Sec-Private-State-Token-Crypto-Version' Header Field</span></a>
      <li><a href="#iana-sec-redemption-record"><span class="secno">12.4</span> <span class="content">'Sec-Redemption-Record' Header Field</span></a>
     </ol>
    <li><a href="#acknowledgments"><span class="secno"></span> <span class="content">Acknowledgments</span></a>
    <li>
     <a href="#w3c-conformance"><span class="secno"></span> <span class="content">Conformance</span></a>
     <ol class="toc">
      <li><a href="#w3c-conventions"><span class="secno"></span> <span class="content">Document conventions</span></a>
     </ol>
    <li>
     <a href="#index"><span class="secno"></span> <span class="content">Index</span></a>
     <ol class="toc">
      <li><a href="#index-defined-here"><span class="secno"></span> <span class="content">Terms defined by this specification</span></a>
      <li><a href="#index-defined-elsewhere"><span class="secno"></span> <span class="content">Terms defined by reference</span></a>
     </ol>
    <li>
     <a href="#references"><span class="secno"></span> <span class="content">References</span></a>
     <ol class="toc">
      <li><a href="#normative"><span class="secno"></span> <span class="content">Normative References</span></a>
      <li><a href="#informative"><span class="secno"></span> <span class="content">Informative References</span></a>
     </ol>
    <li><a href="#idl-index"><span class="secno"></span> <span class="content">IDL Index</span></a>
   </ol>
  </nav>
  <main>
   <h2 class="heading settled" data-level="1" id="goals"><span class="secno">1. </span><span class="content">Goals</span><a class="self-link" href="#goals"></a></h2>
   <p>The goal of the Private State Tokens is to transfer a limited amount of signals across
sites through time in a privacy preserving manner. It achieves this using
privacy pass protocol <a data-link-type="biblio" href="#biblio-privacy-pass-issuance-protocol" title="Privacy Pass Issuance Protocol">[PRIVACY-PASS-ISSUANCE-PROTOCOL]</a> specified in the working
documents of the IETF Privacy Pass Working Group <a data-link-type="biblio" href="#biblio-privacy-pass-wg">[PRIVACY-PASS-WG]</a>. Private
State Tokens can be considered to be a web platform implementation of Privacy Pass.</p>
   <p>The spec introduces a new field in request dictionary to support token
operations. It describes how Private State Tokens are utilized through this new
dictionary.</p>
   <h2 class="heading settled" data-level="2" id="background"><span class="secno">2. </span><span class="content">Background</span><a class="self-link" href="#background"></a></h2>
   <p>The Private State Token API provides a mechanism for anonymous authentication. The
API provided by the user agent does not authenticate clients, instead it facilitates
transfer of authentication information.</p>
   <p>Authentication of the clients and token signing are both carried by the same
entity referred to as the <strong>issuer</strong>. This is the joint attester and issuer
architecture described in <a data-link-type="biblio" href="#biblio-privacy-pass-architecture" title="Privacy Pass Architectural Framework">[PRIVACY-PASS-ARCHITECTURE]</a>, <a data-link-type="biblio" href="#biblio-privacy-pass-auth-scheme" title="The Privacy Pass HTTP Authentication Scheme">[PRIVACY-PASS-AUTH-SCHEME]</a>.</p>
   <p>User agents store tokens in persistent storage. Navigated origins might fetch/spend
tokens in first party contexts or include third party code that fetch/spend
tokens. Spending tokens is called <strong>redeeming</strong>.</p>
   <p>Origins may ask the user agent to fetch tokens from the issuers of their
choice. Tokens can be redeemed from a different origin than the fetching one.</p>
   <p>Private State Tokens API performs cross site anonymous authentication without
using linkable state carrying cookies <a data-link-type="biblio" href="#biblio-rfc6265" title="HTTP State Management Mechanism">[RFC6265]</a>. Cookies do provide cross
site authentication, however, they fail to provide anonymity.</p>
   <p>Cookies store large amounts of information. <a data-link-type="biblio" href="#biblio-rfc6265" title="HTTP State Management Mechanism">[RFC6265]</a> requires at least 4096
bytes per cookie and 50 cookies per domain. This means an origin has
50 x 4096 x 2^8 unique identifiers at its disposal. When backed with back end
databases, a server can store arbitrary data for that many unique
users/sessions.</p>
   <p>Compared to a cookie, the amount of data stored in a Private State Token is very
limited. A token stores a value from a set of six values (think of a value of
an enum type of six possible values). Hence a token stores data between 2 and 3
bits (4 &lt; 6 &lt; 8). This is very small compared to 4096 bytes a cookie can store.</p>
   <p>Moreover, Private State Tokens API use cryptographic protocols that prevents
origins from tracking which tokens they issue to which user. When presented with
their tokens, issuers can verify they issued them but cannot link the
tokens to the context of their issuance. Cookies do not have this property.</p>
   <p>Unlike cookies, storing multiple tokens from an issuer does not deteriorate
privacy of the user due to the unlinkability of the tokens. The Private
State Token API allows at most 2 different issuers in a top level origin. This
is to limit the information stored for a user when the issuers are
collaborating.</p>
   <p>Private State Token operations rely on <a data-link-type="biblio" href="#biblio-fetch" title="Fetch Standard">[FETCH]</a>. A fetch request corresponding to a
specific Private State Token operation can be created and used as a parameter to the
fetch function.</p>
   <h2 class="heading settled" data-level="3" id="issuer-public-keys"><span class="secno">3. </span><span class="content">Issuer Public Keys</span><a class="self-link" href="#issuer-public-keys"></a></h2>
   <p>This section describes the public interfaces that an issuer is required to
support to provide public keys to be used by Private State Token protocols.</p>
   <p>An issuer needs to maintain a set of keys and implement the <strong>Issue</strong> and <strong>Redeem</strong> cryptographic functions to sign and validate tokens. Issuers are
required to serve a <strong>key commitment</strong> endpoint. Key commitments are
collections of cryptographic keys and associated metadata necessary for
executing the issuance and redemption operations. Issuers make these available
through secure HTTP <a data-link-type="biblio" href="#biblio-rfc8446" title="The Transport Layer Security (TLS) Protocol Version 1.3">[RFC8446]</a> endpoints. User agents should fetch the key
commitments periodically. A <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="key-commitment">key commitment</dfn> is a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#ordered-map" id="ref-for-ordered-map">map</a> representing
a collection of cryptographic keys and associated metadata necessary for executing
the issuance and redemption operations.</p>
   <p>Requests to key commitment endpoints should result in a JSON response <a data-link-type="biblio" href="#biblio-rfc8259" title="The JavaScript Object Notation (JSON) Data Interchange Format">[RFC8259]</a> of the following format.</p>
<pre class="language-javascript highlight"><c- p>{</c->
  <c- o>&lt;</c->cryptographic protocol_version<c- o>>:</c-> <c- p>{</c->
    <c- u>"protocol_version"</c-><c- o>:</c-> <c- o>&lt;</c->cryptographic protocol version<c- o>></c-><c- p>,</c->
    <c- u>"id"</c-><c- o>:</c-> <c- o>&lt;</c->key commitment identifier<c- o>></c->
    <c- u>"batchsize"</c-><c- o>:</c-> <c- o>&lt;</c->batch size<c- o>></c-><c- p>,</c->
    <c- u>"keys"</c-><c- o>:</c-> <c- p>{</c->
      <c- o>&lt;</c->keyID<c- o>>:</c-> <c- p>{</c-> <c- u>"Y"</c-><c- o>:</c-> <c- o>&lt;</c->base64<c- o>-</c->encoded <c- kr>public</c-> key<c- o>></c-><c- p>,</c->
                 <c- u>"expiry"</c-><c- o>:</c-> <c- o>&lt;</c->key expiration date<c- o>></c-><c- p>},</c->
      <c- o>&lt;</c->keyID<c- o>>:</c-> <c- p>{</c-> <c- u>"Y"</c-><c- o>:</c-> <c- o>&lt;</c->base64<c- o>-</c->encoded <c- kr>public</c-> key<c- o>></c-><c- p>,</c->
                 <c- u>"expiry"</c-><c- o>:</c-> <c- o>&lt;</c->key expiration date<c- p>},</c-> <c- p>...</c->
    <c- p>}</c->
  <c- p>},</c->
  <c- p>...</c->
<c- p>}</c->
</pre>
   <ul>
    <li data-md>
     <p><code>&lt;cryptographic protocol version></code> is a string identifier for the Private State Token
protocol version used. The same string is used as a value of the inner <code>"protocol_version"</code> field. Protocol version string identifier is <code>"PrivateStateTokenV3VOPRF"</code>.</p>
     <ul>
      <li data-md>
       <p>Protocol version <code>“PrivateStateTokenV3VOPRF”</code> implements <a data-link-type="biblio" href="#biblio-voprf" title="Oblivious Pseudorandom Functions (OPRFs) using Prime-Order Groups">[VOPRF]</a> cryptographic
       protocol. Issuers can use up to six valid token signing keys.</p>
     </ul>
    <li data-md>
     <p><code>"id"</code> field provides the identifier of the key commitment. It is a string
     representation of a non-negative integer that is within the range of
     an unsigned 32 bit integer type. Values should be montonically
     increasing.</p>
    <li data-md>
     <p><code>"batchsize"</code> specifies the maximum number of masked tokens that the issuer
            supports for each token issuance operation. Its value is a
            string representation of a positive integer. The user agent might send
            fewer tokens in a single operation, but will generally default to
            sending <code>batchsize</code> many tokens per operation.</p>
    <li data-md>
     <p><code>"keys"</code> field is a dictionary of public keys listed by their identifiers.</p>
     <ul>
      <li data-md>
       <p><code>&lt;keyID></code> is a string representation of a non-negative integer that
   is within the range of an unsigned 32 bit integer type.</p>
      <li data-md>
       <p>Each key has a <code>"Y"</code> field which is a string representation of a
    big-endian base64 encoding <a data-link-type="biblio" href="#biblio-rfc4648">[RFC4648]</a> of the byte string of
    the key.</p>
      <li data-md>
       <p><code>"expiry"</code> field specifies how long the underlying key is valid. It
          is a string representation of a nonnegative integer that
          is within the range of an unsigned 64 bit integer type.
          Underlying key expires if this amount many or more
          microseconds are elapsed since the POSIX epoch <a data-link-type="biblio" href="#biblio-rfc8536" title="The Time Zone Information Format (TZif)">[RFC8536]</a>.</p>
     </ul>
   </ul>
   <p>All field names and their values are strings. When new key commitments are
fetched for an issuer, previous commitments are discarded.</p>
   <h3 class="heading settled" data-level="3.1" id="issuer-registration"><span class="secno">3.1. </span><span class="content">Issuer Key Fetching/Registration</span><a class="self-link" href="#issuer-registration"></a></h3>
   <p>To maintain the privacy of this API and avoid user-specific keys, issuers should present the same keys to all clients that issue and redeem tokens against them.</p>
   <p>To ensure this property, it is recommended that user agents fetch the key commitments in an user-agnostic manner, through some sort of proxied mechanism or centralized mechanism for fetching the keys and distributing them to individual clients.</p>
   <p>If using a centralized mechanism for fetching keys, user agents should have a registration process to allow for issuers to register to have their key commitments fetched and sent to clients at a regular client. The requirements and mechanisms for registering are <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#implementation-defined" id="ref-for-implementation-defined">implementation-defined</a>.</p>
   <p>When using a registration process, it is recommended that user agents apply an expiration date to registration requests, to allow for the removal of deprecated or no longer active issuers.</p>
   <h2 class="heading settled" data-level="4" id="algorithms"><span class="secno">4. </span><span class="content">Algorithms</span><a class="self-link" href="#algorithms"></a></h2>
   <p>A user agent has <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="issuerassociations">issuerAssociations</dfn>, which is a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#ordered-map" id="ref-for-ordered-map①">map</a> where the keys are <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-origin" id="ref-for-concept-origin">origin</a> <var>topLevel</var>, and the values are a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list" id="ref-for-list">list</a> of <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-origin" id="ref-for-concept-origin①">origins</a>.</p>
   <p>To <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="determine-whether-associating-an-issuer-would-exceed-the-top-level-limit">determine whether associating an issuer would exceed the top-level limit</dfn> given an <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-origin" id="ref-for-concept-origin②">origin</a> <var>issuer</var> and an <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-origin" id="ref-for-concept-origin③">origin</a> <var>topLevel</var>, run the following steps:</p>
   <ol>
    <li data-md>
     <p>If <a data-link-type="dfn" href="#issuerassociations" id="ref-for-issuerassociations">issuerAssociations</a>[<var>topLevel</var>] does not <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#map-exists" id="ref-for-map-exists">exist</a>, return false.</p>
    <li data-md>
     <p>If <a data-link-type="dfn" href="#issuerassociations" id="ref-for-issuerassociations①">issuerAssociations</a>[<var>topLevel</var>] <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-contain" id="ref-for-list-contain">contains</a> <var>issuer</var>, return false.</p>
    <li data-md>
     <p>If the <a data-link-type="dfn" href="#issuerassociations" id="ref-for-issuerassociations②">issuerAssociations</a>[<var>topLevel</var>] <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-size" id="ref-for-list-size">size</a> is less than 2, return false.</p>
    <li data-md>
     <p>Return true.</p>
   </ol>
   <p>To <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="associate-the-issuer">associate the issuer</dfn> <var>issuer</var> (an <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-origin" id="ref-for-concept-origin④">origin</a>) with the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-origin" id="ref-for-concept-origin⑤">origin</a> <var>topLevel</var>, run the following steps:</p>
   <ol>
    <li data-md>
     <p>If <a data-link-type="dfn" href="#issuerassociations" id="ref-for-issuerassociations③">issuerAssociations</a>[<var>topLevel</var>] does not <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#map-exists" id="ref-for-map-exists①">exist</a>, <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#map-set" id="ref-for-map-set">set</a> <a data-link-type="dfn" href="#issuerassociations" id="ref-for-issuerassociations④">issuerAssociations</a>[<var>topLevel</var>] to an empty <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list" id="ref-for-list①">list</a>.</p>
    <li data-md>
     <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-append" id="ref-for-list-append">Append</a> <var>issuer</var> to <a data-link-type="dfn" href="#issuerassociations" id="ref-for-issuerassociations⑤">issuerAssociations</a>[<var>topLevel</var>].</p>
   </ol>
   <p>To determine whether an <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-origin" id="ref-for-concept-origin⑥">origin</a> <var>issuer</var> <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="is-associated-with">is associated with</dfn> a given <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-origin" id="ref-for-concept-origin⑦">origin</a> <var>topLevel</var>, run the following steps:</p>
   <ol>
    <li data-md>
     <p>If <a data-link-type="dfn" href="#issuerassociations" id="ref-for-issuerassociations⑥">issuerAssociations</a>[<var>topLevel</var>] does not <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#map-exists" id="ref-for-map-exists②">exist</a>, return false.</p>
    <li data-md>
     <p>If <a data-link-type="dfn" href="#issuerassociations" id="ref-for-issuerassociations⑦">issuerAssociations</a>[<var>topLevel</var>] <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-contain" id="ref-for-list-contain①">contains</a> <var>issuer</var>, return true.</p>
    <li data-md>
     <p>Return false.</p>
   </ol>
   <p>A user agent has <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="redemptiontimes">redemptionTimes</dfn>, a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#ordered-map" id="ref-for-ordered-map②">map</a> where the keys are a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#tuple" id="ref-for-tuple">tuple</a> (<var>issuer</var>, <var>topLevel</var>), and the values are a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#tuple" id="ref-for-tuple①">tuple</a> (<var>lastRedemption</var>, <var>penultimateRedemption</var>).</p>
   <p>To <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="record-redemption-timestamp">record redemption timestamp</dfn> given an <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-origin" id="ref-for-concept-origin⑧">origin</a> <var>issuer</var> and an <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-origin" id="ref-for-concept-origin⑨">origin</a> <var>topLevel</var>, run the following steps:</p>
   <ol>
    <li data-md>
     <p>Let <var>currentTime</var> be the current date and time.</p>
    <li data-md>
     <p>Let <var>previousRedemption</var> be the earliest representable date and time.</p>
    <li data-md>
     <p>If <a data-link-type="dfn" href="#redemptiontimes" id="ref-for-redemptiontimes">redemptionTimes</a>[(<var>issuer</var>,<var>topLevel</var>)] <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#map-exists" id="ref-for-map-exists③">exists</a>, let <var>previousRedemption</var> be the <var>lastRedemption</var> field of the tuple <a data-link-type="dfn" href="#redemptiontimes" id="ref-for-redemptiontimes①">redemptionTimes</a>[(<var>issuer</var>,<var>topLevel</var>)].</p>
    <li data-md>
     <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#map-set" id="ref-for-map-set①">set</a> <a data-link-type="dfn" href="#redemptiontimes" id="ref-for-redemptiontimes②">redemptionTimes</a>[(<var>issuer</var>,<var>topLevel</var>)] to the tuple (<var>currentTime</var>, <var>previousRedemption</var>).</p>
   </ol>
   <p>To <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="look-up-penultimate-redemption">look up penultimate redemption</dfn> given an <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-origin" id="ref-for-concept-origin①⓪">origin</a> <var>issuer</var> and an <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-origin" id="ref-for-concept-origin①①">origin</a> <var>topLevel</var>, run the following steps:</p>
   <ol>
    <li data-md>
     <p>Let <var>penultimateRedemption</var> be the earliest representable date and time.</p>
    <li data-md>
     <p>If <a data-link-type="dfn" href="#redemptiontimes" id="ref-for-redemptiontimes③">redemptionTimes</a>[(<var>issuer</var>,<var>topLevel</var>)] <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#map-exists" id="ref-for-map-exists④">exists</a>, let <var>penultimateRedemption</var> be the <var>penultimateRedemption</var> field of the tuple <a data-link-type="dfn" href="#redemptiontimes" id="ref-for-redemptiontimes④">redemptionTimes</a>[(<var>issuer</var>,<var>topLevel</var>)].</p>
    <li data-md>
     <p>Return <var>penultimateRedemption</var>.</p>
   </ol>
   <p>A user agent has <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="redemptionrecords">redemptionRecords</dfn>, a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#ordered-map" id="ref-for-ordered-map③">map</a> where the keys are a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#tuple" id="ref-for-tuple②">tuple</a> (<var>issuer</var>, <var>topLevel</var>), and the values are a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#tuple" id="ref-for-tuple③">tuple</a> (<var>record</var>, <var>expiration</var>, <var>signingKeys</var>).</p>
   <p>To <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="record-a-redemption-record">record a redemption record</dfn> given an <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-origin" id="ref-for-concept-origin①②">origin</a> <var>issuer</var>, an <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-origin" id="ref-for-concept-origin①③">origin</a> <var>topLevel</var>, a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#byte-sequence" id="ref-for-byte-sequence">byte sequence</a> <var>header</var>, and a <a data-link-type="dfn" href="https://w3c.github.io/hr-time/#dfn-duration" id="ref-for-dfn-duration">duration</a> <var>lifetime</var>, run the following steps:</p>
   <ol>
    <li data-md>
     <p>If <var>lifetime</var> is zero, return.</p>
    <li data-md>
     <p>Let <var>currentTime</var> be the current date and time in milliseconds since 01 January, 1970 UTC.</p>
    <li data-md>
     <p>Let <var>expiration</var> be the sum of <var>currentTime</var> and <var>lifetime</var>.</p>
    <li data-md>
     <p>Let <var>signingKeys</var> be the result of <a data-link-type="dfn" href="#look-up-the-latest-keys" id="ref-for-look-up-the-latest-keys">looking up of the latest keys</a> for <var>issuer</var>.</p>
    <li data-md>
     <p>Set <a data-link-type="dfn" href="#redemptionrecords" id="ref-for-redemptionrecords">redemptionRecords</a>[(<var>issuer</var>, <var>topLevel</var>))] to the tuple (<var>header</var>, <var>expiration</var>, <var>signingKeys</var>).</p>
   </ol>
   <p>To <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="retrieve-a-redemption-record">retrieve a redemption record</dfn> given an <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-origin" id="ref-for-concept-origin①④">origin</a> <var>issuer</var> and an <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-origin" id="ref-for-concept-origin①⑤">origin</a> <var>topLevel</var>, run the following steps:</p>
   <ol>
    <li data-md>
     <p>Let <var>currentTime</var> be the current date and time in milliseconds since 01 January, 1970 UTC.</p>
    <li data-md>
     <p>If <a data-link-type="dfn" href="#redemptiontimes" id="ref-for-redemptiontimes⑤">redemptionTimes</a>[(<var>issuer</var>,<var>topLevel</var>)] <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#map-exists" id="ref-for-map-exists⑤">does not exist</a>, return null.</p>
    <li data-md>
     <p>Let (<var>record</var>, <var>expiration</var>, <var>signingKeys</var>) be <a data-link-type="dfn" href="#redemptiontimes" id="ref-for-redemptiontimes⑥">redemptionTimes</a>[(<var>issuer</var>,<var>topLevel</var>)].</p>
    <li data-md>
     <p>If <var>expiration</var> is less than <var>currentTime</var>, return null.</p>
    <li data-md>
     <p>Let <var>currentSigningKeys</var> be the result of <a data-link-type="dfn" href="#look-up-the-latest-keys" id="ref-for-look-up-the-latest-keys①">looking up of the latest keys</a> for <var>issuer</var>.</p>
    <li data-md>
     <p>If <var>currentSigningKeys</var> does not equal <var>signingKeys</var>, return null.</p>
    <li data-md>
     <p>Return <var>record</var>.</p>
   </ol>
   <p>A user agent has <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="pstkeycommitments">pstKeyCommitments</dfn>, a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#ordered-map" id="ref-for-ordered-map④">map</a> where the keys are an <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-origin" id="ref-for-concept-origin①⑥">origin</a>, and the values are <a data-link-type="dfn" href="#key-commitment" id="ref-for-key-commitment">key commitments</a>.</p>
   <p class="note" role="note"><span class="marker">Note:</span> It is recommended that each user agent fetches the key commitments from issuers at a regular cadence and through trusted infrastructure, and then sends the concatenated map of issuers and key commitments to the client to ensure consistency between the keys different user agent instances use.</p>
   <p>To <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="look-up-the-key-commitments">look up the key commitments</dfn> for a given <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-origin" id="ref-for-concept-origin①⑦">origin</a> <var>issuer</var>, run the following steps:</p>
   <ol>
    <li data-md>
     <p>If <a data-link-type="dfn" href="#pstkeycommitments" id="ref-for-pstkeycommitments">pstKeyCommitments</a>[<var>issuer</var>] does not <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#map-exists" id="ref-for-map-exists⑥">exist</a>, return null.</p>
    <li data-md>
     <p>Let <var>issuerKeys</var> be <a data-link-type="dfn" href="#pstkeycommitments" id="ref-for-pstkeycommitments①">pstKeyCommitments</a>[<var>issuer</var>].</p>
    <li data-md>
     <p>For each <var>cryptoProtocolVersion</var> that the user agent supports for this API in an <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#implementation-defined" id="ref-for-implementation-defined①">implementation-defined</a> order, run the following steps:</p>
     <ol>
      <li data-md>
       <p>Return <var>issuerKeys</var>[<var>cryptoProtocolVersion</var>], if it <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#map-exists" id="ref-for-map-exists⑦">exists</a>.</p>
     </ol>
    <li data-md>
     <p>Return null.</p>
   </ol>
   <p class="note" role="note"><span class="marker">Note:</span> <var>cryptoProtocolVersion</var> is a string identifier representing different cryptographic versions of tokens that can be used with this API. User agents should only select keys for versions they support, ordered by which versions they prefer based on performance and any user defined preferences.</p>
   <p>To <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="look-up-the-latest-keys">look up the latest keys</dfn> for a given <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-origin" id="ref-for-concept-origin①⑧">origin</a> <var>issuer</var>, run the following steps:</p>
   <ol>
    <li data-md>
     <p>Let <var>commitment</var> be the result of <a data-link-type="dfn" href="#look-up-the-key-commitments" id="ref-for-look-up-the-key-commitments">looking up the key commitments</a> for <var>issuer</var>.</p>
    <li data-md>
     <p>If <var>commitment</var> is null, return null.</p>
    <li data-md>
     <p>Let <var>chosenKey</var> be null.</p>
    <li data-md>
     <p>Let <var>currentTime</var> be the current date and time.</p>
    <li data-md>
     <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-iterate" id="ref-for-list-iterate">For each</a> <var>key</var> of <var>commitment</var>["keys"], run the following steps:</p>
     <ol>
      <li data-md>
       <p>If <var>key</var>["expiry"] is less than <var>currentTime</var>, continue.</p>
      <li data-md>
       <p>If <var>chosenKey</var> is null, set <var>chosenKey</var> to <var>key</var>.</p>
      <li data-md>
       <p>If <var>key</var>["expiry"] is less than <var>chosenKey</var>["expiry"], set <var>chosenKey</var> to <var>key</var>.</p>
     </ol>
    <li data-md>
     <p>Return <var>chosenKey</var>.</p>
   </ol>
   <p>A user agent has a <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="tokenstore">tokenStore</dfn>, a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#ordered-map" id="ref-for-ordered-map⑤">map</a> where the keys are <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-origin" id="ref-for-concept-origin①⑨">origins</a> and the values are <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list" id="ref-for-list②">lists</a> of <a data-link-type="dfn" href="#storedtoken" id="ref-for-storedtoken">storedTokens</a>. A <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="storedtoken">storedToken</dfn> is a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#tuple" id="ref-for-tuple④">tuple</a> of (<a data-link-type="dfn" href="https://infra.spec.whatwg.org/#byte-sequence" id="ref-for-byte-sequence①">byte sequence</a>, <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#byte-sequence" id="ref-for-byte-sequence②">byte sequence</a>).</p>
   <p>To <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="insert-a-token">insert a token</dfn> for an <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-origin" id="ref-for-concept-origin②⓪">origin</a> <var>issuer</var>, <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#byte-sequence" id="ref-for-byte-sequence③">byte sequence</a> <var>token</var>, and <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#byte-sequence" id="ref-for-byte-sequence④">byte sequence</a> <var>signingKey</var>, run the following steps:</p>
   <ol>
    <li data-md>
     <p>Create a new <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#tuple" id="ref-for-tuple⑤">tuple</a> <var>storedToken</var> consisting of (<var>token</var>, <var>signingKey</var>).</p>
    <li data-md>
     <p>If <a data-link-type="dfn" href="#tokenstore" id="ref-for-tokenstore">tokenStore</a>[<var>issuer</var>] does not <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#map-exists" id="ref-for-map-exists⑧">exist</a>, set <a data-link-type="dfn" href="#tokenstore" id="ref-for-tokenstore①">tokenStore</a>[<var>issuer</var>] to an empty <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list" id="ref-for-list③">list</a>.</p>
    <li data-md>
     <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-append" id="ref-for-list-append①">Append</a> <var>storedToken</var> to <a data-link-type="dfn" href="#tokenstore" id="ref-for-tokenstore②">tokenStore</a>[<var>issuer</var>].</p>
   </ol>
   <p>To <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="retrieve-a-token">retrieve a token</dfn> for an <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-origin" id="ref-for-concept-origin②①">origin</a> <var>issuer</var>, run the following steps:</p>
   <ol>
    <li data-md>
     <p>If <a data-link-type="dfn" href="#tokenstore" id="ref-for-tokenstore③">tokenStore</a>[<var>issuer</var>] does not <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#map-exists" id="ref-for-map-exists⑨">exist</a>, return null.</p>
    <li data-md>
     <p>If the <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-size" id="ref-for-list-size①">size</a> of <a data-link-type="dfn" href="#tokenstore" id="ref-for-tokenstore④">tokenStore</a>[<var>issuer</var>] is zero, return null.</p>
    <li data-md>
     <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-remove" id="ref-for-list-remove">Remove</a> a random element of <a data-link-type="dfn" href="#tokenstore" id="ref-for-tokenstore⑤">tokenStore</a>[<var>issuer</var>] and return the removed element.</p>
   </ol>
   <p>To <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="discard-tokens">discard tokens</dfn> from an <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-origin" id="ref-for-concept-origin②②">origin</a> <var>issuer</var> and <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#byte-sequence" id="ref-for-byte-sequence⑤">byte sequence</a> <var>signingKey</var>, run the following steps:</p>
   <ol>
    <li data-md>
     <p>If <a data-link-type="dfn" href="#tokenstore" id="ref-for-tokenstore⑥">tokenStore</a>[<var>issuer</var>] does not <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#map-exists" id="ref-for-map-exists①⓪">exist</a>, return.</p>
    <li data-md>
     <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-remove" id="ref-for-list-remove①">Remove</a> all elements of <a data-link-type="dfn" href="#tokenstore" id="ref-for-tokenstore⑦">tokenStore</a>[<var>issuer</var>] whose second element is not equal to <var>signingKey</var>.</p>
   </ol>
   <p>To get the <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="number-of-tokens">number of tokens</dfn> from an <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-origin" id="ref-for-concept-origin②③">origin</a> <var>issuer</var>, run the following steps:</p>
   <ol>
    <li data-md>
     <p>If <a data-link-type="dfn" href="#tokenstore" id="ref-for-tokenstore⑧">tokenStore</a>[<var>issuer</var>] does not <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#map-exists" id="ref-for-map-exists①①">exist</a>, return 0.</p>
    <li data-md>
     <p>Return the <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-size" id="ref-for-list-size②">size</a> of <a data-link-type="dfn" href="#tokenstore" id="ref-for-tokenstore⑨">tokenStore</a>[<var>issuer</var>].</p>
   </ol>
   <p>To get the <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="max-batch-size">max batch size</dfn> for an <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-origin" id="ref-for-concept-origin②④">origin</a> <var>issuer</var>, run the following steps:</p>
   <ol>
    <li data-md>
     <p>Let <var>issuerKey</var> be the result of running <a data-link-type="dfn" href="#look-up-the-key-commitments" id="ref-for-look-up-the-key-commitments①">look up the key commitments</a> on <var>issuer</var>.</p>
    <li data-md>
     <p>If <var>issuerKey</var> is null, return 0.</p>
    <li data-md>
     <p>Return <var>issuerKey</var>["batchsize"].</p>
   </ol>
   <p>To <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="generate-masked-tokens">generate masked tokens</dfn> given <a data-link-type="dfn" href="#key-commitment" id="ref-for-key-commitment①">key commitments</a> <var>issuerKeys</var> and number <var>numTokens</var>, run the following steps:</p>
   <ol>
    <li data-md>
     <p>Let <var>maskOperation</var> be the Mask operation corresponding to <var>issuerKeys</var>["protocol_version"].</p>
    <li data-md>
     <p>Let <var>result</var> (<a data-link-type="dfn" href="https://infra.spec.whatwg.org/#tuple" id="ref-for-tuple⑥">tuple</a> (<a data-link-type="dfn" href="https://infra.spec.whatwg.org/#byte-sequence" id="ref-for-byte-sequence⑥">byte sequence</a>, <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#byte-sequence" id="ref-for-byte-sequence⑦">byte sequence</a>)) be the result of running <var>maskOperation</var> on <var>issuerKeys</var> and <var>numTokens</var>.</p>
    <li data-md>
     <p>If <var>result</var> is null, return an error.</p>
    <li data-md>
     <p>Return <var>result</var>.</p>
   </ol>
   <p>To <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="unmask-tokens">unmask tokens</dfn> given <a data-link-type="dfn" href="#key-commitment" id="ref-for-key-commitment②">key commitments</a> <var>issuerKeys</var>, byte string <var>pretokens</var>, and a bytestring <var>response</var>, run the following steps:</p>
   <ol>
    <li data-md>
     <p>Let <var>unmaskOperation</var> be the Unmask operation corresponding to <var>issuerKeys</var>["protocol_version"].</p>
    <li data-md>
     <p>Let <var>result</var> (<a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list" id="ref-for-list④">list</a> of byte strings) be the result of running <var>unmaskOperation</var> on <var>pretokens</var> and <var>response</var>.</p>
    <li data-md>
     <p>Return <var>result</var>.</p>
   </ol>
   <h2 class="heading settled" data-level="5" id="fetch-integration"><span class="secno">5. </span><span class="content">Integration with Fetch</span><a class="self-link" href="#fetch-integration"></a></h2>
   <h3 class="heading settled" data-level="5.1" id="definitions"><span class="secno">5.1. </span><span class="content">Definitions</span><a class="self-link" href="#definitions"></a></h3>
   <p>The <code class="idl"><a data-link-type="idl" href="#enumdef-refreshpolicy" id="ref-for-enumdef-refreshpolicy">RefreshPolicy</a></code> is attached to a redemption request, determining whether or not the
redemption should result in a previously returned, unexpired <a data-link-type="dfn" href="#redemption-record" id="ref-for-redemption-record">redemption record</a> or a
new one.</p>
<pre class="idl highlight def"><c- b>enum</c-> <dfn class="dfn-paneled idl-code" data-dfn-type="enum" data-export id="enumdef-refreshpolicy"><code><c- g>RefreshPolicy</c-></code></dfn> { <dfn class="idl-code" data-dfn-for="RefreshPolicy" data-dfn-type="enum-value" data-export id="dom-refreshpolicy-none"><code><c- s>"none"</c-></code><a class="self-link" href="#dom-refreshpolicy-none"></a></dfn>, <dfn class="idl-code" data-dfn-for="RefreshPolicy" data-dfn-type="enum-value" data-export id="dom-refreshpolicy-refresh"><code><c- s>"refresh"</c-></code><a class="self-link" href="#dom-refreshpolicy-refresh"></a></dfn> };
</pre>
   <p>The <code class="idl"><a data-link-type="idl" href="#enumdef-tokentype" id="ref-for-enumdef-tokentype">TokenType</a></code> is currently set to <code>"private-state-token"</code>, as this is the only token
type that the specification supports at this time.</p>
<pre class="idl highlight def"><c- b>enum</c-> <dfn class="dfn-paneled idl-code" data-dfn-type="enum" data-export id="enumdef-tokentype"><code><c- g>TokenType</c-></code></dfn> { <dfn class="idl-code" data-dfn-for="TokenType" data-dfn-type="enum-value" data-export id="dom-tokentype-private-state-token"><code><c- s>"private-state-token"</c-></code><a class="self-link" href="#dom-tokentype-private-state-token"></a></dfn> };
</pre>
   <p>The <code class="idl"><a data-link-type="idl" href="#enumdef-tokenversion" id="ref-for-enumdef-tokenversion">TokenVersion</a></code> is currently set to <code>1</code>, as this is the only <code>"private-state-token"</code> version that the specification supports at this time.</p>
<pre class="idl highlight def"><c- b>enum</c-> <dfn class="dfn-paneled idl-code" data-dfn-type="enum" data-export id="enumdef-tokenversion"><code><c- g>TokenVersion</c-></code></dfn> { <dfn class="idl-code" data-dfn-for="TokenVersion" data-dfn-type="enum-value" data-export id="dom-tokenversion-1"><code><c- s>"1"</c-></code><a class="self-link" href="#dom-tokenversion-1"></a></dfn> };
</pre>
   <p>The <code class="idl"><a data-link-type="idl" href="#enumdef-operationtype" id="ref-for-enumdef-operationtype">OperationType</a></code> refers to which operation the user agent is attempting to complete.</p>
<pre class="idl highlight def"><c- b>enum</c-> <dfn class="dfn-paneled idl-code" data-dfn-type="enum" data-export id="enumdef-operationtype"><code><c- g>OperationType</c-></code></dfn> { <dfn class="idl-code" data-dfn-for="OperationType" data-dfn-type="enum-value" data-export id="dom-operationtype-token-request"><code><c- s>"token-request"</c-></code><a class="self-link" href="#dom-operationtype-token-request"></a></dfn>, <dfn class="idl-code" data-dfn-for="OperationType" data-dfn-type="enum-value" data-export id="dom-operationtype-send-redemption-record"><code><c- s>"send-redemption-record"</c-></code><a class="self-link" href="#dom-operationtype-send-redemption-record"></a></dfn>, <dfn class="idl-code" data-dfn-for="OperationType" data-dfn-type="enum-value" data-export id="dom-operationtype-token-redemption"><code><c- s>"token-redemption"</c-></code><a class="self-link" href="#dom-operationtype-token-redemption"></a></dfn> };
</pre>
   <p>The <code class="idl"><a data-link-type="idl" href="#dictdef-privatetoken" id="ref-for-dictdef-privatetoken">PrivateToken</a></code> contains the information required to make a fetch request.</p>
<pre class="idl highlight def"><c- b>dictionary</c-> <dfn class="dfn-paneled idl-code" data-dfn-type="dictionary" data-export id="dictdef-privatetoken"><code><c- g>PrivateToken</c-></code></dfn> {
  <c- b>required</c-> <a data-link-type="idl-name" href="#enumdef-tokentype" id="ref-for-enumdef-tokentype①"><c- n>TokenType</c-></a> <dfn class="idl-code" data-dfn-for="PrivateToken" data-dfn-type="dict-member" data-export data-type="TokenType " id="dom-privatetoken-type"><code><c- g>type</c-></code><a class="self-link" href="#dom-privatetoken-type"></a></dfn>;
  <c- b>required</c-> <a data-link-type="idl-name" href="#enumdef-tokenversion" id="ref-for-enumdef-tokenversion①"><c- n>TokenVersion</c-></a> <dfn class="idl-code" data-dfn-for="PrivateToken" data-dfn-type="dict-member" data-export data-type="TokenVersion " id="dom-privatetoken-version"><code><c- g>version</c-></code><a class="self-link" href="#dom-privatetoken-version"></a></dfn>;
  <c- b>required</c-> <a data-link-type="idl-name" href="#enumdef-operationtype" id="ref-for-enumdef-operationtype①"><c- n>OperationType</c-></a> <dfn class="dfn-paneled idl-code" data-dfn-for="PrivateToken" data-dfn-type="dict-member" data-export data-type="OperationType " id="dom-privatetoken-operation"><code><c- g>operation</c-></code></dfn>;
  <a data-link-type="idl-name" href="#enumdef-refreshpolicy" id="ref-for-enumdef-refreshpolicy①"><c- n>RefreshPolicy</c-></a> <dfn class="dfn-paneled idl-code" data-default="&quot;none&quot;" data-dfn-for="PrivateToken" data-dfn-type="dict-member" data-export data-type="RefreshPolicy " id="dom-privatetoken-refreshpolicy"><code><c- g>refreshPolicy</c-></code></dfn> = "none";
  <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#idl-sequence" id="ref-for-idl-sequence"><c- b>sequence</c-></a>&lt;<a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-USVString" id="ref-for-idl-USVString"><c- b>USVString</c-></a>> <dfn class="dfn-paneled idl-code" data-dfn-for="PrivateToken" data-dfn-type="dict-member" data-export data-type="sequence<USVString> " id="dom-privatetoken-issuers"><code><c- g>issuers</c-></code></dfn>;
};
</pre>
   <p>This specification adds a new property to the <code class="idl"><a data-link-type="idl" href="https://fetch.spec.whatwg.org/#requestinit" id="ref-for-requestinit">RequestInit</a></code> dictionary:</p>
<pre class="idl highlight def"><c- b>partial</c-> <c- b>dictionary</c-> <a class="idl-code" data-link-type="dictionary" href="https://fetch.spec.whatwg.org/#requestinit" id="ref-for-requestinit①"><c- g>RequestInit</c-></a> {
  <a data-link-type="idl-name" href="#dictdef-privatetoken" id="ref-for-dictdef-privatetoken①"><c- n>PrivateToken</c-></a> <dfn class="dfn-paneled idl-code" data-dfn-for="RequestInit" data-dfn-type="dict-member" data-export data-type="PrivateToken " id="dom-requestinit-privatetoken"><code><c- g>privateToken</c-></code></dfn>;
};
</pre>
   <h3 class="heading settled" data-level="5.2" id="fetch-request"><span class="secno">5.2. </span><span class="content">Modifications to request</span><a class="self-link" href="#fetch-request"></a></h3>
   <p>A <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request" id="ref-for-concept-request">request</a> has an associated <dfn class="dfn-paneled" data-dfn-for="request" data-dfn-type="dfn" data-noexport id="request-private-token-refresh-policy">private token refresh policy</dfn>, which is of type <code class="idl"><a data-link-type="idl" href="#enumdef-refreshpolicy" id="ref-for-enumdef-refreshpolicy②">RefreshPolicy</a></code> with default value of <code>"none"</code>.</p>
   <p>A <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request" id="ref-for-concept-request①">request</a> has an associated <dfn class="dfn-paneled" data-dfn-for="request" data-dfn-type="dfn" data-noexport id="request-private-token-operation">private token operation</dfn>, which is of type <code class="idl"><a data-link-type="idl" href="#enumdef-operationtype" id="ref-for-enumdef-operationtype②">OperationType</a></code>.</p>
   <p>A <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request" id="ref-for-concept-request②">request</a> has an associated <dfn class="dfn-paneled" data-dfn-for="request" data-dfn-type="dfn" data-noexport id="request-private-token-issuers">private token issuers</dfn>, which is a list of strings.</p>
   <p class="note" role="note"><span class="marker">Note:</span> <a data-link-type="dfn" href="#request-private-token-refresh-policy" id="ref-for-request-private-token-refresh-policy">Private token refresh policy</a> is ignored unless <a data-link-type="dfn" href="#request-private-token-operation" id="ref-for-request-private-token-operation">private token operation</a> is <code>"token-redemption"</code>. <a data-link-type="dfn" href="#request-private-token-issuers" id="ref-for-request-private-token-issuers">Private token issuers</a> is ignored unless <a data-link-type="dfn" href="#request-private-token-operation" id="ref-for-request-private-token-operation①">private token operation</a> is <code>"send-redemption-record"</code>. <a data-link-type="dfn" href="#request-private-token-issuers" id="ref-for-request-private-token-issuers①">Private token issuers</a> must be specified and non-empty when <a data-link-type="dfn" href="#request-private-token-operation" id="ref-for-request-private-token-operation②">private token operation</a> is <code>"send-redemption-record"</code>.</p>
   <p>A <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request" id="ref-for-concept-request③">request</a> has an associated <dfn class="dfn-paneled" data-dfn-for="request" data-dfn-type="dfn" data-noexport id="request-pstpretokens">pstPretokens</dfn>, which is null or a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#byte-sequence" id="ref-for-byte-sequence⑧">byte sequence</a>.</p>
   <p>Add the following steps to the <code><a class="idl-code" data-link-type="constructor" href="https://fetch.spec.whatwg.org/#dom-request" id="ref-for-dom-request">new Request (<var>input</var>, <var>init</var>)</a></code> constructor, before step 28 ("<code>Set <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#this" id="ref-for-this">this</a>'s <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-request" id="ref-for-concept-request-request">request</a> to <var>request</var></code>"):</p>
   <ol>
    <li data-md>
     <p>If <var>init</var>["<code class="idl"><a data-link-type="idl" href="#dom-requestinit-privatetoken" id="ref-for-dom-requestinit-privatetoken">privateToken</a></code>"] <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#map-exists" id="ref-for-map-exists①②">exists</a>:</p>
     <ol>
      <li data-md>
       <p>Set <var>request</var>’s <a data-link-type="dfn" href="#request-private-token-operation" id="ref-for-request-private-token-operation③">private token operation</a> to <var>init</var>["<code class="idl"><a data-link-type="idl" href="#dom-requestinit-privatetoken" id="ref-for-dom-requestinit-privatetoken①">privateToken</a></code>"]["<code class="idl"><a data-link-type="idl" href="#dom-privatetoken-operation" id="ref-for-dom-privatetoken-operation">operation</a></code>"].</p>
      <li data-md>
       <p>If <var>init</var>["<code class="idl"><a data-link-type="idl" href="#dom-requestinit-privatetoken" id="ref-for-dom-requestinit-privatetoken②">privateToken</a></code>"]["<code class="idl"><a data-link-type="idl" href="#dom-privatetoken-operation" id="ref-for-dom-privatetoken-operation①">operation</a></code>"] is <code>"token-request"</code>, then abort these steps.</p>
      <li data-md>
       <p>If <var>init</var>["<code class="idl"><a data-link-type="idl" href="#dom-requestinit-privatetoken" id="ref-for-dom-requestinit-privatetoken③">privateToken</a></code>"]["<code class="idl"><a data-link-type="idl" href="#dom-privatetoken-operation" id="ref-for-dom-privatetoken-operation②">operation</a></code>"] is <code>"token-redemption"</code>:</p>
       <ol>
        <li data-md>
         <p>Set <var>request</var>’s <a data-link-type="dfn" href="#request-private-token-refresh-policy" id="ref-for-request-private-token-refresh-policy①">private token refresh policy</a> to <var>init</var>["<code class="idl"><a data-link-type="idl" href="#dom-requestinit-privatetoken" id="ref-for-dom-requestinit-privatetoken④">privateToken</a></code>"]["<code class="idl"><a data-link-type="idl" href="#dom-privatetoken-refreshpolicy" id="ref-for-dom-privatetoken-refreshpolicy">refreshPolicy</a></code>"].</p>
        <li data-md>
         <p>Abort the remaining steps.</p>
       </ol>
      <li data-md>
       <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#assert" id="ref-for-assert">Assert</a>: <var>init</var>["<code class="idl"><a data-link-type="idl" href="#dom-requestinit-privatetoken" id="ref-for-dom-requestinit-privatetoken⑤">privateToken</a></code>"]["<code class="idl"><a data-link-type="idl" href="#dom-privatetoken-operation" id="ref-for-dom-privatetoken-operation③">operation</a></code>"] is <code>"send-redemption-record"</code>.</p>
      <li data-md>
       <p>If <var>init</var>["<code class="idl"><a data-link-type="idl" href="#dom-requestinit-privatetoken" id="ref-for-dom-requestinit-privatetoken⑥">privateToken</a></code>"]["<code class="idl"><a data-link-type="idl" href="#dom-privatetoken-issuers" id="ref-for-dom-privatetoken-issuers">issuers</a></code>"] does not <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#map-exists" id="ref-for-map-exists①③">exist</a>, then throw <code class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#exceptiondef-typeerror" id="ref-for-exceptiondef-typeerror">TypeError</a></code>.</p>
      <li data-md>
       <p>If <var>init</var>["<code class="idl"><a data-link-type="idl" href="#dom-requestinit-privatetoken" id="ref-for-dom-requestinit-privatetoken⑦">privateToken</a></code>"]["<code class="idl"><a data-link-type="idl" href="#dom-privatetoken-issuers" id="ref-for-dom-privatetoken-issuers①">issuers</a></code>"] is <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-empty" id="ref-for-list-empty">empty</a>, then throw <code class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#exceptiondef-typeerror" id="ref-for-exceptiondef-typeerror①">TypeError</a></code>.</p>
      <li data-md>
       <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-iterate" id="ref-for-list-iterate①">For each</a> <var>issuer</var> of <var>init</var>["<code class="idl"><a data-link-type="idl" href="#dom-requestinit-privatetoken" id="ref-for-dom-requestinit-privatetoken⑧">privateToken</a></code>"]["<code class="idl"><a data-link-type="idl" href="#dom-privatetoken-issuers" id="ref-for-dom-privatetoken-issuers②">issuers</a></code>"]:</p>
       <ol>
        <li data-md>
         <p>Let <var>issuerURL</var> be the the result of running the <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-url-parser" id="ref-for-concept-url-parser">URL parser</a> on <var>issuer</var>.</p>
        <li data-md>
         <p>If <var>issuerURL</var> is failure, then throw <code class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#exceptiondef-typeerror" id="ref-for-exceptiondef-typeerror②">TypeError</a></code>.</p>
        <li data-md>
         <p>If <var>issuerURL</var>’s <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-url-scheme" id="ref-for-concept-url-scheme">scheme</a> is not an <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#http-scheme" id="ref-for-http-scheme">HTTP(S) scheme</a>, then throw <code class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#exceptiondef-typeerror" id="ref-for-exceptiondef-typeerror③">TypeError</a></code>.</p>
        <li data-md>
         <p>Let <var>issuerOrigin</var> be <var>issuerURL</var>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-origin" id="ref-for-concept-origin②⑤">origin</a>.</p>
        <li data-md>
         <p>If <var>issuerOrigin</var> is not a <a data-link-type="dfn" href="https://w3c.github.io/webappsec-secure-contexts/#potentially-trustworthy-origin" id="ref-for-potentially-trustworthy-origin">potentially trustworthy origin</a>, then throw <code class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#exceptiondef-typeerror" id="ref-for-exceptiondef-typeerror④">TypeError</a></code>.</p>
        <li data-md>
         <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-append" id="ref-for-list-append②">Append</a> <var>issuerURL</var> to <var>request</var>’s <a data-link-type="dfn" href="#request-private-token-issuers" id="ref-for-request-private-token-issuers②">private token issuers</a>.</p>
       </ol>
     </ol>
   </ol>
   <h3 class="heading settled" data-level="5.3" id="http-network-or-cache-fetch"><span class="secno">5.3. </span><span class="content">Modifications to http-network-or-cache fetch</span><a class="self-link" href="#http-network-or-cache-fetch"></a></h3>
   <p>This specification adds the following steps to the <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-http-network-or-cache-fetch" id="ref-for-concept-http-network-or-cache-fetch">http-network-or-cache fetch</a> algorithm, before modifying the header list:</p>
   <ol>
    <li data-md>
     <p>If <var>request</var>’s <a data-link-type="dfn" href="#request-private-token-operation" id="ref-for-request-private-token-operation④">private token operation</a> is null, abort remaining steps.</p>
    <li data-md>
     <p>If <var>request</var>’s <a data-link-type="dfn" href="#request-private-token-operation" id="ref-for-request-private-token-operation⑤">private token operation</a> is <code>"token-request"</code>:</p>
     <ol>
      <li data-md>
       <p><a data-link-type="dfn" href="#append-private-state-token-issue-request-headers" id="ref-for-append-private-state-token-issue-request-headers">Append private state token issue request headers</a> on <var>httpRequest</var>.</p>
      <li data-md>
       <p>Abort the remaining steps.</p>
     </ol>
    <li data-md>
     <p>If <var>request</var>’s <a data-link-type="dfn" href="#request-private-token-operation" id="ref-for-request-private-token-operation⑥">private token operation</a> is <code>"token-redemption"</code>:</p>
     <ol>
      <li data-md>
       <p><a data-link-type="dfn" href="#append-private-state-token-redemption-request-headers" id="ref-for-append-private-state-token-redemption-request-headers">Append private state token redemption request headers</a> on <var>httpRequest</var>.</p>
      <li data-md>
       <p>Abort the remaining steps.</p>
     </ol>
    <li data-md>
     <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#assert" id="ref-for-assert①">Assert</a>: <var>request</var>’s <a data-link-type="dfn" href="#request-private-token-operation" id="ref-for-request-private-token-operation⑦">private token operation</a> is <code>"send-redemption-record"</code>.</p>
    <li data-md>
     <p><a data-link-type="dfn" href="#append-private-state-token-redemption-record-headers" id="ref-for-append-private-state-token-redemption-record-headers">Append private state token redemption record headers</a> on <var>httpRequest</var>.</p>
   </ol>
   <h3 class="heading settled" data-level="5.4" id="http-fetch"><span class="secno">5.4. </span><span class="content">Modifications to HTTP fetch steps</span><a class="self-link" href="#http-fetch"></a></h3>
   <p>The specification adds the following steps to the <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-http-fetch" id="ref-for-concept-http-fetch">HTTP fetch</a> algorithm, before checking the redirect status (i.e. "7. If <var>actualResponse</var>’s status is a redirect status, ..."):</p>
   <ol>
    <li data-md>
     <p>Let <var>issue response result</var> be the result of <a data-link-type="dfn" href="#handle-an-issue-response" id="ref-for-handle-an-issue-response">handling an issue response</a>, given <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request" id="ref-for-concept-request④">request</a> <var>request</var> and <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-response" id="ref-for-concept-response">response</a> <var>actualResponse</var> as input.</p>
    <li data-md>
     <p>If <var>issue response result</var> is a <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-network-error" id="ref-for-concept-network-error">network error</a>, return <var>issue response result</var>.</p>
    <li data-md>
     <p>Let <var>redeem response result</var> be the result of <a data-link-type="dfn" href="#handle-a-redeem-response" id="ref-for-handle-a-redeem-response">handling a redeem response</a>, given <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request" id="ref-for-concept-request⑤">request</a> <var>request</var> and <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-response" id="ref-for-concept-response①">response</a> <var>actualResponse</var> as input.</p>
    <li data-md>
     <p>If <var>redeem response result</var> is a <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-network-error" id="ref-for-concept-network-error①">network error</a>, return <var>issue response result</var>.</p>
   </ol>
   <h2 class="heading settled" data-level="6" id="issuing-protocol"><span class="secno">6. </span><span class="content">Issuing Protocol</span><a class="self-link" href="#issuing-protocol"></a></h2>
   <p>This section explains the issuing protocol. It has two sections that explains
the issuing protocol steps for user agents and issuers.</p>
   <h3 class="heading settled" data-level="6.1" id="issue-request"><span class="secno">6.1. </span><span class="content">Creating An Issue Request</span><a class="self-link" href="#issue-request"></a></h3>
   <div class="example" id="example-issue-request">
    <a class="self-link" href="#example-issue-request"></a> An issue request is created and fetched as demonstrated in the following snippet. 
<pre class="language-javascript highlight"><c- a>let</c-> issueRequest <c- o>=</c-> <c- ow>new</c-> Request<c- p>(</c-><c- u>"https://example.issuer:1234/issuer_path"</c-><c- p>,</c-> <c- p>{</c->
  privateToken<c- o>:</c-> <c- p>{</c->
    type<c- o>:</c-> <c- u>"private-state-token"</c-><c- p>,</c->
    version<c- o>:</c-> <c- mf>1</c-><c- p>,</c->
    operation<c- o>:</c-> <c- u>"token-request"</c-><c- p>,</c->
  <c- p>}</c->
<c- p>});</c->
fetch<c- p>(</c->issueRequest<c- p>);</c->
</pre>
   </div>
   <p>To <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="append-private-state-token-issue-request-headers">append private state token issue request headers</dfn> given a <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request" id="ref-for-concept-request⑥">request</a> <var>request</var>, run the following steps:</p>
   <ol>
    <li data-md>
     <p>If <var>request</var>’s <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-client" id="ref-for-concept-request-client">client</a> is not a <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#secure-context" id="ref-for-secure-context">secure context</a>, return.</p>
    <li data-md>
     <p>Let <var>issuer</var> be <var>request</var>’s <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-url" id="ref-for-concept-request-url">URL</a>'s <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-url-origin" id="ref-for-concept-url-origin">origin</a>.</p>
    <li data-md>
     <p>Let <var>topLevel</var> be <var>request</var>’s <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-client" id="ref-for-concept-request-client①">client</a>'s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-top-level-origin" id="ref-for-concept-environment-top-level-origin">top-level origin</a>.</p>
    <li data-md>
     <p>If associating <var>issuer</var> with <var>topLevel</var> <a data-link-type="dfn" href="#determine-whether-associating-an-issuer-would-exceed-the-top-level-limit" id="ref-for-determine-whether-associating-an-issuer-would-exceed-the-top-level-limit">would exceed the top level’s number-of-issuers limit</a>, return.</p>
    <li data-md>
     <p><a data-link-type="dfn" href="#associate-the-issuer" id="ref-for-associate-the-issuer">Associate the issuer</a> <var>issuer</var> with <var>topLevel</var>.</p>
    <li data-md>
     <p>If the <a data-link-type="dfn" href="#number-of-tokens" id="ref-for-number-of-tokens">number of tokens</a> for <var>issuer</var> is at least 500, return.</p>
    <li data-md>
     <p>Let <var>issuerKeys</var> be the result of <a data-link-type="dfn" href="#look-up-the-key-commitments" id="ref-for-look-up-the-key-commitments②">looking up the key commitments</a> for <var>issuer</var>.</p>
    <li data-md>
     <p>If <var>issuerKeys</var> is null,  return.</p>
    <li data-md>
     <p>Let <var>signingKey</var> be the result of <a data-link-type="dfn" href="#look-up-the-latest-keys" id="ref-for-look-up-the-latest-keys②">looking up of the latest keys</a> for <var>issuer</var>.</p>
    <li data-md>
     <p>Run <a data-link-type="dfn" href="#discard-tokens" id="ref-for-discard-tokens">discard tokens</a> with <var>issuer</var> and <var>signingKey</var>.</p>
    <li data-md>
     <p>Let <var>numTokens</var> be <var>issuer</var>’s <a data-link-type="dfn" href="#max-batch-size" id="ref-for-max-batch-size">max batch size</a> or an <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#implementation-defined" id="ref-for-implementation-defined②">implementation-defined</a> limit on the number of tokens (which is recommended to be 100), whichever is smaller.</p>
    <li data-md>
     <p>Let (<var>issueHeader</var>, <var>pretokens</var>) be the result of <a data-link-type="dfn" href="#generate-masked-tokens" id="ref-for-generate-masked-tokens">generating masked tokens</a> with <var>issuerKeys</var> and <var>numTokens</var>.</p>
    <li data-md>
     <p>Set <var>request</var>’s <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-cache-mode" id="ref-for-concept-request-cache-mode">cache mode</a> to <code>"no-store"</code>.</p>
    <li data-md>
     <p>Set <var>request</var>’s <a data-link-type="dfn" href="#request-pstpretokens" id="ref-for-request-pstpretokens">pstPretokens</a> to <var>pretokens</var>.</p>
    <li data-md>
     <p>Let <var>base64EncodedTokens</var> be the base64-encoded <a data-link-type="biblio" href="#biblio-rfc4648">[RFC4648]</a> version of <var>issueHeader</var>.</p>
    <li data-md>
     <p>Let <var>cryptoProtocolVersion</var> be the version of the cryptographic protocol used.</p>
    <li data-md>
     <p><a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-header-list-set-structured-header" id="ref-for-concept-header-list-set-structured-header">Set a structured field value</a> given (<a data-link-type="http-header" href="#http-headerdef-sec-private-state-token" id="ref-for-http-headerdef-sec-private-state-token"><code>Sec-Private-State-Token</code></a>, <var>base64EncodedTokens</var>)
            in <var>request</var>’s header list.</p>
    <li data-md>
     <p><a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-header-list-set-structured-header" id="ref-for-concept-header-list-set-structured-header①">Set a structured field value</a> given (<a data-link-type="http-header" href="#http-headerdef-sec-private-state-token-crypto-version" id="ref-for-http-headerdef-sec-private-state-token-crypto-version"><code>Sec-Private-State-Token-Crypto-Version</code></a>, <var>cryptoProtocolVersion</var>)
            in <var>request</var>’s header list.</p>
   </ol>
   <div class="example" id="example-pst-request-headers">
    <a class="self-link" href="#example-pst-request-headers"></a> Private State Token HTTP request headers created for a typical fetch is as follows. 
<pre>Sec-Private-State-Token: &lt;masked tokens encoded as base64 string>
Sec-Private-State-Token-Crypto-Version: &lt;cryptographic protocol version, VOPRF>
</pre>
   </div>
   <h3 class="heading settled" data-level="6.2" id="issuer-signing-tokens"><span class="secno">6.2. </span><span class="content">Issuer Signing Tokens</span><a class="self-link" href="#issuer-signing-tokens"></a></h3>
   <p>This section explains the signing of tokens that happens in the issuer
servers. VOPRF can only encode one of six values by the selection of which
key to use.</p>
   <p>Using its private keys, issuer signs the masked tokens obtained in the <a data-link-type="http-header" href="#http-headerdef-sec-private-state-token" id="ref-for-http-headerdef-sec-private-state-token①">Sec-Private-State-Token</a> request header value with a value
dependent on other information passed as part of the issuance request. Issuer uses the cryptographic protocol
specified in the request <a data-link-type="http-header" href="#http-headerdef-sec-private-state-token-crypto-version" id="ref-for-http-headerdef-sec-private-state-token-crypto-version①">Sec-Private-State-Token-Crypto-Version</a> header. Issuer returns
the signed tokens in the <a data-link-type="http-header" href="#http-headerdef-sec-private-state-token" id="ref-for-http-headerdef-sec-private-state-token②">Sec-Private-State-Token</a> response header
value encoded as a base64 <a data-link-type="biblio" href="#biblio-rfc4648">[RFC4648]</a> byte string.</p>
   <div class="example" id="example-pst-response">
    <a class="self-link" href="#example-pst-response"></a> The following snippet displays a typical response demonstrating the Private State Token
header. 
<pre>Sec-Private-State-Token: &lt;token encoded as base64 string>
</pre>
   </div>
   <p>The details for servers implementing this protocol can be found in <a data-link-type="biblio" href="#biblio-issuer-protocol" title="ISSUER_PROTOCOL">[ISSUER-PROTOCOL]</a>.</p>
   <h3 class="heading settled" data-level="6.3" id="issue-response"><span class="secno">6.3. </span><span class="content">Handling Issue Responses</span><a class="self-link" href="#issue-response"></a></h3>
   <p>To <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="handle-an-issue-response">handle an issue response</dfn>, given <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request" id="ref-for-concept-request⑦">request</a> <var>request</var> and <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-response" id="ref-for-concept-response②">response</a> <var>response</var>, run the following steps:</p>
   <ol>
    <li data-md>
     <p>If <var>request</var>’s <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-header-list" id="ref-for-concept-request-header-list">header list</a> <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#header-list-contains" id="ref-for-header-list-contains">does not contain</a> <a data-link-type="http-header" href="#http-headerdef-sec-private-state-token" id="ref-for-http-headerdef-sec-private-state-token③">Sec-Private-State-Token</a>, return null.</p>
    <li data-md>
     <p>If <var>response</var>’s <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-response-header-list" id="ref-for-concept-response-header-list">header list</a> <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#header-list-contains" id="ref-for-header-list-contains①">does not contain</a> <a data-link-type="http-header" href="#http-headerdef-sec-private-state-token" id="ref-for-http-headerdef-sec-private-state-token④">Sec-Private-State-Token</a>, return a <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-network-error" id="ref-for-concept-network-error②">network error</a>.</p>
    <li data-md>
     <p>Let <var>header</var> be the result of <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-header-list-get" id="ref-for-concept-header-list-get">getting</a> <a data-link-type="http-header" href="#http-headerdef-sec-private-state-token" id="ref-for-http-headerdef-sec-private-state-token⑤">Sec-Private-State-Token</a> from <var>response</var>’s <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-response-header-list" id="ref-for-concept-response-header-list①">header list</a>.</p>
    <li data-md>
     <p>If <var>header</var> is empty, return null.</p>
    <li data-md>
     <p><a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-header-list-delete" id="ref-for-concept-header-list-delete">Delete</a> <a data-link-type="http-header" href="#http-headerdef-sec-private-state-token" id="ref-for-http-headerdef-sec-private-state-token⑥">Sec-Private-State-Token</a> from <var>response</var>’s <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-response-header-list" id="ref-for-concept-response-header-list②">header list</a>.</p>
    <li data-md>
     <p>Let <var>issuer</var> be <var>request</var>’s <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-url" id="ref-for-concept-request-url①">URL</a>'s <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-url-origin" id="ref-for-concept-url-origin①">origin</a>.</p>
    <li data-md>
     <p>Let <var>issuerKeys</var> be the result of <a data-link-type="dfn" href="#look-up-the-key-commitments" id="ref-for-look-up-the-key-commitments③">looking up the key commitments</a> for <var>issuer</var>.</p>
    <li data-md>
     <p>If <var>issuerKeys</var> is null,  return.</p>
    <li data-md>
     <p>Let <var>pretokens</var> be <var>request</var>’s <a data-link-type="dfn" href="#request-pstpretokens" id="ref-for-request-pstpretokens①">pstPretokens</a>.</p>
    <li data-md>
     <p>If <var>pretokens</var> is null, return.</p>
    <li data-md>
     <p>Let <var>rawResponse</var> be the base64-decoded <a data-link-type="biblio" href="#biblio-rfc4648">[RFC4648]</a> version of <var>header</var>.</p>
    <li data-md>
     <p>Let <var>unmasked tokens</var> be the result of <a data-link-type="dfn" href="#unmask-tokens" id="ref-for-unmask-tokens">unmasking response tokens</a> given <var>issuerKeys</var>, <var>pretokens</var>, and <var>rawResponse</var>.</p>
    <li data-md>
     <p>If <var>unmasked tokens</var> is null, return a <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-network-error" id="ref-for-concept-network-error③">network error</a>.</p>
    <li data-md>
     <p>Let <var>signingKey</var> be the result <a data-link-type="dfn" href="#look-up-the-latest-keys" id="ref-for-look-up-the-latest-keys③">looking up the latest keys</a> for <var>issuer</var>.</p>
    <li data-md>
     <p>For each <var>token</var> in <var>unmasked tokens</var>, run the following steps:</p>
     <ol>
      <li data-md>
       <p><a data-link-type="dfn" href="#insert-a-token" id="ref-for-insert-a-token">Insert a token</a> for <var>issuer</var>, <var>token</var>, and <var>signingKey</var>.</p>
     </ol>
    <li data-md>
     <p>Return null.</p>
   </ol>
   <p>The details for servers implementing this protocol can be found in <a data-link-type="biblio" href="#biblio-issuer-protocol" title="ISSUER_PROTOCOL">[ISSUER-PROTOCOL]</a>.</p>
   <h2 class="heading settled" data-level="7" id="redeeming-tokens"><span class="secno">7. </span><span class="content">Redeeming Tokens</span><a class="self-link" href="#redeeming-tokens"></a></h2>
   <p>When the user agent navigates to a top-level origin, this top-level origin or a third party site
embedded on the top level origin may redeem tokens stored in the user agent from a
specific issuer to learn the data encoded in the tokens.</p>
   <div class="example" id="example-redemption-request">
    <a class="self-link" href="#example-redemption-request"></a> Redemption is carried through fetch as demonstrated in the following
snippet. The default value for refreshPolicy is <code>'none'</code>. 
<pre class="language-javascript highlight"><c- a>let</c-> redemptionRequest <c- o>=</c-> <c- ow>new</c-> Request<c- p>(</c-><c- t>'https://example.issuer:1234/redemption_path'</c-><c- p>,</c-> <c- p>{</c->
  privateToken<c- o>:</c-> <c- p>{</c->
    type<c- o>:</c-> <c- t>'private-state-token'</c-><c- p>,</c->
    version<c- o>:</c-> <c- mf>1</c-><c- p>,</c->
    operation<c- o>:</c-> <c- t>'token-redemption'</c-><c- p>,</c->
    refreshPolicy<c- o>:</c-> <c- p>{</c-><c- t>'none'</c-><c- p>,</c-> <c- t>'refresh'</c-><c- p>}</c->
  <c- p>}</c->
<c- p>});</c->
</pre>
   </div>
   <p>To <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="set-redemption-headers">set redemption headers</dfn> with <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request" id="ref-for-concept-request⑧">request</a> <var>request</var> and a <a data-link-type="dfn" href="#redemption-record" id="ref-for-redemption-record①">Redemption Record</a> <var>record</var>:</p>
   <ol>
    <li data-md>
     <p>Let <var>redemption-result</var> be the redemption procedure result.</p>
    <li data-md>
     <p>Let <var>cryptoProtocolVersion</var> be the version of the cryptographic protocol used.</p>
    <li data-md>
     <p>Let <var>token-lifetime</var> be the expiration time of the <a data-link-type="dfn" href="#redemption-record" id="ref-for-redemption-record②">redemption record</a> in seconds.</p>
    <li data-md>
     <p><a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-header-list-set-structured-header" id="ref-for-concept-header-list-set-structured-header②">Set a structured field value</a> given (<a data-link-type="http-header" href="#http-headerdef-sec-private-state-token" id="ref-for-http-headerdef-sec-private-state-token⑦"><code>Sec-Private-State-Token</code></a>, <var>redemption-result</var>)
            in <var>request</var>’s header list.</p>
    <li data-md>
     <p><a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-header-list-set-structured-header" id="ref-for-concept-header-list-set-structured-header③">Set a structured field value</a> given (<a data-link-type="http-header" href="#http-headerdef-sec-private-state-token-crypto-version" id="ref-for-http-headerdef-sec-private-state-token-crypto-version②"><code>Sec-Private-State-Token-Crypto-Version</code></a>, <var>cryptoProtocolVersion</var>)
            in <var>request</var>’s header list.</p>
    <li data-md>
     <p>Optionally, <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-header-list-set-structured-header" id="ref-for-concept-header-list-set-structured-header④">set a structured field value</a> given (<a data-link-type="http-header" href="#http-headerdef-sec-private-state-token-lifetime" id="ref-for-http-headerdef-sec-private-state-token-lifetime"><code>Sec-Private-State-Token-Lifetime</code></a>, <var>token-lifetime</var>)
            in <var>request</var>’s header list.</p>
    <li data-md>
     <p>Set <var>request</var>’s <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-cache-mode" id="ref-for-concept-request-cache-mode①">cache mode</a> to <code>"no-store"</code>.</p>
   </ol>
   <p>To <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="append-private-state-token-redemption-request-headers">append private state token redemption request headers</dfn> given a <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request" id="ref-for-concept-request⑨">request</a> <var>request</var>, run the following steps:</p>
   <ol>
    <li data-md>
     <p>Let <var>issuer</var> be <var>request</var>’s <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-url" id="ref-for-concept-request-url②">URL</a>'s <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-url-origin" id="ref-for-concept-url-origin②">origin</a>.</p>
    <li data-md>
     <p>Let <var>topLevel</var> be <var>request</var>’s <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-client" id="ref-for-concept-request-client②">client</a>'s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-top-level-origin" id="ref-for-concept-environment-top-level-origin①">top-level origin</a>.</p>
    <li data-md>
     <p>If <var>request</var>’s <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-client" id="ref-for-concept-request-client③">client</a> is not a <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#secure-context" id="ref-for-secure-context①">secure context</a>, return.</p>
    <li data-md>
     <p>If associating <var>issuer</var> with <var>topLevel</var> <a data-link-type="dfn" href="#determine-whether-associating-an-issuer-would-exceed-the-top-level-limit" id="ref-for-determine-whether-associating-an-issuer-would-exceed-the-top-level-limit①">would exceed the top level’s number-of-issuers limit</a>, return.</p>
    <li data-md>
     <p><a data-link-type="dfn" href="#associate-the-issuer" id="ref-for-associate-the-issuer①">Associate the issuer</a> <var>issuer</var> with <var>topLevel</var>.</p>
    <li data-md>
     <p>If <var>request</var>’s <a data-link-type="dfn" href="#request-private-token-refresh-policy" id="ref-for-request-private-token-refresh-policy②">private token refresh policy</a> is <code>"none"</code>:</p>
     <ol>
      <li data-md>
       <p>Let <var>record</var> be the result of performing <a data-link-type="dfn" href="#retrieve-a-redemption-record" id="ref-for-retrieve-a-redemption-record">retrieve a redemption record</a> with <var>issuer</var> and <var>topLevel</var>.</p>
      <li data-md>
       <p>If <var>record</var> is not null, <a data-link-type="dfn" href="#set-redemption-headers" id="ref-for-set-redemption-headers">set redemption headers</a> with <var>request</var> and <var>record</var> and return.</p>
     </ol>
    <li data-md>
     <p>Let <var>penultimateRedemption</var> be the result of <a data-link-type="dfn" href="#look-up-penultimate-redemption" id="ref-for-look-up-penultimate-redemption">look up penultimate redemption </a> with <var>issuer</var> and <var>topLevel</var></p>
    <li data-md>
     <p>If <var>penultimateRedemption</var> is less than an <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#implementation-defined" id="ref-for-implementation-defined③">implementation-defined</a> time period (which is recommended to be 48 hours), return error.</p>
    <li data-md>
     <p>Let <var>commitments</var> be the result of <a data-link-type="dfn" href="#look-up-the-key-commitments" id="ref-for-look-up-the-key-commitments④">looking up the key commitments</a> for <var>issuer</var>.</p>
    <li data-md>
     <p>If <var>commitments</var> is null, return.</p>
    <li data-md>
     <p><a data-link-type="dfn" href="#discard-tokens" id="ref-for-discard-tokens①">Discard tokens</a> from <var>issuer</var> that are signed with keys other than those from
        the issuer’s most recent commitments.</p>
    <li data-md>
     <p>Let <var>token</var> be the result of <a data-link-type="dfn" href="#retrieve-a-token" id="ref-for-retrieve-a-token">retrieving a token</a> for <var>issuer</var>.</p>
    <li data-md>
     <p>If <var>token</var> is null, return.</p>
    <li data-md>
     <p>Let <var>record</var> be the result of running a cryptographic redemption procedure with <var>token</var>. If the procedure fails, return.</p>
    <li data-md>
     <p><a data-link-type="dfn" href="#set-redemption-headers" id="ref-for-set-redemption-headers①">Set redemption headers</a> with <var>request</var> and <var>record</var>.</p>
   </ol>
   <h3 class="heading settled" data-level="7.1" id="redeem-response"><span class="secno">7.1. </span><span class="content">Handling Redeem Responses</span><a class="self-link" href="#redeem-response"></a></h3>
   <p>To <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="handle-a-redeem-response">handle a redeem response</dfn>, given <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request" id="ref-for-concept-request①⓪">request</a> <var>request</var> and <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-response" id="ref-for-concept-response③">response</a> <var>response</var>, run the following steps:</p>
   <ol>
    <li data-md>
     <p>If <var>request</var>’s <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-header-list" id="ref-for-concept-request-header-list①">header list</a> <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#header-list-contains" id="ref-for-header-list-contains②">does not contain</a> <a data-link-type="http-header" href="#http-headerdef-sec-private-state-token" id="ref-for-http-headerdef-sec-private-state-token⑧">Sec-Private-State-Token</a>, return null.</p>
    <li data-md>
     <p>If <var>response</var>’s <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-response-header-list" id="ref-for-concept-response-header-list③">header list</a> <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#header-list-contains" id="ref-for-header-list-contains③">does not contain</a> <a data-link-type="http-header" href="#http-headerdef-sec-private-state-token" id="ref-for-http-headerdef-sec-private-state-token⑨">Sec-Private-State-Token</a>, return a <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-network-error" id="ref-for-concept-network-error④">network error</a>.</p>
    <li data-md>
     <p>Let <var>header</var> be the result of <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-header-list-get" id="ref-for-concept-header-list-get①">getting</a> <a data-link-type="http-header" href="#http-headerdef-sec-private-state-token" id="ref-for-http-headerdef-sec-private-state-token①⓪">Sec-Private-State-Token</a> from <var>response</var>’s <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-response-header-list" id="ref-for-concept-response-header-list④">header list</a>.</p>
    <li data-md>
     <p>If <var>header</var> is empty, return null.</p>
    <li data-md>
     <p><a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-header-list-delete" id="ref-for-concept-header-list-delete①">Delete</a> <a data-link-type="http-header" href="#http-headerdef-sec-private-state-token" id="ref-for-http-headerdef-sec-private-state-token①①">Sec-Private-State-Token</a> from <var>response</var>’s <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-response-header-list" id="ref-for-concept-response-header-list⑤">header list</a>.</p>
    <li data-md>
     <p>Set <var>lifetime</var> to be the largest representable duration.</p>
    <li data-md>
     <p>If <var>response</var>’s <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-response-header-list" id="ref-for-concept-response-header-list⑥">header list</a> <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#header-list-contains" id="ref-for-header-list-contains④">contains</a> <a data-link-type="http-header" href="#http-headerdef-sec-private-state-token-lifetime" id="ref-for-http-headerdef-sec-private-state-token-lifetime①">Sec-Private-State-Token-Lifetime</a> response header, set <var>lifetime</var> to that value.</p>
    <li data-md>
     <p><a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-header-list-delete" id="ref-for-concept-header-list-delete②">Delete</a> <a data-link-type="http-header" href="#http-headerdef-sec-private-state-token-lifetime" id="ref-for-http-headerdef-sec-private-state-token-lifetime②">Sec-Private-State-Token-Lifetime</a> from <var>response</var>’s <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-response-header-list" id="ref-for-concept-response-header-list⑦">header list</a>.</p>
    <li data-md>
     <p>Let <var>issuer</var> be <var>request</var>’s <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-url" id="ref-for-concept-request-url③">URL</a>'s <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-url-origin" id="ref-for-concept-url-origin③">origin</a>.</p>
    <li data-md>
     <p>Let <var>topLevel</var> be <var>request</var>’s <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-client" id="ref-for-concept-request-client④">client</a>'s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-top-level-origin" id="ref-for-concept-environment-top-level-origin②">top-level origin</a>.</p>
    <li data-md>
     <p>Perform <a data-link-type="dfn" href="#record-redemption-timestamp" id="ref-for-record-redemption-timestamp">record redemption timestamp</a> with <var>issuer</var> and <var>topLevel</var>.</p>
    <li data-md>
     <p>Perform <a data-link-type="dfn" href="#record-a-redemption-record" id="ref-for-record-a-redemption-record">record a redemption record</a> with <var>issuer</var>, <var>topLevel</var>, <var>header</var>, and <var>lifetime</var>.</p>
   </ol>
   <p class="note" role="note"><span class="marker">Note:</span> The <a data-link-type="dfn" href="#redemption-record" id="ref-for-redemption-record③">redemption record</a> is HTTP-only and JavaScript is only able to
access/send the <a data-link-type="dfn" href="#redemption-record" id="ref-for-redemption-record④">redemption record</a> via Private State Token Fetch APIs. The <a data-link-type="dfn" href="#redemption-record" id="ref-for-redemption-record⑤">redemption record</a> is treated as an
arbitrary blob of bytes from the issuer, that may have semantic meaning to
downstream consumers.</p>
   <h3 class="heading settled" data-level="7.2" id="redemption-records"><span class="secno">7.2. </span><span class="content">Redemption Records</span><a class="self-link" href="#redemption-records"></a></h3>
   <p>To reduce communication overhead, the user agent might cache blobs returned in <a data-link-type="http-header" href="#http-headerdef-sec-private-state-token" id="ref-for-http-headerdef-sec-private-state-token①②">Sec-Private-State-Token</a> header value in redemption responses. These blobs are
referred as <a data-link-type="dfn" href="#redemption-record" id="ref-for-redemption-record⑥">Redemption Records</a>. User agents might choose to store these records
to include them in subsequent requests to the origins that can verify its
validity. An issuer might choose to include an optional <a data-link-type="http-header" href="#http-headerdef-sec-private-state-token-lifetime" id="ref-for-http-headerdef-sec-private-state-token-lifetime③">Sec-Private-State-Token-Lifetime</a> header in the redemption response. The value of this header indicates the
expiration time for the <a data-link-type="dfn" href="#redemption-record" id="ref-for-redemption-record⑦">redemption record</a> provided. This expiration is
specified as number of seconds in the <a data-link-type="http-header" href="#http-headerdef-sec-private-state-token-lifetime" id="ref-for-http-headerdef-sec-private-state-token-lifetime④"><code>Sec-Private-State-Token-Lifetime</code></a> HTTP response
header value.</p>
   <p>A <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="redemption-record">Redemption Record</dfn> is a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#byte-sequence" id="ref-for-byte-sequence⑨">byte sequence</a>.</p>
   <p>The Private State Tokens API provides a <code>'send-redemption-record'</code> operation to <a data-link-type="dfn" href="#append-private-state-token-redemption-record-headers" id="ref-for-append-private-state-token-redemption-record-headers①">append private state token redemption record headers</a>. This operation attaches a previously <a data-link-type="dfn" href="#record-a-redemption-record" id="ref-for-record-a-redemption-record①">recorded redemption record</a> from <a data-link-type="dfn" href="#handle-a-redeem-response" id="ref-for-handle-a-redeem-response①">handle a redeem response</a>.</p>
   <p>To <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="append-private-state-token-redemption-record-headers">append private state token redemption record headers</dfn> given a <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request" id="ref-for-concept-request①①">request</a> <var>request</var>, run the following steps:</p>
   <ol>
    <li data-md>
     <p>If <var>request</var>’s <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-client" id="ref-for-concept-request-client⑤">client</a> is not a <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#secure-context" id="ref-for-secure-context②">secure context</a>, then abort these steps.</p>
    <li data-md>
     <p>Let <var>topLevel</var> be <var>request</var>’s <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-client" id="ref-for-concept-request-client⑥">client</a>'s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-top-level-origin" id="ref-for-concept-environment-top-level-origin③">top-level origin</a>.</p>
    <li data-md>
     <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-iterate" id="ref-for-list-iterate②">For each</a> <var>issuer</var> of <a data-link-type="dfn" href="#request-private-token-issuers" id="ref-for-request-private-token-issuers③">private token issuers</a>:</p>
     <ol>
      <li data-md>
       <p>Let <var>issuerURL</var> be the the result of running the <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-url-parser" id="ref-for-concept-url-parser①">URL parser</a> on <var>issuer</var>.</p>
      <li data-md>
       <p>If <var>issuerURL</var> is failure, then abort these steps.</p>
      <li data-md>
       <p>If <var>issuerURL</var>’s <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-url-scheme" id="ref-for-concept-url-scheme①">scheme</a> is not an <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#http-scheme" id="ref-for-http-scheme①">HTTP(S) scheme</a>, then abort these steps.</p>
      <li data-md>
       <p>Let <var>issuerOrigin</var> be <var>issuerURL</var>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-origin" id="ref-for-concept-origin②⑥">origin</a>.</p>
      <li data-md>
       <p>If <var>issuerOrigin</var> is not a <a data-link-type="dfn" href="https://w3c.github.io/webappsec-secure-contexts/#potentially-trustworthy-origin" id="ref-for-potentially-trustworthy-origin①">potentially trustworthy origin</a>, then abort these steps.</p>
     </ol>
    <li data-md>
     <p>Let <var>records_per_issuer</var> be a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#ordered-map" id="ref-for-ordered-map⑥">map</a> where keys are USVString and values are <a data-link-type="dfn" href="#redemption-record" id="ref-for-redemption-record⑧">redemption records</a>.</p>
    <li data-md>
     <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-iterate" id="ref-for-list-iterate③">For each</a> <var>issuer</var> of <a data-link-type="dfn" href="#request-private-token-issuers" id="ref-for-request-private-token-issuers④">private token issuers</a>:</p>
     <ol>
      <li data-md>
       <p>Let <var>record</var> be the result of performing <a data-link-type="dfn" href="#retrieve-a-redemption-record" id="ref-for-retrieve-a-redemption-record①">retrieve a redemption record</a> with <var>issuer</var> and <var>topLevel</var>.</p>
      <li data-md>
       <p>If <var>record</var> is null, then <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#iteration-continue" id="ref-for-iteration-continue">continue</a>.</p>
      <li data-md>
       <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#map-set" id="ref-for-map-set②">Set</a> <var>records_per_issuer</var>[<var>issuer</var>] to <var>record</var>.</p>
     </ol>
    <li data-md>
     <p>If <var>records_per_issuer</var> is empty, then abort these steps.</p>
    <li data-md>
     <p>Let <var>headerItems</var> be a structured headers list <a data-link-type="biblio" href="#biblio-rfc8941" title="Structured Field Values for HTTP">[RFC8941]</a>.</p>
    <li data-md>
     <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#map-iterate" id="ref-for-map-iterate">For each</a> <var>issuer</var> -> <var>record</var> of <var>records_per_issuer</var>:</p>
     <ol>
      <li data-md>
       <p>Let <var>serializedIssuer</var> be result of serializing <var>issuer</var>.</p>
      <li data-md>
       <p>Let <var>serializedRecord</var> be result of serializing <var>record</var>.</p>
      <li data-md>
       <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-append" id="ref-for-list-append③">Append</a> <var>serializedIssuer</var> and <var>serializedRecord</var> pairs to <var>headerItems</var>.</p>
     </ol>
    <li data-md>
     <p>Let <var>serializedHeaderItems</var> be result of serializing <var>headerItems</var>.</p>
    <li data-md>
     <p>If <var>serializedHeaderItems</var> is null, then abort these steps.</p>
    <li data-md>
     <p>Set <a data-link-type="http-header" href="#http-headerdef-sec-redemption-record" id="ref-for-http-headerdef-sec-redemption-record"><code>Sec-Redemption-Record</code></a> to <var>serializedHeaderItems</var>.</p>
   </ol>
   <h3 class="heading settled" data-level="7.3" id="the-document-object"><span class="secno">7.3. </span><span class="content">Changes to <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document">Document</a></code></span><a class="self-link" href="#the-document-object"></a></h3>
<pre class="idl highlight def"><c- b>partial</c-> <c- b>interface</c-> <a class="idl-code" data-link-type="interface" href="https://dom.spec.whatwg.org/#document" id="ref-for-document①"><c- g>Document</c-></a> {
  <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-promise" id="ref-for-idl-promise"><c- b>Promise</c-></a>&lt;<a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-boolean" id="ref-for-idl-boolean"><c- b>boolean</c-></a>> <a class="idl-code" data-link-type="method" href="#dom-document-hasprivatetokens" id="ref-for-dom-document-hasprivatetokens"><c- g>hasPrivateTokens</c-></a>(<a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-USVString" id="ref-for-idl-USVString①"><c- b>USVString</c-></a> <dfn class="idl-code" data-dfn-for="Document/hasPrivateTokens(issuer, type)" data-dfn-type="argument" data-export id="dom-document-hasprivatetokens-issuer-type-issuer"><code><c- g>issuer</c-></code><a class="self-link" href="#dom-document-hasprivatetokens-issuer-type-issuer"></a></dfn>, <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-USVString" id="ref-for-idl-USVString②"><c- b>USVString</c-></a> <dfn class="idl-code" data-dfn-for="Document/hasPrivateTokens(issuer, type)" data-dfn-type="argument" data-export id="dom-document-hasprivatetokens-issuer-type-type"><code><c- g>type</c-></code><a class="self-link" href="#dom-document-hasprivatetokens-issuer-type-type"></a></dfn>);
  <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-promise" id="ref-for-idl-promise①"><c- b>Promise</c-></a>&lt;<a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-boolean" id="ref-for-idl-boolean①"><c- b>boolean</c-></a>> <a class="idl-code" data-link-type="method" href="#dom-document-hasredemptionrecord" id="ref-for-dom-document-hasredemptionrecord"><c- g>hasRedemptionRecord</c-></a>(<a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-USVString" id="ref-for-idl-USVString③"><c- b>USVString</c-></a> <dfn class="idl-code" data-dfn-for="Document/hasRedemptionRecord(issuer, type)" data-dfn-type="argument" data-export id="dom-document-hasredemptionrecord-issuer-type-issuer"><code><c- g>issuer</c-></code><a class="self-link" href="#dom-document-hasredemptionrecord-issuer-type-issuer"></a></dfn>, <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-USVString" id="ref-for-idl-USVString④"><c- b>USVString</c-></a> <dfn class="idl-code" data-dfn-for="Document/hasRedemptionRecord(issuer, type)" data-dfn-type="argument" data-export id="dom-document-hasredemptionrecord-issuer-type-type"><code><c- g>type</c-></code><a class="self-link" href="#dom-document-hasredemptionrecord-issuer-type-type"></a></dfn>);
};
</pre>
   <h2 class="heading settled" data-level="8" id="query-apis"><span class="secno">8. </span><span class="content">Query APIs</span><a class="self-link" href="#query-apis"></a></h2>
   <h3 class="heading settled" data-level="8.1" id="token-query"><span class="secno">8.1. </span><span class="content">Token Query</span><a class="self-link" href="#token-query"></a></h3>
   <p>When invoked on <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document②">Document</a></code> <var>doc</var> with <code class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#idl-USVString" id="ref-for-idl-USVString⑤">USVString</a></code> <var>issuer</var> and <code class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#idl-USVString" id="ref-for-idl-USVString⑥">USVString</a></code> <var>type</var>, the <dfn class="dfn-paneled idl-code" data-dfn-for="Document" data-dfn-type="method" data-export id="dom-document-hasprivatetokens"><code>hasPrivateTokens(issuer, type)</code></dfn> method must run these steps:</p>
   <ol>
    <li data-md>
     <p>Let <var>p</var> be <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#a-new-promise" id="ref-for-a-new-promise">a new promise</a>.</p>
    <li data-md>
     <p>If <var>doc</var> is not <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active" id="ref-for-fully-active">fully active</a>, then <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#reject" id="ref-for-reject">reject</a> <var>p</var> with an "<code class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#invalidstateerror" id="ref-for-invalidstateerror">InvalidStateError</a></code>" <code class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#idl-DOMException" id="ref-for-idl-DOMException">DOMException</a></code> and return <var>p</var>.</p>
    <li data-md>
     <p>Let <var>global</var> be <var>doc</var>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-global" id="ref-for-concept-relevant-global">relevant global object</a>.</p>
    <li data-md>
     <p>If <var>global</var> is not a <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#secure-context" id="ref-for-secure-context③">secure context</a>, then <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#reject" id="ref-for-reject①">reject</a> <var>p</var> with a "<code class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#notallowederror" id="ref-for-notallowederror">NotAllowedError</a></code>" <code class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#idl-DOMException" id="ref-for-idl-DOMException①">DOMException</a></code> and return <var>p</var>.</p>
    <li data-md>
     <p>If <var>type</var> is not <code>"private-state-token"</code>, <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#reject" id="ref-for-reject②">reject</a> <var>p</var> with a "<code class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#exceptiondef-typeerror" id="ref-for-exceptiondef-typeerror⑤">TypeError</a></code>" <code class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#idl-DOMException" id="ref-for-idl-DOMException②">DOMException</a></code> and return <var>p</var>.</p>
    <li data-md>
     <p>Let <var>parsedURL</var> be the the result of running the <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-url-parser" id="ref-for-concept-url-parser②">URL parser</a> on <var>issuer</var>.</p>
    <li data-md>
     <p>If <var>parsedURL</var> is failure, <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#reject" id="ref-for-reject③">reject</a> <var>p</var> with a "<code class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#exceptiondef-typeerror" id="ref-for-exceptiondef-typeerror⑥">TypeError</a></code>" <code class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#idl-DOMException" id="ref-for-idl-DOMException③">DOMException</a></code> and return <var>p</var>.</p>
    <li data-md>
     <p>Let <var>origin</var> be <var>parsedURL</var>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-origin" id="ref-for-concept-origin②⑦">origin</a>.</p>
    <li data-md>
     <p>Let <var>topLevel</var> be the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-top-level-origin" id="ref-for-concept-environment-top-level-origin④">top-level origin</a> of <var>doc</var>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object" id="ref-for-relevant-settings-object">relevant settings object</a>.</p>
    <li data-md>
     <p>Run the following steps <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel" id="ref-for-in-parallel">in parallel</a>:</p>
     <ol>
      <li data-md>
       <p>If associating <var>issuer</var> with <var>topLevel</var> <a data-link-type="dfn" href="#determine-whether-associating-an-issuer-would-exceed-the-top-level-limit" id="ref-for-determine-whether-associating-an-issuer-would-exceed-the-top-level-limit②">would exceed the top level’s number-of-issuers limit</a>, <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task" id="ref-for-queue-a-global-task">queue a global task</a> on the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#networking-task-source" id="ref-for-networking-task-source">networking task source</a> given <var>global</var> to <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#reject" id="ref-for-reject④">reject</a> <var>p</var> with a "<code class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#notallowederror" id="ref-for-notallowederror①">NotAllowedError</a></code>" <code class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#idl-DOMException" id="ref-for-idl-DOMException④">DOMException</a></code> and return.</p>
      <li data-md>
       <p><a data-link-type="dfn" href="#associate-the-issuer" id="ref-for-associate-the-issuer②">Associate the issuer</a> <var>origin</var> with <var>topLevel</var>.</p>
      <li data-md>
       <p><a data-link-type="dfn" href="#look-up-the-key-commitments" id="ref-for-look-up-the-key-commitments⑤">Look up the key commitments</a> for <var>origin</var>. If there are key commitments, <a data-link-type="dfn" href="#discard-tokens" id="ref-for-discard-tokens②">discard tokens</a> from <var>origin</var> that are signed with keys other than those
     from the issuer’s most recent commitments.</p>
      <li data-md>
       <p><a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task" id="ref-for-queue-a-global-task①">Queue a global task</a> on the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#networking-task-source" id="ref-for-networking-task-source①">networking task source</a> given <var>global</var> to <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#resolve" id="ref-for-resolve">resolve</a> <var>p</var> with true if there are tokens stored for the given issuer, with false otherwise.</p>
     </ol>
    <li data-md>
     <p>Return <var>p</var>.</p>
   </ol>
   <p class="note" role="note"><span class="marker">Note:</span> This query modifies the user agent state. It associates the issuer
argument with the current origin. The specification allows at most 2 issuers associated
with an origin. This is to prevent leaking information through the issuers a
user has tokens from. Note that querying tokens triggers removal of stale tokens.</p>
   <h3 class="heading settled" data-level="8.2" id="redemption-record-query"><span class="secno">8.2. </span><span class="content">Redemption Record Query</span><a class="self-link" href="#redemption-record-query"></a></h3>
   <p>When invoked on <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document③">Document</a></code> <var>doc</var> with <code class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#idl-USVString" id="ref-for-idl-USVString⑦">USVString</a></code> <var>issuer</var> and <code class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#idl-USVString" id="ref-for-idl-USVString⑧">USVString</a></code> <var>type</var>, the <dfn class="dfn-paneled idl-code" data-dfn-for="Document" data-dfn-type="method" data-export id="dom-document-hasredemptionrecord"><code>hasRedemptionRecord(issuer, type)</code></dfn> method must run these steps:</p>
   <ol>
    <li data-md>
     <p>Let <var>p</var> be <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#a-new-promise" id="ref-for-a-new-promise①">a new promise</a>.</p>
    <li data-md>
     <p>If <var>doc</var> is not <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active" id="ref-for-fully-active①">fully active</a>, then <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#reject" id="ref-for-reject⑤">reject</a> <var>p</var> with an "<code class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#invalidstateerror" id="ref-for-invalidstateerror①">InvalidStateError</a></code>" <code class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#idl-DOMException" id="ref-for-idl-DOMException⑤">DOMException</a></code> and return <var>p</var>.</p>
    <li data-md>
     <p>Let <var>global</var> be <var>doc</var>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-global" id="ref-for-concept-relevant-global①">relevant global object</a>.</p>
    <li data-md>
     <p>If <var>global</var> is not a <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#secure-context" id="ref-for-secure-context④">secure context</a>, then <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#reject" id="ref-for-reject⑥">reject</a> <var>p</var> with a "<code class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#notallowederror" id="ref-for-notallowederror②">NotAllowedError</a></code>" <code class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#idl-DOMException" id="ref-for-idl-DOMException⑥">DOMException</a></code> and return <var>p</var>.</p>
    <li data-md>
     <p>If <var>type</var> is not <code>"private-state-token"</code>, <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#reject" id="ref-for-reject⑦">reject</a> <var>p</var> with a "<code class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#exceptiondef-typeerror" id="ref-for-exceptiondef-typeerror⑦">TypeError</a></code>" <code class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#idl-DOMException" id="ref-for-idl-DOMException⑦">DOMException</a></code> and return <var>p</var>.</p>
    <li data-md>
     <p>Let <var>parsedURL</var> be the the result of running the <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-url-parser" id="ref-for-concept-url-parser③">URL parser</a> on <var>issuer</var>.</p>
    <li data-md>
     <p>If <var>parsedURL</var> is failure, <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#reject" id="ref-for-reject⑧">reject</a> <var>p</var> with a "<code class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#exceptiondef-typeerror" id="ref-for-exceptiondef-typeerror⑧">TypeError</a></code>" <code class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#idl-DOMException" id="ref-for-idl-DOMException⑧">DOMException</a></code> and return <var>p</var>.</p>
    <li data-md>
     <p>Let <var>origin</var> be <var>parsedURL</var>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-origin" id="ref-for-concept-origin②⑧">origin</a>.</p>
    <li data-md>
     <p>Let <var>topLevel</var> be the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-top-level-origin" id="ref-for-concept-environment-top-level-origin⑤">top-level origin</a> of <var>doc</var>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object" id="ref-for-relevant-settings-object①">relevant settings object</a>.</p>
    <li data-md>
     <p>Run the following steps <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel" id="ref-for-in-parallel①">in parallel</a>:</p>
     <ol>
      <li data-md>
       <p>If <var>origin</var> <a data-link-type="dfn" href="#is-associated-with" id="ref-for-is-associated-with">is not associated with</a> <var>topLevel</var>, <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task" id="ref-for-queue-a-global-task②">queue a global task</a> on the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#networking-task-source" id="ref-for-networking-task-source②">networking task source</a> given <var>global</var> to <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#resolve" id="ref-for-resolve①">resolve</a> <var>p</var> with false and return.</p>
      <li data-md>
       <p><a data-link-type="dfn" href="#look-up-the-key-commitments" id="ref-for-look-up-the-key-commitments⑥">Look up the key commitments</a> for <var>origin</var>. If there are key commitments, <a data-link-type="dfn" href="#discard-tokens" id="ref-for-discard-tokens③">discard tokens</a> from <var>origin</var> that are signed with keys other than those
     from the issuer’s most recent commitments.</p>
      <li data-md>
       <p><a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task" id="ref-for-queue-a-global-task③">Queue a global task</a> on the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#networking-task-source" id="ref-for-networking-task-source③">networking task source</a> given <var>global</var> to <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#resolve" id="ref-for-resolve②">resolve</a> <var>p</var> with true if there is a <a data-link-type="dfn" href="#redemption-record" id="ref-for-redemption-record⑨">redemption record</a> for the issuer and top level pair, with false otherwise.</p>
     </ol>
    <li data-md>
     <p>Return <var>p</var>.</p>
   </ol>
   <p class="note" role="note"><span class="marker">Note:</span> Similar to token query, redemption query might modify the user agent state. Unlike
token query, redemption query does not associate issuer with the top level
origin. There is no need to associate the issuer queried with the top level
origin, because the answer to the redemption query does not leak information about
the issuers of the currently stored tokens. Similar to token query, redemption
query clears stale tokens.</p>
   <h2 class="heading settled" data-level="9" id="pst-http-header-fields"><span class="secno">9. </span><span class="content">Private State Token HTTP Header Fields</span><a class="self-link" href="#pst-http-header-fields"></a></h2>
   <h3 class="heading settled" data-level="9.1" id="sec-private-state-token"><span class="secno">9.1. </span><span class="content">The 'Sec-Private-State-Token' Header Field</span><a class="self-link" href="#sec-private-state-token"></a></h3>
   <p>The <dfn class="dfn-paneled" data-dfn-type="http-header" data-export id="http-headerdef-sec-private-state-token">Sec-Private-State-Token</dfn> <em>request</em> header field sends
a collection of unsigned, masked tokens during issuance. During redemption, it
sends a singled signed, unmasked token along with associated redemption
metadata.</p>
   <p>The <a data-link-type="http-header" href="#http-headerdef-sec-private-state-token" id="ref-for-http-headerdef-sec-private-state-token①③">Sec-Private-State-Token</a> <em>response</em> header field sends
a collection of signed, masked tokens. During redemption it sends the
just-created signed <a data-link-type="dfn" href="#redemption-record" id="ref-for-redemption-record①⓪">redemption record</a>.</p>
   <p>It is a <a data-link-type="dfn" href="https://tools.ietf.org/html/rfc8941#name-introduction" id="ref-for-name-introduction">Structured Header</a> whose value MUST be an <a data-link-type="dfn" href="https://tools.ietf.org/html/rfc8941#section-3.3.3" id="ref-for-section-3.3.3">string</a> <a data-link-type="biblio" href="#biblio-rfc8941" title="Structured Field Values for HTTP">[RFC8941]</a>.</p>
   <p>The header’s ABNF is:</p>
<pre class="language-abnf highlight"><c- nc>Sec-Private-State-Token</c-> <c- o>=</c-> <c- nc>sf-string</c->
</pre>
   <h3 class="heading settled" data-level="9.2" id="sec-private-state-token-lifetime"><span class="secno">9.2. </span><span class="content">The 'Sec-Private-State-Token-Lifetime' Header Field</span><a class="self-link" href="#sec-private-state-token-lifetime"></a></h3>
   <p>The <dfn class="dfn-paneled" data-dfn-type="http-header" data-export id="http-headerdef-sec-private-state-token-lifetime"><code>Sec-Private-State-Token-Lifetime</code></dfn> response header
field gives the expiration for the <a data-link-type="dfn" href="#redemption-record" id="ref-for-redemption-record①①">redemption record</a> given in the associated <a data-link-type="http-header" href="#http-headerdef-sec-private-state-token" id="ref-for-http-headerdef-sec-private-state-token①④"><code>Sec-Private-State-Token</code></a> response header. The expiration is given in seconds.</p>
   <p>It is a <a data-link-type="dfn" href="https://tools.ietf.org/html/rfc8941#name-introduction" id="ref-for-name-introduction①">Structured Header</a> whose value MUST be an <a data-link-type="dfn" href="https://tools.ietf.org/html/rfc8941#section-3.3.1" id="ref-for-section-3.3.1">integer</a> <a data-link-type="biblio" href="#biblio-rfc8941" title="Structured Field Values for HTTP">[RFC8941]</a>.</p>
   <p>The header’s ABNF is:</p>
<pre class="language-abnf highlight"><c- nc>Sec-Private-State-Token-Lifetime</c-> <c- o>=</c-> <c- nc>sf-integer</c->
</pre>
   <h3 class="heading settled" data-level="9.3" id="sec-private-state-token-crypto-version"><span class="secno">9.3. </span><span class="content">The 'Sec-Private-State-Token-Crypto-Version' Header Field</span><a class="self-link" href="#sec-private-state-token-crypto-version"></a></h3>
   <p>The <dfn class="dfn-paneled" data-dfn-type="http-header" data-export id="http-headerdef-sec-private-state-token-crypto-version"><code>Sec-Private-State-Token-Crypto-Version</code></dfn> header field gives
the cryptographic protocol version of the Private State Token.</p>
   <p>It is a <a data-link-type="dfn" href="https://tools.ietf.org/html/rfc8941#name-introduction" id="ref-for-name-introduction②">Structured Header</a> whose value MUST be an <a data-link-type="dfn" href="https://tools.ietf.org/html/rfc8941#section-3.3.3" id="ref-for-section-3.3.3①">string</a> <a data-link-type="biblio" href="#biblio-rfc8941" title="Structured Field Values for HTTP">[RFC8941]</a>.</p>
   <p>The header’s ABNF is:</p>
<pre class="language-abnf highlight"><c- nc>Sec-Private-State-Token-Crypto-Version</c-> <c- o>=</c-> <c- nc>sf-string</c->
</pre>
   <h3 class="heading settled" data-level="9.4" id="sec-redemption-record"><span class="secno">9.4. </span><span class="content">The 'Sec-Redemption-Record' Header Field</span><a class="self-link" href="#sec-redemption-record"></a></h3>
   <p>The <dfn class="dfn-paneled" data-dfn-type="http-header" data-export id="http-headerdef-sec-redemption-record"><code>Sec-Redemption-Record</code></dfn> <em>request</em> header field sends
a cached <a data-link-type="dfn" href="#redemption-record" id="ref-for-redemption-record①②">redemption record</a> of a previous redemption operation.</p>
   <p>It is a <a data-link-type="dfn" href="https://tools.ietf.org/html/rfc8941#name-introduction" id="ref-for-name-introduction③">Structured Header</a> whose value MUST be an <a data-link-type="dfn" href="https://tools.ietf.org/html/rfc8941#section-3.3.3" id="ref-for-section-3.3.3②">string</a> <a data-link-type="biblio" href="#biblio-rfc8941" title="Structured Field Values for HTTP">[RFC8941]</a>.</p>
   <p>The header’s ABNF is:</p>
<pre class="language-abnf highlight"><c- nc>Sec-Redemption-Record</c-> <c- o>=</c-> <c- nc>sf-string</c->
</pre>
   <h2 class="heading settled" data-level="10" id="privacy"><span class="secno">10. </span><span class="content">Privacy Considerations</span><a class="self-link" href="#privacy"></a></h2>
   <h3 class="heading settled" data-level="10.1" id="unlinkability"><span class="secno">10.1. </span><span class="content">Unlinkability</span><a class="self-link" href="#unlinkability"></a></h3>
   <p>Cryptographic protocols <a data-link-type="biblio" href="#biblio-voprf" title="Oblivious Pseudorandom Functions (OPRFs) using Prime-Order Groups">[VOPRF]</a> provide masked signatures. At
redemption time, issuers can recognize their signature on the provided token,
however they can not determine at what time or in which context they signed the token.
This prevents issuers from correlating their issuances on an origin with
redemptions on another origin. Issuers learn only the aggregate information
about the origins users visit.</p>
   <h3 class="heading settled" data-level="10.2" id="limit-encoded-info"><span class="secno">10.2. </span><span class="content">Limiting Encoded Information</span><a class="self-link" href="#limit-encoded-info"></a></h3>
   <p>User agents should enforce limits on the number of unique keys an issuer can have
at any point in time, to preserve client privacy.  Without limits, an issuer could
de-anonymize clients by simply using a unique key for each client. For <a data-link-type="biblio" href="#biblio-voprf" title="Oblivious Pseudorandom Functions (OPRFs) using Prime-Order Groups">[VOPRF]</a>, the
number of keys is limited to six.</p>
   <p>Issuers can utilize different keys to represent different "labels", which correspond
to an arbritrary client state, such as client trust level or some other useful
anti-fraud signal. Issuers are responsible for understanding this designation and
sharing the key "labels" with token redeemers so they know how to interpret the
significance of each token. This helps reduce reverse engineering from malicious
actors and preserves client privacy over human-readable labels. When using <a data-link-type="biblio" href="#biblio-voprf" title="Oblivious Pseudorandom Functions (OPRFs) using Prime-Order Groups">[VOPRF]</a>,
the issuer’s 6 keys can effectively represent six labels.</p>
   <h4 class="heading settled" data-level="10.2.1" id="side-channel-fingerprinting"><span class="secno">10.2.1. </span><span class="content">Potential Attack: Side Channel Fingerprinting</span><a class="self-link" href="#side-channel-fingerprinting"></a></h4>
   <p>Unlinkability is lost if the issuer is able to use network-level fingerprinting
or any other side-channel and can associate the user agent at redemption time with
the user agent at token issuance time, even though the Private State Token API
itself has only stored and revealed limited amount of information about the
user agent.</p>
   <h3 class="heading settled" data-level="10.3" id="cross-site-info"><span class="secno">10.3. </span><span class="content">Cross-site Information Transfer</span><a class="self-link" href="#cross-site-info"></a></h3>
   <p>Private State Tokens transfer limited information between first-party contexts.
Underlying cryptographic protocols guarantee that each token only contains a
small amount of information. Still, if we allow many token redemptions on a
single page, the first-party cookie for user U on domain A can be encoded in
the Private State Token information channel and decoded on domain B, allowing
domain B to learn the user’s domain A cookie until either 1p cookie is cleared.
Separate from the concern of channels allowing arbitrary communication between
domains, some identification attacks---for instance, a malicious redeemer
attempting to learn the exact set of issuers that have granted tokens to a
particular user, which could be identifying---have similar mitigations.</p>
   <h4 class="heading settled" data-level="10.3.1" id="api-usage-limits"><span class="secno">10.3.1. </span><span class="content">Mitigation: Dynamic Issuance/Redemption Limits</span><a class="self-link" href="#api-usage-limits"></a></h4>
   <p>To mitigate this attack, the specification places limits on both issuance and redemption.
User activation with the issuing site is required in the issuing operation. The
specification does not allow a third redemption in an <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#implementation-defined" id="ref-for-implementation-defined④">implementation-defined</a> time window,
usually 48 hours.</p>
   <h4 class="heading settled" data-level="10.3.2" id="per-issuer-limits"><span class="secno">10.3.2. </span><span class="content">Mitigation: Per-Site Issuer Limits</span><a class="self-link" href="#per-issuer-limits"></a></h4>
   <p>The rate of identity leakage from one origin to another increases with the
number of issuers allowed in an origin. To avoid abuse, the user agent allows
association of at most two issuers per top level origin. Issuers are associated
with top level origins for token query API as well, see <a href="#token-query">§ 8.1 Token Query</a>.</p>
   <h2 class="heading settled" data-level="11" id="security"><span class="secno">11. </span><span class="content">Security Considerations</span><a class="self-link" href="#security"></a></h2>
   <h3 class="heading settled" data-level="11.1" id="token-exhaustion"><span class="secno">11.1. </span><span class="content">Preventing Token Exhaustion</span><a class="self-link" href="#token-exhaustion"></a></h3>
   <p>Malicious origins might attempt to exhaust all tokens stored in the user agent by
redeeming them all. To prevent this, the specification limits the number of redemption
operations. In the context of a given origin, two redemptions are allowed initially. However,
the third redemption is only allowed once more than an <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#implementation-defined" id="ref-for-implementation-defined⑤">implementation-defined</a> amount of time,
usually 48 hours, have elapsed since the first redemption.</p>
   <h3 class="heading settled" data-level="11.2" id="preventing-double-spend"><span class="secno">11.2. </span><span class="content">Preventing Double Spending</span><a class="self-link" href="#preventing-double-spend"></a></h3>
   <p>Issuers can verify that each token is seen only once, because every redemption
is sent to the same token issuer. This means that even if a malicious piece of
malware exfiltrates all of a user’s tokens, the tokens will run out over time.
Issuers can sign fewer tokens at a time to mitigate the risk.</p>
   <h2 class="heading settled" data-level="12" id="iana-considerations"><span class="secno">12. </span><span class="content">IANA Considerations</span><a class="self-link" href="#iana-considerations"></a></h2>
   <p>This document intends to define the <a data-link-type="http-header" href="#http-headerdef-sec-private-state-token" id="ref-for-http-headerdef-sec-private-state-token①⑤">Sec-Private-State-Token</a>, <a data-link-type="http-header" href="#http-headerdef-sec-private-state-token-lifetime" id="ref-for-http-headerdef-sec-private-state-token-lifetime⑤">Sec-Private-State-Token-Lifetime</a>, <a data-link-type="http-header" href="#http-headerdef-sec-private-state-token-crypto-version" id="ref-for-http-headerdef-sec-private-state-token-crypto-version③">Sec-Private-State-Token-Crypto-Version</a>,
HTTP request header fields, and register them in the permanent message
header field registry (<a data-link-type="biblio" href="#biblio-rfc9110" title="HTTP Semantics">[RFC9110]</a>).</p>
   <h3 class="heading settled" data-level="12.1" id="iana-sec-private-state-token"><span class="secno">12.1. </span><span class="content">'Sec-Private-State-Token' Header Field</span><a class="self-link" href="#iana-sec-private-state-token"></a></h3>
   <p>Header field name: Sec-Private-State-Token</p>
   <p>Applicable protocol: http</p>
   <p>Status: standard</p>
   <p>Author/Change controller: IETF</p>
   <p>Specification document: this specification (<a href="#sec-private-state-token">§ 9.1 The 'Sec-Private-State-Token' Header Field</a>)</p>
   <h3 class="heading settled" data-level="12.2" id="iana-sec-private-state-token-lifetime"><span class="secno">12.2. </span><span class="content">'Sec-Private-State-Token-Lifetime' Header Field</span><a class="self-link" href="#iana-sec-private-state-token-lifetime"></a></h3>
   <p>Header field name: Sec-Private-State-Token-Lifetime</p>
   <p>Applicable protocol: http</p>
   <p>Status: standard</p>
   <p>Author/Change controller: IETF</p>
   <p>Specification document: this specification (<a href="#sec-private-state-token-lifetime">§ 9.2 The 'Sec-Private-State-Token-Lifetime' Header Field</a>)</p>
   <h3 class="heading settled" data-level="12.3" id="iana-sec-private-state-token-crypto-version"><span class="secno">12.3. </span><span class="content">'Sec-Private-State-Token-Crypto-Version' Header Field</span><a class="self-link" href="#iana-sec-private-state-token-crypto-version"></a></h3>
   <p>Header field name: Sec-Private-State-Token-Crypto-Version</p>
   <p>Applicable protocol: http</p>
   <p>Status: standard</p>
   <p>Author/Change controller: IETF</p>
   <p>Specification document: this specification (<a href="#sec-private-state-token-crypto-version">§ 9.3 The 'Sec-Private-State-Token-Crypto-Version' Header Field</a>)</p>
   <h3 class="heading settled" data-level="12.4" id="iana-sec-redemption-record"><span class="secno">12.4. </span><span class="content">'Sec-Redemption-Record' Header Field</span><a class="self-link" href="#iana-sec-redemption-record"></a></h3>
   <p>Header field name: Sec-Redemption-Record</p>
   <p>Applicable protocol: http</p>
   <p>Status: standard</p>
   <p>Author/Change controller: IETF</p>
   <p>Specification document: this specification (<a href="#sec-redemption-record">§ 9.4 The 'Sec-Redemption-Record' Header Field</a>)</p>
   <h2 class="no-num heading settled" id="acknowledgments"><span class="content">Acknowledgments</span><a class="self-link" href="#acknowledgments"></a></h2>
   <p>Thanks to Alex Kallam, Charlie Harrison, Chris Fredrickson, David Van Cleve, Dylan Cutler,
Eric Trouton, Johann Hofmann, Kaustubha Govind, Mike Taylor, Ryan Kalla, and Sam
Schlesinger for their contributions. Thanks to Chris Wilson for reviewing and mentoring this spec.</p>
  </main>
  <div data-fill-with="conformance">
   <h2 class="no-ref no-num heading settled" id="w3c-conformance"><span class="content">Conformance</span><a class="self-link" href="#w3c-conformance"></a></h2>
   <h3 class="no-ref no-num heading settled" id="w3c-conventions"><span class="content">Document conventions</span><a class="self-link" href="#w3c-conventions"></a></h3>
   <p>Conformance requirements are expressed
    with a combination of descriptive assertions
    and RFC 2119 terminology.
    The key words “MUST”, “MUST NOT”, “REQUIRED”, “SHALL”, “SHALL NOT”, “SHOULD”, “SHOULD NOT”, “RECOMMENDED”, “MAY”, and “OPTIONAL”
    in the normative parts of this document
    are to be interpreted as described in RFC 2119.
    However, for readability,
    these words do not appear in all uppercase letters in this specification. </p>
   <p>All of the text of this specification is normative
    except sections explicitly marked as non-normative, examples, and notes. <a data-link-type="biblio" href="#biblio-rfc2119" title="Key words for use in RFCs to Indicate Requirement Levels">[RFC2119]</a> </p>
   <p>Examples in this specification are introduced with the words “for example”
    or are set apart from the normative text
    with <code>class="example"</code>,
    like this: </p>
   <div class="example" id="w3c-example">
    <a class="self-link" href="#w3c-example"></a> 
    <p>This is an example of an informative example. </p>
   </div>
   <p>Informative notes begin with the word “Note”
    and are set apart from the normative text
    with <code>class="note"</code>,
    like this: </p>
   <p class="note" role="note">Note, this is an informative note.</p>
  </div>
<script src="https://www.w3.org/scripts/TR/2021/fixup.js"></script>
  <h2 class="no-num no-ref heading settled" id="index"><span class="content">Index</span><a class="self-link" href="#index"></a></h2>
  <h3 class="no-num no-ref heading settled" id="index-defined-here"><span class="content">Terms defined by this specification</span><a class="self-link" href="#index-defined-here"></a></h3>
  <ul class="index">
   <li><a href="#dom-tokenversion-1">"1"</a><span>, in § 5.1</span>
   <li><a href="#append-private-state-token-issue-request-headers">append private state token issue request headers</a><span>, in § 6.1</span>
   <li><a href="#append-private-state-token-redemption-record-headers">append private state token redemption record headers</a><span>, in § 7.2</span>
   <li><a href="#append-private-state-token-redemption-request-headers">append private state token redemption request headers</a><span>, in § 7</span>
   <li><a href="#associate-the-issuer">associate the issuer</a><span>, in § 4</span>
   <li><a href="#determine-whether-associating-an-issuer-would-exceed-the-top-level-limit">determine whether associating an issuer would exceed the top-level limit</a><span>, in § 4</span>
   <li><a href="#discard-tokens">discard tokens</a><span>, in § 4</span>
   <li><a href="#generate-masked-tokens">generate masked tokens</a><span>, in § 4</span>
   <li><a href="#handle-an-issue-response">handle an issue response</a><span>, in § 6.3</span>
   <li><a href="#handle-a-redeem-response">handle a redeem response</a><span>, in § 7.1</span>
   <li><a href="#dom-document-hasprivatetokens">hasPrivateTokens(issuer, type)</a><span>, in § 8.1</span>
   <li><a href="#dom-document-hasredemptionrecord">hasRedemptionRecord(issuer, type)</a><span>, in § 8.2</span>
   <li><a href="#insert-a-token">insert a token</a><span>, in § 4</span>
   <li><a href="#is-associated-with">is associated with</a><span>, in § 4</span>
   <li><a href="#issuerassociations">issuerAssociations</a><span>, in § 4</span>
   <li><a href="#dom-privatetoken-issuers">issuers</a><span>, in § 5.1</span>
   <li><a href="#key-commitment">key commitment</a><span>, in § 3</span>
   <li><a href="#look-up-penultimate-redemption">look up penultimate redemption</a><span>, in § 4</span>
   <li><a href="#look-up-the-key-commitments">look up the key commitments</a><span>, in § 4</span>
   <li><a href="#look-up-the-latest-keys">look up the latest keys</a><span>, in § 4</span>
   <li><a href="#max-batch-size">max batch size</a><span>, in § 4</span>
   <li><a href="#dom-refreshpolicy-none">"none"</a><span>, in § 5.1</span>
   <li><a href="#number-of-tokens">number of tokens</a><span>, in § 4</span>
   <li><a href="#dom-privatetoken-operation">operation</a><span>, in § 5.1</span>
   <li><a href="#enumdef-operationtype">OperationType</a><span>, in § 5.1</span>
   <li><a href="#dom-tokentype-private-state-token">"private-state-token"</a><span>, in § 5.1</span>
   <li><a href="#dictdef-privatetoken">PrivateToken</a><span>, in § 5.1</span>
   <li><a href="#dom-requestinit-privatetoken">privateToken</a><span>, in § 5.1</span>
   <li><a href="#request-private-token-issuers">private token issuers</a><span>, in § 5.2</span>
   <li><a href="#request-private-token-operation">private token operation</a><span>, in § 5.2</span>
   <li><a href="#request-private-token-refresh-policy">private token refresh policy</a><span>, in § 5.2</span>
   <li><a href="#pstkeycommitments">pstKeyCommitments</a><span>, in § 4</span>
   <li><a href="#request-pstpretokens">pstPretokens</a><span>, in § 5.2</span>
   <li><a href="#record-a-redemption-record">record a redemption record</a><span>, in § 4</span>
   <li><a href="#record-redemption-timestamp">record redemption timestamp</a><span>, in § 4</span>
   <li><a href="#redemption-record">Redemption Record</a><span>, in § 7.2</span>
   <li><a href="#redemptionrecords">redemptionRecords</a><span>, in § 4</span>
   <li><a href="#redemptiontimes">redemptionTimes</a><span>, in § 4</span>
   <li><a href="#dom-refreshpolicy-refresh">"refresh"</a><span>, in § 5.1</span>
   <li><a href="#enumdef-refreshpolicy">RefreshPolicy</a><span>, in § 5.1</span>
   <li><a href="#dom-privatetoken-refreshpolicy">refreshPolicy</a><span>, in § 5.1</span>
   <li><a href="#retrieve-a-redemption-record">retrieve a redemption record</a><span>, in § 4</span>
   <li><a href="#retrieve-a-token">retrieve a token</a><span>, in § 4</span>
   <li><a href="#http-headerdef-sec-private-state-token">Sec-Private-State-Token</a><span>, in § 9.1</span>
   <li><a href="#http-headerdef-sec-private-state-token-crypto-version">Sec-Private-State-Token-Crypto-Version</a><span>, in § 9.3</span>
   <li><a href="#http-headerdef-sec-private-state-token-lifetime">Sec-Private-State-Token-Lifetime</a><span>, in § 9.2</span>
   <li><a href="#http-headerdef-sec-redemption-record">Sec-Redemption-Record</a><span>, in § 9.4</span>
   <li><a href="#dom-operationtype-send-redemption-record">"send-redemption-record"</a><span>, in § 5.1</span>
   <li><a href="#set-redemption-headers">set redemption headers</a><span>, in § 7</span>
   <li><a href="#storedtoken">storedToken</a><span>, in § 4</span>
   <li><a href="#dom-operationtype-token-redemption">"token-redemption"</a><span>, in § 5.1</span>
   <li><a href="#dom-operationtype-token-request">"token-request"</a><span>, in § 5.1</span>
   <li><a href="#tokenstore">tokenStore</a><span>, in § 4</span>
   <li><a href="#enumdef-tokentype">TokenType</a><span>, in § 5.1</span>
   <li><a href="#enumdef-tokenversion">TokenVersion</a><span>, in § 5.1</span>
   <li><a href="#dom-privatetoken-type">type</a><span>, in § 5.1</span>
   <li><a href="#unmask-tokens">unmask tokens</a><span>, in § 4</span>
   <li><a href="#dom-privatetoken-version">version</a><span>, in § 5.1</span>
  </ul>
  <h3 class="no-num no-ref heading settled" id="index-defined-elsewhere"><span class="content">Terms defined by reference</span><a class="self-link" href="#index-defined-elsewhere"></a></h3>
  <ul class="index">
   <li>
    <a data-link-type="biblio">[DOM]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="85394472">Document</span>
    </ul>
   <li>
    <a data-link-type="biblio">[FETCH]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="4b1fcc3f">Request(input)</span>
     <li><span class="dfn-paneled" id="0dcd4ad9">RequestInit</span>
     <li><span class="dfn-paneled" id="688f9669">cache mode</span>
     <li><span class="dfn-paneled" id="857d5516">client</span>
     <li><span class="dfn-paneled" id="d5434eef">contains</span>
     <li><span class="dfn-paneled" id="ee95ecc7">delete</span>
     <li><span class="dfn-paneled" id="d47d0690">get</span>
     <li><span class="dfn-paneled" id="6ee0eab1">header list <small>(for request)</small></span>
     <li><span class="dfn-paneled" id="f7b00a8b">header list <small>(for response)</small></span>
     <li><span class="dfn-paneled" id="2aaa2f42">http fetch</span>
     <li><span class="dfn-paneled" id="eb62573b">http(s) scheme</span>
     <li><span class="dfn-paneled" id="980528b0">http-network-or-cache fetch</span>
     <li><span class="dfn-paneled" id="eb1b1af3">network error</span>
     <li><span class="dfn-paneled" id="55213b5b">request</span>
     <li><span class="dfn-paneled" id="162d2b51">request <small>(for Request)</small></span>
     <li><span class="dfn-paneled" id="ee7bba09">response</span>
     <li><span class="dfn-paneled" id="35b98f13">set a structured field value</span>
     <li><span class="dfn-paneled" id="dc1cd39b">url</span>
    </ul>
   <li>
    <a data-link-type="biblio">[HR-TIME-3]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="4b2c8c72">duration</span>
    </ul>
   <li>
    <a data-link-type="biblio">[HTML]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="0e3ba9f8">fully active</span>
     <li><span class="dfn-paneled" id="a72449dd">in parallel</span>
     <li><span class="dfn-paneled" id="b6ae4501">networking task source</span>
     <li><span class="dfn-paneled" id="086e3aff">origin</span>
     <li><span class="dfn-paneled" id="48438eb3">queue a global task</span>
     <li><span class="dfn-paneled" id="e99bd18e">relevant global object</span>
     <li><span class="dfn-paneled" id="9c4c1e66">relevant settings object</span>
     <li><span class="dfn-paneled" id="65181da8">secure context</span>
     <li><span class="dfn-paneled" id="c63519ed">top-level origin</span>
    </ul>
   <li>
    <a data-link-type="biblio">[INFRA]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="53275e46">append</span>
     <li><span class="dfn-paneled" id="77b4c09a">assert</span>
     <li><span class="dfn-paneled" id="3de9e659">byte sequence</span>
     <li><span class="dfn-paneled" id="ae8def21">contain</span>
     <li><span class="dfn-paneled" id="f937b7b6">continue</span>
     <li><span class="dfn-paneled" id="03afaf9c">empty</span>
     <li><span class="dfn-paneled" id="1243a891">exist</span>
     <li><span class="dfn-paneled" id="16d07e10">for each <small>(for list)</small></span>
     <li><span class="dfn-paneled" id="45209803">for each <small>(for map)</small></span>
     <li><span class="dfn-paneled" id="860300d4">implementation-defined</span>
     <li><span class="dfn-paneled" id="649608b9">list</span>
     <li><span class="dfn-paneled" id="3fca5a9e">map</span>
     <li><span class="dfn-paneled" id="99c988d6">remove</span>
     <li><span class="dfn-paneled" id="0e6b2056">set</span>
     <li><span class="dfn-paneled" id="0204d188">size</span>
     <li><span class="dfn-paneled" id="0e8de730">tuple</span>
    </ul>
   <li>
    <a data-link-type="biblio">[RFC8941]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="2d9395b3">integer</span>
     <li><span class="dfn-paneled" id="e982618f">string</span>
     <li><span class="dfn-paneled" id="b8e46276">structured header</span>
    </ul>
   <li>
    <a data-link-type="biblio">[SECURE-CONTEXTS]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="96dabee7">potentially trustworthy origin</span>
    </ul>
   <li>
    <a data-link-type="biblio">[URL]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="959ad97b">origin</span>
     <li><span class="dfn-paneled" id="3a711be7">scheme</span>
     <li><span class="dfn-paneled" id="ca3ca4ae">url parser</span>
    </ul>
   <li>
    <a data-link-type="biblio">[WEBIDL]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="dca2de17">DOMException</span>
     <li><span class="dfn-paneled" id="797018a7">InvalidStateError</span>
     <li><span class="dfn-paneled" id="ba556545">NotAllowedError</span>
     <li><span class="dfn-paneled" id="bdbd19d1">Promise</span>
     <li><span class="dfn-paneled" id="82ca3efc">TypeError</span>
     <li><span class="dfn-paneled" id="b0d7f3c3">USVString</span>
     <li><span class="dfn-paneled" id="dacde8b5">a new promise</span>
     <li><span class="dfn-paneled" id="5372cca8">boolean</span>
     <li><span class="dfn-paneled" id="b262501e">reject</span>
     <li><span class="dfn-paneled" id="3b90bdcd">resolve</span>
     <li><span class="dfn-paneled" id="9cce47fd">sequence</span>
     <li><span class="dfn-paneled" id="4013a022">this</span>
    </ul>
  </ul>
  <h2 class="no-num no-ref heading settled" id="references"><span class="content">References</span><a class="self-link" href="#references"></a></h2>
  <h3 class="no-num no-ref heading settled" id="normative"><span class="content">Normative References</span><a class="self-link" href="#normative"></a></h3>
  <dl>
   <dt id="biblio-dom">[DOM]
   <dd>Anne van Kesteren. <a href="https://dom.spec.whatwg.org/"><cite>DOM Standard</cite></a>. Living Standard. URL: <a href="https://dom.spec.whatwg.org/">https://dom.spec.whatwg.org/</a>
   <dt id="biblio-fetch">[FETCH]
   <dd>Anne van Kesteren. <a href="https://fetch.spec.whatwg.org/"><cite>Fetch Standard</cite></a>. Living Standard. URL: <a href="https://fetch.spec.whatwg.org/">https://fetch.spec.whatwg.org/</a>
   <dt id="biblio-hr-time-3">[HR-TIME-3]
   <dd>Yoav Weiss. <a href="https://w3c.github.io/hr-time/"><cite>High Resolution Time</cite></a>. URL: <a href="https://w3c.github.io/hr-time/">https://w3c.github.io/hr-time/</a>
   <dt id="biblio-html">[HTML]
   <dd>Anne van Kesteren; et al. <a href="https://html.spec.whatwg.org/multipage/"><cite>HTML Standard</cite></a>. Living Standard. URL: <a href="https://html.spec.whatwg.org/multipage/">https://html.spec.whatwg.org/multipage/</a>
   <dt id="biblio-infra">[INFRA]
   <dd>Anne van Kesteren; Domenic Denicola. <a href="https://infra.spec.whatwg.org/"><cite>Infra Standard</cite></a>. Living Standard. URL: <a href="https://infra.spec.whatwg.org/">https://infra.spec.whatwg.org/</a>
   <dt id="biblio-issuer-protocol">[ISSUER-PROTOCOL]
   <dd>S. Valdez; A. Bulut; S. Schlesinger. <a href="https://github.com/WICG/trust-token-api/blob/main/ISSUER_PROTOCOL.md"><cite>ISSUER_PROTOCOL</cite></a>. URL: <a href="https://github.com/WICG/trust-token-api/blob/main/ISSUER_PROTOCOL.md">https://github.com/WICG/trust-token-api/blob/main/ISSUER_PROTOCOL.md</a>
   <dt id="biblio-privacy-pass-architecture">[PRIVACY-PASS-ARCHITECTURE]
   <dd>A. Davidson; J. Iyengar; C. A. Wood. <a href="https://www.ietf.org/archive/id/draft-ietf-privacypass-architecture-06.html"><cite>Privacy Pass Architectural Framework</cite></a>. URL: <a href="https://www.ietf.org/archive/id/draft-ietf-privacypass-architecture-06.html">https://www.ietf.org/archive/id/draft-ietf-privacypass-architecture-06.html</a>
   <dt id="biblio-privacy-pass-auth-scheme">[PRIVACY-PASS-AUTH-SCHEME]
   <dd>T. Pauly; S. Valdez; C. A. Wood. <a href="https://www.ietf.org/archive/id/draft-ietf-privacypass-auth-scheme-05.html"><cite>The Privacy Pass HTTP Authentication Scheme</cite></a>. URL: <a href="https://www.ietf.org/archive/id/draft-ietf-privacypass-auth-scheme-05.html">https://www.ietf.org/archive/id/draft-ietf-privacypass-auth-scheme-05.html</a>
   <dt id="biblio-privacy-pass-issuance-protocol">[PRIVACY-PASS-ISSUANCE-PROTOCOL]
   <dd>S. Celi; et al. <a href="https://www.ietf.org/archive/id/draft-ietf-privacypass-protocol-06.html"><cite>Privacy Pass Issuance Protocol</cite></a>. URL: <a href="https://www.ietf.org/archive/id/draft-ietf-privacypass-protocol-06.html">https://www.ietf.org/archive/id/draft-ietf-privacypass-protocol-06.html</a>
   <dt id="biblio-rfc2119">[RFC2119]
   <dd>S. Bradner. <a href="https://datatracker.ietf.org/doc/html/rfc2119"><cite>Key words for use in RFCs to Indicate Requirement Levels</cite></a>. March 1997. Best Current Practice. URL: <a href="https://datatracker.ietf.org/doc/html/rfc2119">https://datatracker.ietf.org/doc/html/rfc2119</a>
   <dt id="biblio-rfc4648">[RFC4648]
   <dd><a href="https://www.rfc-editor.org/rfc/rfc4648"><cite></cite></a>. URL: <a href="https://www.rfc-editor.org/rfc/rfc4648">https://www.rfc-editor.org/rfc/rfc4648</a>
   <dt id="biblio-rfc8259">[RFC8259]
   <dd>T. Bray, Ed.. <a href="https://www.rfc-editor.org/rfc/rfc8259"><cite>The JavaScript Object Notation (JSON) Data Interchange Format</cite></a>. December 2017. Internet Standard. URL: <a href="https://www.rfc-editor.org/rfc/rfc8259">https://www.rfc-editor.org/rfc/rfc8259</a>
   <dt id="biblio-rfc8446">[RFC8446]
   <dd>E. Rescorla. <a href="https://www.rfc-editor.org/rfc/rfc8446"><cite>The Transport Layer Security (TLS) Protocol Version 1.3</cite></a>. August 2018. Proposed Standard. URL: <a href="https://www.rfc-editor.org/rfc/rfc8446">https://www.rfc-editor.org/rfc/rfc8446</a>
   <dt id="biblio-rfc8536">[RFC8536]
   <dd>A. Olson; P. Eggert; K. Murchison. <a href="https://www.rfc-editor.org/rfc/rfc8536"><cite>The Time Zone Information Format (TZif)</cite></a>. February 2019. Proposed Standard. URL: <a href="https://www.rfc-editor.org/rfc/rfc8536">https://www.rfc-editor.org/rfc/rfc8536</a>
   <dt id="biblio-rfc8941">[RFC8941]
   <dd>M. Nottingham; P-H. Kamp. <a href="https://www.rfc-editor.org/rfc/rfc8941"><cite>Structured Field Values for HTTP</cite></a>. February 2021. Proposed Standard. URL: <a href="https://www.rfc-editor.org/rfc/rfc8941">https://www.rfc-editor.org/rfc/rfc8941</a>
   <dt id="biblio-rfc9110">[RFC9110]
   <dd>R. Fielding, Ed.; M. Nottingham, Ed.; J. Reschke, Ed.. <a href="https://www.rfc-editor.org/rfc/rfc9110"><cite>HTTP Semantics</cite></a>. June 2022. Internet Standard. URL: <a href="https://www.rfc-editor.org/rfc/rfc9110">https://www.rfc-editor.org/rfc/rfc9110</a>
   <dt id="biblio-secure-contexts">[SECURE-CONTEXTS]
   <dd>Mike West. <a href="https://w3c.github.io/webappsec-secure-contexts/"><cite>Secure Contexts</cite></a>. URL: <a href="https://w3c.github.io/webappsec-secure-contexts/">https://w3c.github.io/webappsec-secure-contexts/</a>
   <dt id="biblio-url">[URL]
   <dd>Anne van Kesteren. <a href="https://url.spec.whatwg.org/"><cite>URL Standard</cite></a>. Living Standard. URL: <a href="https://url.spec.whatwg.org/">https://url.spec.whatwg.org/</a>
   <dt id="biblio-voprf">[VOPRF]
   <dd>A. Davidson; et al. <a href="https://www.ietf.org/archive/id/draft-irtf-cfrg-voprf-13.html"><cite>Oblivious Pseudorandom Functions (OPRFs) using Prime-Order Groups</cite></a>. URL: <a href="https://www.ietf.org/archive/id/draft-irtf-cfrg-voprf-13.html">https://www.ietf.org/archive/id/draft-irtf-cfrg-voprf-13.html</a>
   <dt id="biblio-webidl">[WEBIDL]
   <dd>Edgar Chen; Timothy Gu. <a href="https://webidl.spec.whatwg.org/"><cite>Web IDL Standard</cite></a>. Living Standard. URL: <a href="https://webidl.spec.whatwg.org/">https://webidl.spec.whatwg.org/</a>
  </dl>
  <h3 class="no-num no-ref heading settled" id="informative"><span class="content">Informative References</span><a class="self-link" href="#informative"></a></h3>
  <dl>
   <dt id="biblio-privacy-pass-wg">[PRIVACY-PASS-WG]
   <dd><a href="https://datatracker.ietf.org/wg/privacypass/about/"><cite></cite></a>. URL: <a href="https://datatracker.ietf.org/wg/privacypass/about/">https://datatracker.ietf.org/wg/privacypass/about/</a>
   <dt id="biblio-rfc6265">[RFC6265]
   <dd>A. Barth. <a href="https://httpwg.org/specs/rfc6265.html"><cite>HTTP State Management Mechanism</cite></a>. April 2011. Proposed Standard. URL: <a href="https://httpwg.org/specs/rfc6265.html">https://httpwg.org/specs/rfc6265.html</a>
  </dl>
  <h2 class="no-num no-ref heading settled" id="idl-index"><span class="content">IDL Index</span><a class="self-link" href="#idl-index"></a></h2>
<pre class="idl highlight def"><c- b>enum</c-> <a href="#enumdef-refreshpolicy"><code><c- g>RefreshPolicy</c-></code></a> { <a href="#dom-refreshpolicy-none"><code><c- s>"none"</c-></code></a>, <a href="#dom-refreshpolicy-refresh"><code><c- s>"refresh"</c-></code></a> };

<c- b>enum</c-> <a href="#enumdef-tokentype"><code><c- g>TokenType</c-></code></a> { <a href="#dom-tokentype-private-state-token"><code><c- s>"private-state-token"</c-></code></a> };

<c- b>enum</c-> <a href="#enumdef-tokenversion"><code><c- g>TokenVersion</c-></code></a> { <a href="#dom-tokenversion-1"><code><c- s>"1"</c-></code></a> };

<c- b>enum</c-> <a href="#enumdef-operationtype"><code><c- g>OperationType</c-></code></a> { <a href="#dom-operationtype-token-request"><code><c- s>"token-request"</c-></code></a>, <a href="#dom-operationtype-send-redemption-record"><code><c- s>"send-redemption-record"</c-></code></a>, <a href="#dom-operationtype-token-redemption"><code><c- s>"token-redemption"</c-></code></a> };

<c- b>dictionary</c-> <a href="#dictdef-privatetoken"><code><c- g>PrivateToken</c-></code></a> {
  <c- b>required</c-> <a data-link-type="idl-name" href="#enumdef-tokentype"><c- n>TokenType</c-></a> <a data-type="TokenType " href="#dom-privatetoken-type"><code><c- g>type</c-></code></a>;
  <c- b>required</c-> <a data-link-type="idl-name" href="#enumdef-tokenversion"><c- n>TokenVersion</c-></a> <a data-type="TokenVersion " href="#dom-privatetoken-version"><code><c- g>version</c-></code></a>;
  <c- b>required</c-> <a data-link-type="idl-name" href="#enumdef-operationtype"><c- n>OperationType</c-></a> <a data-type="OperationType " href="#dom-privatetoken-operation"><code><c- g>operation</c-></code></a>;
  <a data-link-type="idl-name" href="#enumdef-refreshpolicy"><c- n>RefreshPolicy</c-></a> <a data-default="&quot;none&quot;" data-type="RefreshPolicy " href="#dom-privatetoken-refreshpolicy"><code><c- g>refreshPolicy</c-></code></a> = "none";
  <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#idl-sequence"><c- b>sequence</c-></a>&lt;<a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-USVString"><c- b>USVString</c-></a>> <a data-type="sequence<USVString> " href="#dom-privatetoken-issuers"><code><c- g>issuers</c-></code></a>;
};

<c- b>partial</c-> <c- b>dictionary</c-> <a class="idl-code" data-link-type="dictionary" href="https://fetch.spec.whatwg.org/#requestinit"><c- g>RequestInit</c-></a> {
  <a data-link-type="idl-name" href="#dictdef-privatetoken"><c- n>PrivateToken</c-></a> <a data-type="PrivateToken " href="#dom-requestinit-privatetoken"><code><c- g>privateToken</c-></code></a>;
};

<c- b>partial</c-> <c- b>interface</c-> <a class="idl-code" data-link-type="interface" href="https://dom.spec.whatwg.org/#document"><c- g>Document</c-></a> {
  <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-promise"><c- b>Promise</c-></a>&lt;<a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-boolean"><c- b>boolean</c-></a>> <a class="idl-code" data-link-type="method" href="#dom-document-hasprivatetokens"><c- g>hasPrivateTokens</c-></a>(<a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-USVString"><c- b>USVString</c-></a> <a href="#dom-document-hasprivatetokens-issuer-type-issuer"><code><c- g>issuer</c-></code></a>, <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-USVString"><c- b>USVString</c-></a> <a href="#dom-document-hasprivatetokens-issuer-type-type"><code><c- g>type</c-></code></a>);
  <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-promise"><c- b>Promise</c-></a>&lt;<a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-boolean"><c- b>boolean</c-></a>> <a class="idl-code" data-link-type="method" href="#dom-document-hasredemptionrecord"><c- g>hasRedemptionRecord</c-></a>(<a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-USVString"><c- b>USVString</c-></a> <a href="#dom-document-hasredemptionrecord-issuer-type-issuer"><code><c- g>issuer</c-></code></a>, <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-USVString"><c- b>USVString</c-></a> <a href="#dom-document-hasredemptionrecord-issuer-type-type"><code><c- g>type</c-></code></a>);
};

</pre>
<script>/* script-dfn-panel */
"use strict";
{
    const dfnsJson = window.dfnsJson || {};

    function genDfnPanel({dfnID, url, dfnText, refSections, external}) {
        return mk.aside({
            class: "dfn-panel",
            id: `infopanel-for-${dfnID}`,
            "data-for": dfnID,
            "aria-labelled-by":`infopaneltitle-for-${dfnID}`,
            },
            mk.span({id:`infopaneltitle-for-${dfnID}`, style:"display:none"},
                `Info about the '${dfnText}' ${external?"external":""} reference.`),
            mk.a({href:url}, url),
            mk.b({}, "Referenced in:"),
            mk.ul({},
                ...refSections.map(section=>
                    mk.li({},
                        ...section.refs.map((ref, refI)=>
                            [
                                mk.a({
                                    href: `#${ref.id}`
                                    },
                                    (refI == 0) ? section.title : `(${refI + 1})`
                                ),
                                " ",
                            ]
                        ),
                    ),
                ),
            ),
        );
    }

    function genAllDfnPanels() {
        for(const panelData of Object.values(window.dfnpanelData)) {
            const dfnID = panelData.dfnID;
            const dfn = document.getElementById(dfnID);
            if(!dfn) {
                console.log(`Can't find dfn#${dfnID}.`, panelData);
            } else {
                const panel = genDfnPanel(panelData);
                append(document.body, panel);
                insertDfnPopupAction(dfn, panel)
            }
        }
    }

    document.addEventListener("DOMContentLoaded", ()=>{
        genAllDfnPanels();

        // Add popup behavior to all dfns to show the corresponding dfn-panel.
        var dfns = queryAll('.dfn-paneled');
        for(let dfn of dfns) { ; }

        document.body.addEventListener("click", (e) => {
            // If not handled already, just hide all dfn panels.
            hideAllDfnPanels();
        });
    })


    function hideAllDfnPanels() {
        // Turn off any currently "on" or "activated" panels.
        queryAll(".dfn-panel.on, .dfn-panel.activated").forEach(el=>hideDfnPanel(el));
    }

    function showDfnPanel(dfnPanel, dfn) {
        hideAllDfnPanels(); // Only display one at this time.
        dfn.setAttribute("aria-expanded", "true");
        dfnPanel.classList.add("on");
        dfnPanel.style.left = "5px";
        dfnPanel.style.top = "0px";
        const panelRect = dfnPanel.getBoundingClientRect();
        const panelWidth = panelRect.right - panelRect.left;
        if (panelRect.right > document.body.scrollWidth) {
            // Panel's overflowing the screen.
            // Just drop it below the dfn and flip it rightward instead.
            // This still wont' fix things if the screen is *really* wide,
            // but fixing that's a lot harder without 'anchor()'.
            dfnPanel.style.top = "1.5em";
            dfnPanel.style.left = "auto";
            dfnPanel.style.right = "0px";
        }
    }

    function pinDfnPanel(dfnPanel) {
        // Switch it to "activated" state, which pins it.
        dfnPanel.classList.add("activated");
        dfnPanel.style.left = null;
        dfnPanel.style.top = null;
    }

    function hideDfnPanel(dfnPanel, dfn) {
        if(!dfn) {
            dfn = document.getElementById(dfnPanel.getAttribute("data-for"));
        }
        dfn.setAttribute("aria-expanded", "false")
        dfnPanel.classList.remove("on");
        dfnPanel.classList.remove("activated");
    }

    function toggleDfnPanel(dfnPanel, dfn) {
        if(dfnPanel.classList.contains("on")) {
            hideDfnPanel(dfnPanel, dfn);
        } else {
            showDfnPanel(dfnPanel, dfn);
        }
    }

    function insertDfnPopupAction(dfn, dfnPanel) {
        // Find dfn panel
        const panelWrapper = document.createElement('span');
        panelWrapper.appendChild(dfnPanel);
        panelWrapper.style.position = "relative";
        panelWrapper.style.height = "0px";
        dfn.insertAdjacentElement("afterend", panelWrapper);
        dfn.setAttribute('role', 'button');
        dfn.setAttribute('aria-expanded', 'false')
        dfn.tabIndex = 0;
        dfn.classList.add('has-dfn-panel');
        dfn.addEventListener('click', (event) => {
            showDfnPanel(dfnPanel, dfn);
            event.stopPropagation();
        });
        dfn.addEventListener('keypress', (event) => {
            const kc = event.keyCode;
            // 32->Space, 13->Enter
            if(kc == 32 || kc == 13) {
                toggleDfnPanel(dfnPanel, dfn);
                event.stopPropagation();
                event.preventDefault();
            }
        });

        dfnPanel.addEventListener('click', (event) => {
            if (event.target.nodeName == 'A') {
                pinDfnPanel(dfnPanel);
            }
            event.stopPropagation();
        });

        dfnPanel.addEventListener('keydown', (event) => {
            if(event.keyCode == 27) { // Escape key
                hideDfnPanel(dfnPanel, dfn);
                event.stopPropagation();
                event.preventDefault();
            }
        })
    }
}
</script>
<script>/* script-dfn-panel-json */
window.dfnpanelData = {};
window.dfnpanelData['85394472'] = {"dfnID": "85394472", "url": "https://dom.spec.whatwg.org/#document", "dfnText": "Document", "refSections": [{"refs": [{"id": "ref-for-document"}, {"id": "ref-for-document\u2460"}], "title": "7.3. Changes to Document"}, {"refs": [{"id": "ref-for-document\u2461"}], "title": "8.1. Token Query"}, {"refs": [{"id": "ref-for-document\u2462"}], "title": "8.2. Redemption Record Query"}], "external": true};
window.dfnpanelData['4b1fcc3f'] = {"dfnID": "4b1fcc3f", "url": "https://fetch.spec.whatwg.org/#dom-request", "dfnText": "Request(input)", "refSections": [{"refs": [{"id": "ref-for-dom-request"}], "title": "5.2. Modifications to request"}], "external": true};
window.dfnpanelData['0dcd4ad9'] = {"dfnID": "0dcd4ad9", "url": "https://fetch.spec.whatwg.org/#requestinit", "dfnText": "RequestInit", "refSections": [{"refs": [{"id": "ref-for-requestinit"}, {"id": "ref-for-requestinit\u2460"}], "title": "5.1. Definitions"}], "external": true};
window.dfnpanelData['688f9669'] = {"dfnID": "688f9669", "url": "https://fetch.spec.whatwg.org/#concept-request-cache-mode", "dfnText": "cache mode", "refSections": [{"refs": [{"id": "ref-for-concept-request-cache-mode"}], "title": "6.1. Creating An Issue Request"}, {"refs": [{"id": "ref-for-concept-request-cache-mode\u2460"}], "title": "7. Redeeming Tokens"}], "external": true};
window.dfnpanelData['857d5516'] = {"dfnID": "857d5516", "url": "https://fetch.spec.whatwg.org/#concept-request-client", "dfnText": "client", "refSections": [{"refs": [{"id": "ref-for-concept-request-client"}, {"id": "ref-for-concept-request-client\u2460"}], "title": "6.1. Creating An Issue Request"}, {"refs": [{"id": "ref-for-concept-request-client\u2461"}, {"id": "ref-for-concept-request-client\u2462"}], "title": "7. Redeeming Tokens"}, {"refs": [{"id": "ref-for-concept-request-client\u2463"}], "title": "7.1. Handling Redeem Responses"}, {"refs": [{"id": "ref-for-concept-request-client\u2464"}, {"id": "ref-for-concept-request-client\u2465"}], "title": "7.2. Redemption Records"}], "external": true};
window.dfnpanelData['d5434eef'] = {"dfnID": "d5434eef", "url": "https://fetch.spec.whatwg.org/#header-list-contains", "dfnText": "contains", "refSections": [{"refs": [{"id": "ref-for-header-list-contains"}, {"id": "ref-for-header-list-contains\u2460"}], "title": "6.3. Handling Issue Responses"}, {"refs": [{"id": "ref-for-header-list-contains\u2461"}, {"id": "ref-for-header-list-contains\u2462"}, {"id": "ref-for-header-list-contains\u2463"}], "title": "7.1. Handling Redeem Responses"}], "external": true};
window.dfnpanelData['ee95ecc7'] = {"dfnID": "ee95ecc7", "url": "https://fetch.spec.whatwg.org/#concept-header-list-delete", "dfnText": "delete", "refSections": [{"refs": [{"id": "ref-for-concept-header-list-delete"}], "title": "6.3. Handling Issue Responses"}, {"refs": [{"id": "ref-for-concept-header-list-delete\u2460"}, {"id": "ref-for-concept-header-list-delete\u2461"}], "title": "7.1. Handling Redeem Responses"}], "external": true};
window.dfnpanelData['d47d0690'] = {"dfnID": "d47d0690", "url": "https://fetch.spec.whatwg.org/#concept-header-list-get", "dfnText": "get", "refSections": [{"refs": [{"id": "ref-for-concept-header-list-get"}], "title": "6.3. Handling Issue Responses"}, {"refs": [{"id": "ref-for-concept-header-list-get\u2460"}], "title": "7.1. Handling Redeem Responses"}], "external": true};
window.dfnpanelData['6ee0eab1'] = {"dfnID": "6ee0eab1", "url": "https://fetch.spec.whatwg.org/#concept-request-header-list", "dfnText": "header list (for request)", "refSections": [{"refs": [{"id": "ref-for-concept-request-header-list"}], "title": "6.3. Handling Issue Responses"}, {"refs": [{"id": "ref-for-concept-request-header-list\u2460"}], "title": "7.1. Handling Redeem Responses"}], "external": true};
window.dfnpanelData['f7b00a8b'] = {"dfnID": "f7b00a8b", "url": "https://fetch.spec.whatwg.org/#concept-response-header-list", "dfnText": "header list (for response)", "refSections": [{"refs": [{"id": "ref-for-concept-response-header-list"}, {"id": "ref-for-concept-response-header-list\u2460"}, {"id": "ref-for-concept-response-header-list\u2461"}], "title": "6.3. Handling Issue Responses"}, {"refs": [{"id": "ref-for-concept-response-header-list\u2462"}, {"id": "ref-for-concept-response-header-list\u2463"}, {"id": "ref-for-concept-response-header-list\u2464"}, {"id": "ref-for-concept-response-header-list\u2465"}, {"id": "ref-for-concept-response-header-list\u2466"}], "title": "7.1. Handling Redeem Responses"}], "external": true};
window.dfnpanelData['2aaa2f42'] = {"dfnID": "2aaa2f42", "url": "https://fetch.spec.whatwg.org/#concept-http-fetch", "dfnText": "http fetch", "refSections": [{"refs": [{"id": "ref-for-concept-http-fetch"}], "title": "5.4. Modifications to HTTP fetch steps"}], "external": true};
window.dfnpanelData['eb62573b'] = {"dfnID": "eb62573b", "url": "https://fetch.spec.whatwg.org/#http-scheme", "dfnText": "http(s) scheme", "refSections": [{"refs": [{"id": "ref-for-http-scheme"}], "title": "5.2. Modifications to request"}, {"refs": [{"id": "ref-for-http-scheme\u2460"}], "title": "7.2. Redemption Records"}], "external": true};
window.dfnpanelData['980528b0'] = {"dfnID": "980528b0", "url": "https://fetch.spec.whatwg.org/#concept-http-network-or-cache-fetch", "dfnText": "http-network-or-cache fetch", "refSections": [{"refs": [{"id": "ref-for-concept-http-network-or-cache-fetch"}], "title": "5.3. Modifications to http-network-or-cache fetch"}], "external": true};
window.dfnpanelData['eb1b1af3'] = {"dfnID": "eb1b1af3", "url": "https://fetch.spec.whatwg.org/#concept-network-error", "dfnText": "network error", "refSections": [{"refs": [{"id": "ref-for-concept-network-error"}, {"id": "ref-for-concept-network-error\u2460"}], "title": "5.4. Modifications to HTTP fetch steps"}, {"refs": [{"id": "ref-for-concept-network-error\u2461"}, {"id": "ref-for-concept-network-error\u2462"}], "title": "6.3. Handling Issue Responses"}, {"refs": [{"id": "ref-for-concept-network-error\u2463"}], "title": "7.1. Handling Redeem Responses"}], "external": true};
window.dfnpanelData['55213b5b'] = {"dfnID": "55213b5b", "url": "https://fetch.spec.whatwg.org/#concept-request", "dfnText": "request", "refSections": [{"refs": [{"id": "ref-for-concept-request"}, {"id": "ref-for-concept-request\u2460"}, {"id": "ref-for-concept-request\u2461"}, {"id": "ref-for-concept-request\u2462"}], "title": "5.2. Modifications to request"}, {"refs": [{"id": "ref-for-concept-request\u2463"}, {"id": "ref-for-concept-request\u2464"}], "title": "5.4. Modifications to HTTP fetch steps"}, {"refs": [{"id": "ref-for-concept-request\u2465"}], "title": "6.1. Creating An Issue Request"}, {"refs": [{"id": "ref-for-concept-request\u2466"}], "title": "6.3. Handling Issue Responses"}, {"refs": [{"id": "ref-for-concept-request\u2467"}, {"id": "ref-for-concept-request\u2468"}], "title": "7. Redeeming Tokens"}, {"refs": [{"id": "ref-for-concept-request\u2460\u24ea"}], "title": "7.1. Handling Redeem Responses"}, {"refs": [{"id": "ref-for-concept-request\u2460\u2460"}], "title": "7.2. Redemption Records"}], "external": true};
window.dfnpanelData['162d2b51'] = {"dfnID": "162d2b51", "url": "https://fetch.spec.whatwg.org/#concept-request-request", "dfnText": "request (for Request)", "refSections": [{"refs": [{"id": "ref-for-concept-request-request"}], "title": "5.2. Modifications to request"}], "external": true};
window.dfnpanelData['ee7bba09'] = {"dfnID": "ee7bba09", "url": "https://fetch.spec.whatwg.org/#concept-response", "dfnText": "response", "refSections": [{"refs": [{"id": "ref-for-concept-response"}, {"id": "ref-for-concept-response\u2460"}], "title": "5.4. Modifications to HTTP fetch steps"}, {"refs": [{"id": "ref-for-concept-response\u2461"}], "title": "6.3. Handling Issue Responses"}, {"refs": [{"id": "ref-for-concept-response\u2462"}], "title": "7.1. Handling Redeem Responses"}], "external": true};
window.dfnpanelData['35b98f13'] = {"dfnID": "35b98f13", "url": "https://fetch.spec.whatwg.org/#concept-header-list-set-structured-header", "dfnText": "set a structured field value", "refSections": [{"refs": [{"id": "ref-for-concept-header-list-set-structured-header"}, {"id": "ref-for-concept-header-list-set-structured-header\u2460"}], "title": "6.1. Creating An Issue Request"}, {"refs": [{"id": "ref-for-concept-header-list-set-structured-header\u2461"}, {"id": "ref-for-concept-header-list-set-structured-header\u2462"}, {"id": "ref-for-concept-header-list-set-structured-header\u2463"}], "title": "7. Redeeming Tokens"}], "external": true};
window.dfnpanelData['dc1cd39b'] = {"dfnID": "dc1cd39b", "url": "https://fetch.spec.whatwg.org/#concept-request-url", "dfnText": "url", "refSections": [{"refs": [{"id": "ref-for-concept-request-url"}], "title": "6.1. Creating An Issue Request"}, {"refs": [{"id": "ref-for-concept-request-url\u2460"}], "title": "6.3. Handling Issue Responses"}, {"refs": [{"id": "ref-for-concept-request-url\u2461"}], "title": "7. Redeeming Tokens"}, {"refs": [{"id": "ref-for-concept-request-url\u2462"}], "title": "7.1. Handling Redeem Responses"}], "external": true};
window.dfnpanelData['4b2c8c72'] = {"dfnID": "4b2c8c72", "url": "https://w3c.github.io/hr-time/#dfn-duration", "dfnText": "duration", "refSections": [{"refs": [{"id": "ref-for-dfn-duration"}], "title": "4. Algorithms"}], "external": true};
window.dfnpanelData['0e3ba9f8'] = {"dfnID": "0e3ba9f8", "url": "https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active", "dfnText": "fully active", "refSections": [{"refs": [{"id": "ref-for-fully-active"}], "title": "8.1. Token Query"}, {"refs": [{"id": "ref-for-fully-active\u2460"}], "title": "8.2. Redemption Record Query"}], "external": true};
window.dfnpanelData['a72449dd'] = {"dfnID": "a72449dd", "url": "https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel", "dfnText": "in parallel", "refSections": [{"refs": [{"id": "ref-for-in-parallel"}], "title": "8.1. Token Query"}, {"refs": [{"id": "ref-for-in-parallel\u2460"}], "title": "8.2. Redemption Record Query"}], "external": true};
window.dfnpanelData['b6ae4501'] = {"dfnID": "b6ae4501", "url": "https://html.spec.whatwg.org/multipage/webappapis.html#networking-task-source", "dfnText": "networking task source", "refSections": [{"refs": [{"id": "ref-for-networking-task-source"}, {"id": "ref-for-networking-task-source\u2460"}], "title": "8.1. Token Query"}, {"refs": [{"id": "ref-for-networking-task-source\u2461"}, {"id": "ref-for-networking-task-source\u2462"}], "title": "8.2. Redemption Record Query"}], "external": true};
window.dfnpanelData['086e3aff'] = {"dfnID": "086e3aff", "url": "https://html.spec.whatwg.org/multipage/browsers.html#concept-origin", "dfnText": "origin", "refSections": [{"refs": [{"id": "ref-for-concept-origin"}, {"id": "ref-for-concept-origin\u2460"}, {"id": "ref-for-concept-origin\u2461"}, {"id": "ref-for-concept-origin\u2462"}, {"id": "ref-for-concept-origin\u2463"}, {"id": "ref-for-concept-origin\u2464"}, {"id": "ref-for-concept-origin\u2465"}, {"id": "ref-for-concept-origin\u2466"}, {"id": "ref-for-concept-origin\u2467"}, {"id": "ref-for-concept-origin\u2468"}, {"id": "ref-for-concept-origin\u2460\u24ea"}, {"id": "ref-for-concept-origin\u2460\u2460"}, {"id": "ref-for-concept-origin\u2460\u2461"}, {"id": "ref-for-concept-origin\u2460\u2462"}, {"id": "ref-for-concept-origin\u2460\u2463"}, {"id": "ref-for-concept-origin\u2460\u2464"}, {"id": "ref-for-concept-origin\u2460\u2465"}, {"id": "ref-for-concept-origin\u2460\u2466"}, {"id": "ref-for-concept-origin\u2460\u2467"}, {"id": "ref-for-concept-origin\u2460\u2468"}, {"id": "ref-for-concept-origin\u2461\u24ea"}, {"id": "ref-for-concept-origin\u2461\u2460"}, {"id": "ref-for-concept-origin\u2461\u2461"}, {"id": "ref-for-concept-origin\u2461\u2462"}, {"id": "ref-for-concept-origin\u2461\u2463"}], "title": "4. Algorithms"}, {"refs": [{"id": "ref-for-concept-origin\u2461\u2464"}], "title": "5.2. Modifications to request"}, {"refs": [{"id": "ref-for-concept-origin\u2461\u2465"}], "title": "7.2. Redemption Records"}, {"refs": [{"id": "ref-for-concept-origin\u2461\u2466"}], "title": "8.1. Token Query"}, {"refs": [{"id": "ref-for-concept-origin\u2461\u2467"}], "title": "8.2. Redemption Record Query"}], "external": true};
window.dfnpanelData['48438eb3'] = {"dfnID": "48438eb3", "url": "https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task", "dfnText": "queue a global task", "refSections": [{"refs": [{"id": "ref-for-queue-a-global-task"}, {"id": "ref-for-queue-a-global-task\u2460"}], "title": "8.1. Token Query"}, {"refs": [{"id": "ref-for-queue-a-global-task\u2461"}, {"id": "ref-for-queue-a-global-task\u2462"}], "title": "8.2. Redemption Record Query"}], "external": true};
window.dfnpanelData['e99bd18e'] = {"dfnID": "e99bd18e", "url": "https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-global", "dfnText": "relevant global object", "refSections": [{"refs": [{"id": "ref-for-concept-relevant-global"}], "title": "8.1. Token Query"}, {"refs": [{"id": "ref-for-concept-relevant-global\u2460"}], "title": "8.2. Redemption Record Query"}], "external": true};
window.dfnpanelData['9c4c1e66'] = {"dfnID": "9c4c1e66", "url": "https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object", "dfnText": "relevant settings object", "refSections": [{"refs": [{"id": "ref-for-relevant-settings-object"}], "title": "8.1. Token Query"}, {"refs": [{"id": "ref-for-relevant-settings-object\u2460"}], "title": "8.2. Redemption Record Query"}], "external": true};
window.dfnpanelData['65181da8'] = {"dfnID": "65181da8", "url": "https://html.spec.whatwg.org/multipage/webappapis.html#secure-context", "dfnText": "secure context", "refSections": [{"refs": [{"id": "ref-for-secure-context"}], "title": "6.1. Creating An Issue Request"}, {"refs": [{"id": "ref-for-secure-context\u2460"}], "title": "7. Redeeming Tokens"}, {"refs": [{"id": "ref-for-secure-context\u2461"}], "title": "7.2. Redemption Records"}, {"refs": [{"id": "ref-for-secure-context\u2462"}], "title": "8.1. Token Query"}, {"refs": [{"id": "ref-for-secure-context\u2463"}], "title": "8.2. Redemption Record Query"}], "external": true};
window.dfnpanelData['c63519ed'] = {"dfnID": "c63519ed", "url": "https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-top-level-origin", "dfnText": "top-level origin", "refSections": [{"refs": [{"id": "ref-for-concept-environment-top-level-origin"}], "title": "6.1. Creating An Issue Request"}, {"refs": [{"id": "ref-for-concept-environment-top-level-origin\u2460"}], "title": "7. Redeeming Tokens"}, {"refs": [{"id": "ref-for-concept-environment-top-level-origin\u2461"}], "title": "7.1. Handling Redeem Responses"}, {"refs": [{"id": "ref-for-concept-environment-top-level-origin\u2462"}], "title": "7.2. Redemption Records"}, {"refs": [{"id": "ref-for-concept-environment-top-level-origin\u2463"}], "title": "8.1. Token Query"}, {"refs": [{"id": "ref-for-concept-environment-top-level-origin\u2464"}], "title": "8.2. Redemption Record Query"}], "external": true};
window.dfnpanelData['53275e46'] = {"dfnID": "53275e46", "url": "https://infra.spec.whatwg.org/#list-append", "dfnText": "append", "refSections": [{"refs": [{"id": "ref-for-list-append"}, {"id": "ref-for-list-append\u2460"}], "title": "4. Algorithms"}, {"refs": [{"id": "ref-for-list-append\u2461"}], "title": "5.2. Modifications to request"}, {"refs": [{"id": "ref-for-list-append\u2462"}], "title": "7.2. Redemption Records"}], "external": true};
window.dfnpanelData['77b4c09a'] = {"dfnID": "77b4c09a", "url": "https://infra.spec.whatwg.org/#assert", "dfnText": "assert", "refSections": [{"refs": [{"id": "ref-for-assert"}], "title": "5.2. Modifications to request"}, {"refs": [{"id": "ref-for-assert\u2460"}], "title": "5.3. Modifications to http-network-or-cache fetch"}], "external": true};
window.dfnpanelData['3de9e659'] = {"dfnID": "3de9e659", "url": "https://infra.spec.whatwg.org/#byte-sequence", "dfnText": "byte sequence", "refSections": [{"refs": [{"id": "ref-for-byte-sequence"}, {"id": "ref-for-byte-sequence\u2460"}, {"id": "ref-for-byte-sequence\u2461"}, {"id": "ref-for-byte-sequence\u2462"}, {"id": "ref-for-byte-sequence\u2463"}, {"id": "ref-for-byte-sequence\u2464"}, {"id": "ref-for-byte-sequence\u2465"}, {"id": "ref-for-byte-sequence\u2466"}], "title": "4. Algorithms"}, {"refs": [{"id": "ref-for-byte-sequence\u2467"}], "title": "5.2. Modifications to request"}, {"refs": [{"id": "ref-for-byte-sequence\u2468"}], "title": "7.2. Redemption Records"}], "external": true};
window.dfnpanelData['ae8def21'] = {"dfnID": "ae8def21", "url": "https://infra.spec.whatwg.org/#list-contain", "dfnText": "contain", "refSections": [{"refs": [{"id": "ref-for-list-contain"}, {"id": "ref-for-list-contain\u2460"}], "title": "4. Algorithms"}], "external": true};
window.dfnpanelData['f937b7b6'] = {"dfnID": "f937b7b6", "url": "https://infra.spec.whatwg.org/#iteration-continue", "dfnText": "continue", "refSections": [{"refs": [{"id": "ref-for-iteration-continue"}], "title": "7.2. Redemption Records"}], "external": true};
window.dfnpanelData['03afaf9c'] = {"dfnID": "03afaf9c", "url": "https://infra.spec.whatwg.org/#list-empty", "dfnText": "empty", "refSections": [{"refs": [{"id": "ref-for-list-empty"}], "title": "5.2. Modifications to request"}], "external": true};
window.dfnpanelData['1243a891'] = {"dfnID": "1243a891", "url": "https://infra.spec.whatwg.org/#map-exists", "dfnText": "exist", "refSections": [{"refs": [{"id": "ref-for-map-exists"}, {"id": "ref-for-map-exists\u2460"}, {"id": "ref-for-map-exists\u2461"}, {"id": "ref-for-map-exists\u2462"}, {"id": "ref-for-map-exists\u2463"}, {"id": "ref-for-map-exists\u2464"}, {"id": "ref-for-map-exists\u2465"}, {"id": "ref-for-map-exists\u2466"}, {"id": "ref-for-map-exists\u2467"}, {"id": "ref-for-map-exists\u2468"}, {"id": "ref-for-map-exists\u2460\u24ea"}, {"id": "ref-for-map-exists\u2460\u2460"}], "title": "4. Algorithms"}, {"refs": [{"id": "ref-for-map-exists\u2460\u2461"}, {"id": "ref-for-map-exists\u2460\u2462"}], "title": "5.2. Modifications to request"}], "external": true};
window.dfnpanelData['16d07e10'] = {"dfnID": "16d07e10", "url": "https://infra.spec.whatwg.org/#list-iterate", "dfnText": "for each (for list)", "refSections": [{"refs": [{"id": "ref-for-list-iterate"}], "title": "4. Algorithms"}, {"refs": [{"id": "ref-for-list-iterate\u2460"}], "title": "5.2. Modifications to request"}, {"refs": [{"id": "ref-for-list-iterate\u2461"}, {"id": "ref-for-list-iterate\u2462"}], "title": "7.2. Redemption Records"}], "external": true};
window.dfnpanelData['45209803'] = {"dfnID": "45209803", "url": "https://infra.spec.whatwg.org/#map-iterate", "dfnText": "for each (for map)", "refSections": [{"refs": [{"id": "ref-for-map-iterate"}], "title": "7.2. Redemption Records"}], "external": true};
window.dfnpanelData['860300d4'] = {"dfnID": "860300d4", "url": "https://infra.spec.whatwg.org/#implementation-defined", "dfnText": "implementation-defined", "refSections": [{"refs": [{"id": "ref-for-implementation-defined"}], "title": "3.1. Issuer Key Fetching/Registration"}, {"refs": [{"id": "ref-for-implementation-defined\u2460"}], "title": "4. Algorithms"}, {"refs": [{"id": "ref-for-implementation-defined\u2461"}], "title": "6.1. Creating An Issue Request"}, {"refs": [{"id": "ref-for-implementation-defined\u2462"}], "title": "7. Redeeming Tokens"}, {"refs": [{"id": "ref-for-implementation-defined\u2463"}], "title": "10.3.1. Mitigation: Dynamic Issuance/Redemption Limits"}, {"refs": [{"id": "ref-for-implementation-defined\u2464"}], "title": "11.1. Preventing Token Exhaustion"}], "external": true};
window.dfnpanelData['649608b9'] = {"dfnID": "649608b9", "url": "https://infra.spec.whatwg.org/#list", "dfnText": "list", "refSections": [{"refs": [{"id": "ref-for-list"}, {"id": "ref-for-list\u2460"}, {"id": "ref-for-list\u2461"}, {"id": "ref-for-list\u2462"}, {"id": "ref-for-list\u2463"}], "title": "4. Algorithms"}], "external": true};
window.dfnpanelData['3fca5a9e'] = {"dfnID": "3fca5a9e", "url": "https://infra.spec.whatwg.org/#ordered-map", "dfnText": "map", "refSections": [{"refs": [{"id": "ref-for-ordered-map"}], "title": "3. Issuer Public Keys"}, {"refs": [{"id": "ref-for-ordered-map\u2460"}, {"id": "ref-for-ordered-map\u2461"}, {"id": "ref-for-ordered-map\u2462"}, {"id": "ref-for-ordered-map\u2463"}, {"id": "ref-for-ordered-map\u2464"}], "title": "4. Algorithms"}, {"refs": [{"id": "ref-for-ordered-map\u2465"}], "title": "7.2. Redemption Records"}], "external": true};
window.dfnpanelData['99c988d6'] = {"dfnID": "99c988d6", "url": "https://infra.spec.whatwg.org/#list-remove", "dfnText": "remove", "refSections": [{"refs": [{"id": "ref-for-list-remove"}, {"id": "ref-for-list-remove\u2460"}], "title": "4. Algorithms"}], "external": true};
window.dfnpanelData['0e6b2056'] = {"dfnID": "0e6b2056", "url": "https://infra.spec.whatwg.org/#map-set", "dfnText": "set", "refSections": [{"refs": [{"id": "ref-for-map-set"}, {"id": "ref-for-map-set\u2460"}], "title": "4. Algorithms"}, {"refs": [{"id": "ref-for-map-set\u2461"}], "title": "7.2. Redemption Records"}], "external": true};
window.dfnpanelData['0204d188'] = {"dfnID": "0204d188", "url": "https://infra.spec.whatwg.org/#list-size", "dfnText": "size", "refSections": [{"refs": [{"id": "ref-for-list-size"}, {"id": "ref-for-list-size\u2460"}, {"id": "ref-for-list-size\u2461"}], "title": "4. Algorithms"}], "external": true};
window.dfnpanelData['0e8de730'] = {"dfnID": "0e8de730", "url": "https://infra.spec.whatwg.org/#tuple", "dfnText": "tuple", "refSections": [{"refs": [{"id": "ref-for-tuple"}, {"id": "ref-for-tuple\u2460"}, {"id": "ref-for-tuple\u2461"}, {"id": "ref-for-tuple\u2462"}, {"id": "ref-for-tuple\u2463"}, {"id": "ref-for-tuple\u2464"}, {"id": "ref-for-tuple\u2465"}], "title": "4. Algorithms"}], "external": true};
window.dfnpanelData['2d9395b3'] = {"dfnID": "2d9395b3", "url": "https://tools.ietf.org/html/rfc8941#section-3.3.1", "dfnText": "integer", "refSections": [{"refs": [{"id": "ref-for-section-3.3.1"}], "title": "9.2. The 'Sec-Private-State-Token-Lifetime' Header Field"}], "external": true};
window.dfnpanelData['e982618f'] = {"dfnID": "e982618f", "url": "https://tools.ietf.org/html/rfc8941#section-3.3.3", "dfnText": "string", "refSections": [{"refs": [{"id": "ref-for-section-3.3.3"}], "title": "9.1. The 'Sec-Private-State-Token' Header Field"}, {"refs": [{"id": "ref-for-section-3.3.3\u2460"}], "title": "9.3. The 'Sec-Private-State-Token-Crypto-Version' Header Field"}, {"refs": [{"id": "ref-for-section-3.3.3\u2461"}], "title": "9.4. The 'Sec-Redemption-Record' Header Field"}], "external": true};
window.dfnpanelData['b8e46276'] = {"dfnID": "b8e46276", "url": "https://tools.ietf.org/html/rfc8941#name-introduction", "dfnText": "structured header", "refSections": [{"refs": [{"id": "ref-for-name-introduction"}], "title": "9.1. The 'Sec-Private-State-Token' Header Field"}, {"refs": [{"id": "ref-for-name-introduction\u2460"}], "title": "9.2. The 'Sec-Private-State-Token-Lifetime' Header Field"}, {"refs": [{"id": "ref-for-name-introduction\u2461"}], "title": "9.3. The 'Sec-Private-State-Token-Crypto-Version' Header Field"}, {"refs": [{"id": "ref-for-name-introduction\u2462"}], "title": "9.4. The 'Sec-Redemption-Record' Header Field"}], "external": true};
window.dfnpanelData['96dabee7'] = {"dfnID": "96dabee7", "url": "https://w3c.github.io/webappsec-secure-contexts/#potentially-trustworthy-origin", "dfnText": "potentially trustworthy origin", "refSections": [{"refs": [{"id": "ref-for-potentially-trustworthy-origin"}], "title": "5.2. Modifications to request"}, {"refs": [{"id": "ref-for-potentially-trustworthy-origin\u2460"}], "title": "7.2. Redemption Records"}], "external": true};
window.dfnpanelData['959ad97b'] = {"dfnID": "959ad97b", "url": "https://url.spec.whatwg.org/#concept-url-origin", "dfnText": "origin", "refSections": [{"refs": [{"id": "ref-for-concept-url-origin"}], "title": "6.1. Creating An Issue Request"}, {"refs": [{"id": "ref-for-concept-url-origin\u2460"}], "title": "6.3. Handling Issue Responses"}, {"refs": [{"id": "ref-for-concept-url-origin\u2461"}], "title": "7. Redeeming Tokens"}, {"refs": [{"id": "ref-for-concept-url-origin\u2462"}], "title": "7.1. Handling Redeem Responses"}], "external": true};
window.dfnpanelData['3a711be7'] = {"dfnID": "3a711be7", "url": "https://url.spec.whatwg.org/#concept-url-scheme", "dfnText": "scheme", "refSections": [{"refs": [{"id": "ref-for-concept-url-scheme"}], "title": "5.2. Modifications to request"}, {"refs": [{"id": "ref-for-concept-url-scheme\u2460"}], "title": "7.2. Redemption Records"}], "external": true};
window.dfnpanelData['ca3ca4ae'] = {"dfnID": "ca3ca4ae", "url": "https://url.spec.whatwg.org/#concept-url-parser", "dfnText": "url parser", "refSections": [{"refs": [{"id": "ref-for-concept-url-parser"}], "title": "5.2. Modifications to request"}, {"refs": [{"id": "ref-for-concept-url-parser\u2460"}], "title": "7.2. Redemption Records"}, {"refs": [{"id": "ref-for-concept-url-parser\u2461"}], "title": "8.1. Token Query"}, {"refs": [{"id": "ref-for-concept-url-parser\u2462"}], "title": "8.2. Redemption Record Query"}], "external": true};
window.dfnpanelData['dca2de17'] = {"dfnID": "dca2de17", "url": "https://webidl.spec.whatwg.org/#idl-DOMException", "dfnText": "DOMException", "refSections": [{"refs": [{"id": "ref-for-idl-DOMException"}, {"id": "ref-for-idl-DOMException\u2460"}, {"id": "ref-for-idl-DOMException\u2461"}, {"id": "ref-for-idl-DOMException\u2462"}, {"id": "ref-for-idl-DOMException\u2463"}], "title": "8.1. Token Query"}, {"refs": [{"id": "ref-for-idl-DOMException\u2464"}, {"id": "ref-for-idl-DOMException\u2465"}, {"id": "ref-for-idl-DOMException\u2466"}, {"id": "ref-for-idl-DOMException\u2467"}], "title": "8.2. Redemption Record Query"}], "external": true};
window.dfnpanelData['797018a7'] = {"dfnID": "797018a7", "url": "https://webidl.spec.whatwg.org/#invalidstateerror", "dfnText": "InvalidStateError", "refSections": [{"refs": [{"id": "ref-for-invalidstateerror"}], "title": "8.1. Token Query"}, {"refs": [{"id": "ref-for-invalidstateerror\u2460"}], "title": "8.2. Redemption Record Query"}], "external": true};
window.dfnpanelData['ba556545'] = {"dfnID": "ba556545", "url": "https://webidl.spec.whatwg.org/#notallowederror", "dfnText": "NotAllowedError", "refSections": [{"refs": [{"id": "ref-for-notallowederror"}, {"id": "ref-for-notallowederror\u2460"}], "title": "8.1. Token Query"}, {"refs": [{"id": "ref-for-notallowederror\u2461"}], "title": "8.2. Redemption Record Query"}], "external": true};
window.dfnpanelData['bdbd19d1'] = {"dfnID": "bdbd19d1", "url": "https://webidl.spec.whatwg.org/#idl-promise", "dfnText": "Promise", "refSections": [{"refs": [{"id": "ref-for-idl-promise"}, {"id": "ref-for-idl-promise\u2460"}], "title": "7.3. Changes to Document"}], "external": true};
window.dfnpanelData['82ca3efc'] = {"dfnID": "82ca3efc", "url": "https://webidl.spec.whatwg.org/#exceptiondef-typeerror", "dfnText": "TypeError", "refSections": [{"refs": [{"id": "ref-for-exceptiondef-typeerror"}, {"id": "ref-for-exceptiondef-typeerror\u2460"}, {"id": "ref-for-exceptiondef-typeerror\u2461"}, {"id": "ref-for-exceptiondef-typeerror\u2462"}, {"id": "ref-for-exceptiondef-typeerror\u2463"}], "title": "5.2. Modifications to request"}, {"refs": [{"id": "ref-for-exceptiondef-typeerror\u2464"}, {"id": "ref-for-exceptiondef-typeerror\u2465"}], "title": "8.1. Token Query"}, {"refs": [{"id": "ref-for-exceptiondef-typeerror\u2466"}, {"id": "ref-for-exceptiondef-typeerror\u2467"}], "title": "8.2. Redemption Record Query"}], "external": true};
window.dfnpanelData['b0d7f3c3'] = {"dfnID": "b0d7f3c3", "url": "https://webidl.spec.whatwg.org/#idl-USVString", "dfnText": "USVString", "refSections": [{"refs": [{"id": "ref-for-idl-USVString"}], "title": "5.1. Definitions"}, {"refs": [{"id": "ref-for-idl-USVString\u2460"}, {"id": "ref-for-idl-USVString\u2461"}, {"id": "ref-for-idl-USVString\u2462"}, {"id": "ref-for-idl-USVString\u2463"}], "title": "7.3. Changes to Document"}, {"refs": [{"id": "ref-for-idl-USVString\u2464"}, {"id": "ref-for-idl-USVString\u2465"}], "title": "8.1. Token Query"}, {"refs": [{"id": "ref-for-idl-USVString\u2466"}, {"id": "ref-for-idl-USVString\u2467"}], "title": "8.2. Redemption Record Query"}], "external": true};
window.dfnpanelData['dacde8b5'] = {"dfnID": "dacde8b5", "url": "https://webidl.spec.whatwg.org/#a-new-promise", "dfnText": "a new promise", "refSections": [{"refs": [{"id": "ref-for-a-new-promise"}], "title": "8.1. Token Query"}, {"refs": [{"id": "ref-for-a-new-promise\u2460"}], "title": "8.2. Redemption Record Query"}], "external": true};
window.dfnpanelData['5372cca8'] = {"dfnID": "5372cca8", "url": "https://webidl.spec.whatwg.org/#idl-boolean", "dfnText": "boolean", "refSections": [{"refs": [{"id": "ref-for-idl-boolean"}, {"id": "ref-for-idl-boolean\u2460"}], "title": "7.3. Changes to Document"}], "external": true};
window.dfnpanelData['b262501e'] = {"dfnID": "b262501e", "url": "https://webidl.spec.whatwg.org/#reject", "dfnText": "reject", "refSections": [{"refs": [{"id": "ref-for-reject"}, {"id": "ref-for-reject\u2460"}, {"id": "ref-for-reject\u2461"}, {"id": "ref-for-reject\u2462"}, {"id": "ref-for-reject\u2463"}], "title": "8.1. Token Query"}, {"refs": [{"id": "ref-for-reject\u2464"}, {"id": "ref-for-reject\u2465"}, {"id": "ref-for-reject\u2466"}, {"id": "ref-for-reject\u2467"}], "title": "8.2. Redemption Record Query"}], "external": true};
window.dfnpanelData['3b90bdcd'] = {"dfnID": "3b90bdcd", "url": "https://webidl.spec.whatwg.org/#resolve", "dfnText": "resolve", "refSections": [{"refs": [{"id": "ref-for-resolve"}], "title": "8.1. Token Query"}, {"refs": [{"id": "ref-for-resolve\u2460"}, {"id": "ref-for-resolve\u2461"}], "title": "8.2. Redemption Record Query"}], "external": true};
window.dfnpanelData['9cce47fd'] = {"dfnID": "9cce47fd", "url": "https://webidl.spec.whatwg.org/#idl-sequence", "dfnText": "sequence", "refSections": [{"refs": [{"id": "ref-for-idl-sequence"}], "title": "5.1. Definitions"}], "external": true};
window.dfnpanelData['4013a022'] = {"dfnID": "4013a022", "url": "https://webidl.spec.whatwg.org/#this", "dfnText": "this", "refSections": [{"refs": [{"id": "ref-for-this"}], "title": "5.2. Modifications to request"}], "external": true};
window.dfnpanelData['key-commitment'] = {"dfnID": "key-commitment", "url": "#key-commitment", "dfnText": "key commitment", "refSections": [{"refs": [{"id": "ref-for-key-commitment"}, {"id": "ref-for-key-commitment\u2460"}, {"id": "ref-for-key-commitment\u2461"}], "title": "4. Algorithms"}], "external": false};
window.dfnpanelData['issuerassociations'] = {"dfnID": "issuerassociations", "url": "#issuerassociations", "dfnText": "issuerAssociations", "refSections": [{"refs": [{"id": "ref-for-issuerassociations"}, {"id": "ref-for-issuerassociations\u2460"}, {"id": "ref-for-issuerassociations\u2461"}, {"id": "ref-for-issuerassociations\u2462"}, {"id": "ref-for-issuerassociations\u2463"}, {"id": "ref-for-issuerassociations\u2464"}, {"id": "ref-for-issuerassociations\u2465"}, {"id": "ref-for-issuerassociations\u2466"}], "title": "4. Algorithms"}], "external": false};
window.dfnpanelData['determine-whether-associating-an-issuer-would-exceed-the-top-level-limit'] = {"dfnID": "determine-whether-associating-an-issuer-would-exceed-the-top-level-limit", "url": "#determine-whether-associating-an-issuer-would-exceed-the-top-level-limit", "dfnText": "determine whether associating an issuer would exceed the top-level limit", "refSections": [{"refs": [{"id": "ref-for-determine-whether-associating-an-issuer-would-exceed-the-top-level-limit"}], "title": "6.1. Creating An Issue Request"}, {"refs": [{"id": "ref-for-determine-whether-associating-an-issuer-would-exceed-the-top-level-limit\u2460"}], "title": "7. Redeeming Tokens"}, {"refs": [{"id": "ref-for-determine-whether-associating-an-issuer-would-exceed-the-top-level-limit\u2461"}], "title": "8.1. Token Query"}], "external": false};
window.dfnpanelData['associate-the-issuer'] = {"dfnID": "associate-the-issuer", "url": "#associate-the-issuer", "dfnText": "associate the issuer", "refSections": [{"refs": [{"id": "ref-for-associate-the-issuer"}], "title": "6.1. Creating An Issue Request"}, {"refs": [{"id": "ref-for-associate-the-issuer\u2460"}], "title": "7. Redeeming Tokens"}, {"refs": [{"id": "ref-for-associate-the-issuer\u2461"}], "title": "8.1. Token Query"}], "external": false};
window.dfnpanelData['is-associated-with'] = {"dfnID": "is-associated-with", "url": "#is-associated-with", "dfnText": "is associated with", "refSections": [{"refs": [{"id": "ref-for-is-associated-with"}], "title": "8.2. Redemption Record Query"}], "external": false};
window.dfnpanelData['redemptiontimes'] = {"dfnID": "redemptiontimes", "url": "#redemptiontimes", "dfnText": "redemptionTimes", "refSections": [{"refs": [{"id": "ref-for-redemptiontimes"}, {"id": "ref-for-redemptiontimes\u2460"}, {"id": "ref-for-redemptiontimes\u2461"}, {"id": "ref-for-redemptiontimes\u2462"}, {"id": "ref-for-redemptiontimes\u2463"}, {"id": "ref-for-redemptiontimes\u2464"}, {"id": "ref-for-redemptiontimes\u2465"}], "title": "4. Algorithms"}], "external": false};
window.dfnpanelData['record-redemption-timestamp'] = {"dfnID": "record-redemption-timestamp", "url": "#record-redemption-timestamp", "dfnText": "record redemption timestamp", "refSections": [{"refs": [{"id": "ref-for-record-redemption-timestamp"}], "title": "7.1. Handling Redeem Responses"}], "external": false};
window.dfnpanelData['look-up-penultimate-redemption'] = {"dfnID": "look-up-penultimate-redemption", "url": "#look-up-penultimate-redemption", "dfnText": "look up penultimate redemption", "refSections": [{"refs": [{"id": "ref-for-look-up-penultimate-redemption"}], "title": "7. Redeeming Tokens"}], "external": false};
window.dfnpanelData['redemptionrecords'] = {"dfnID": "redemptionrecords", "url": "#redemptionrecords", "dfnText": "redemptionRecords", "refSections": [{"refs": [{"id": "ref-for-redemptionrecords"}], "title": "4. Algorithms"}], "external": false};
window.dfnpanelData['record-a-redemption-record'] = {"dfnID": "record-a-redemption-record", "url": "#record-a-redemption-record", "dfnText": "record a redemption record", "refSections": [{"refs": [{"id": "ref-for-record-a-redemption-record"}], "title": "7.1. Handling Redeem Responses"}, {"refs": [{"id": "ref-for-record-a-redemption-record\u2460"}], "title": "7.2. Redemption Records"}], "external": false};
window.dfnpanelData['retrieve-a-redemption-record'] = {"dfnID": "retrieve-a-redemption-record", "url": "#retrieve-a-redemption-record", "dfnText": "retrieve a redemption record", "refSections": [{"refs": [{"id": "ref-for-retrieve-a-redemption-record"}], "title": "7. Redeeming Tokens"}, {"refs": [{"id": "ref-for-retrieve-a-redemption-record\u2460"}], "title": "7.2. Redemption Records"}], "external": false};
window.dfnpanelData['pstkeycommitments'] = {"dfnID": "pstkeycommitments", "url": "#pstkeycommitments", "dfnText": "pstKeyCommitments", "refSections": [{"refs": [{"id": "ref-for-pstkeycommitments"}, {"id": "ref-for-pstkeycommitments\u2460"}], "title": "4. Algorithms"}], "external": false};
window.dfnpanelData['look-up-the-key-commitments'] = {"dfnID": "look-up-the-key-commitments", "url": "#look-up-the-key-commitments", "dfnText": "look up the key commitments", "refSections": [{"refs": [{"id": "ref-for-look-up-the-key-commitments"}, {"id": "ref-for-look-up-the-key-commitments\u2460"}], "title": "4. Algorithms"}, {"refs": [{"id": "ref-for-look-up-the-key-commitments\u2461"}], "title": "6.1. Creating An Issue Request"}, {"refs": [{"id": "ref-for-look-up-the-key-commitments\u2462"}], "title": "6.3. Handling Issue Responses"}, {"refs": [{"id": "ref-for-look-up-the-key-commitments\u2463"}], "title": "7. Redeeming Tokens"}, {"refs": [{"id": "ref-for-look-up-the-key-commitments\u2464"}], "title": "8.1. Token Query"}, {"refs": [{"id": "ref-for-look-up-the-key-commitments\u2465"}], "title": "8.2. Redemption Record Query"}], "external": false};
window.dfnpanelData['look-up-the-latest-keys'] = {"dfnID": "look-up-the-latest-keys", "url": "#look-up-the-latest-keys", "dfnText": "look up the latest keys", "refSections": [{"refs": [{"id": "ref-for-look-up-the-latest-keys"}, {"id": "ref-for-look-up-the-latest-keys\u2460"}], "title": "4. Algorithms"}, {"refs": [{"id": "ref-for-look-up-the-latest-keys\u2461"}], "title": "6.1. Creating An Issue Request"}, {"refs": [{"id": "ref-for-look-up-the-latest-keys\u2462"}], "title": "6.3. Handling Issue Responses"}], "external": false};
window.dfnpanelData['tokenstore'] = {"dfnID": "tokenstore", "url": "#tokenstore", "dfnText": "tokenStore", "refSections": [{"refs": [{"id": "ref-for-tokenstore"}, {"id": "ref-for-tokenstore\u2460"}, {"id": "ref-for-tokenstore\u2461"}, {"id": "ref-for-tokenstore\u2462"}, {"id": "ref-for-tokenstore\u2463"}, {"id": "ref-for-tokenstore\u2464"}, {"id": "ref-for-tokenstore\u2465"}, {"id": "ref-for-tokenstore\u2466"}, {"id": "ref-for-tokenstore\u2467"}, {"id": "ref-for-tokenstore\u2468"}], "title": "4. Algorithms"}], "external": false};
window.dfnpanelData['storedtoken'] = {"dfnID": "storedtoken", "url": "#storedtoken", "dfnText": "storedToken", "refSections": [{"refs": [{"id": "ref-for-storedtoken"}], "title": "4. Algorithms"}], "external": false};
window.dfnpanelData['insert-a-token'] = {"dfnID": "insert-a-token", "url": "#insert-a-token", "dfnText": "insert a token", "refSections": [{"refs": [{"id": "ref-for-insert-a-token"}], "title": "6.3. Handling Issue Responses"}], "external": false};
window.dfnpanelData['retrieve-a-token'] = {"dfnID": "retrieve-a-token", "url": "#retrieve-a-token", "dfnText": "retrieve a token", "refSections": [{"refs": [{"id": "ref-for-retrieve-a-token"}], "title": "7. Redeeming Tokens"}], "external": false};
window.dfnpanelData['discard-tokens'] = {"dfnID": "discard-tokens", "url": "#discard-tokens", "dfnText": "discard tokens", "refSections": [{"refs": [{"id": "ref-for-discard-tokens"}], "title": "6.1. Creating An Issue Request"}, {"refs": [{"id": "ref-for-discard-tokens\u2460"}], "title": "7. Redeeming Tokens"}, {"refs": [{"id": "ref-for-discard-tokens\u2461"}], "title": "8.1. Token Query"}, {"refs": [{"id": "ref-for-discard-tokens\u2462"}], "title": "8.2. Redemption Record Query"}], "external": false};
window.dfnpanelData['number-of-tokens'] = {"dfnID": "number-of-tokens", "url": "#number-of-tokens", "dfnText": "number of tokens", "refSections": [{"refs": [{"id": "ref-for-number-of-tokens"}], "title": "6.1. Creating An Issue Request"}], "external": false};
window.dfnpanelData['max-batch-size'] = {"dfnID": "max-batch-size", "url": "#max-batch-size", "dfnText": "max batch size", "refSections": [{"refs": [{"id": "ref-for-max-batch-size"}], "title": "6.1. Creating An Issue Request"}], "external": false};
window.dfnpanelData['generate-masked-tokens'] = {"dfnID": "generate-masked-tokens", "url": "#generate-masked-tokens", "dfnText": "generate masked tokens", "refSections": [{"refs": [{"id": "ref-for-generate-masked-tokens"}], "title": "6.1. Creating An Issue Request"}], "external": false};
window.dfnpanelData['unmask-tokens'] = {"dfnID": "unmask-tokens", "url": "#unmask-tokens", "dfnText": "unmask tokens", "refSections": [{"refs": [{"id": "ref-for-unmask-tokens"}], "title": "6.3. Handling Issue Responses"}], "external": false};
window.dfnpanelData['enumdef-refreshpolicy'] = {"dfnID": "enumdef-refreshpolicy", "url": "#enumdef-refreshpolicy", "dfnText": "RefreshPolicy", "refSections": [{"refs": [{"id": "ref-for-enumdef-refreshpolicy"}, {"id": "ref-for-enumdef-refreshpolicy\u2460"}], "title": "5.1. Definitions"}, {"refs": [{"id": "ref-for-enumdef-refreshpolicy\u2461"}], "title": "5.2. Modifications to request"}], "external": false};
window.dfnpanelData['enumdef-tokentype'] = {"dfnID": "enumdef-tokentype", "url": "#enumdef-tokentype", "dfnText": "TokenType", "refSections": [{"refs": [{"id": "ref-for-enumdef-tokentype"}, {"id": "ref-for-enumdef-tokentype\u2460"}], "title": "5.1. Definitions"}], "external": false};
window.dfnpanelData['enumdef-tokenversion'] = {"dfnID": "enumdef-tokenversion", "url": "#enumdef-tokenversion", "dfnText": "TokenVersion", "refSections": [{"refs": [{"id": "ref-for-enumdef-tokenversion"}, {"id": "ref-for-enumdef-tokenversion\u2460"}], "title": "5.1. Definitions"}], "external": false};
window.dfnpanelData['enumdef-operationtype'] = {"dfnID": "enumdef-operationtype", "url": "#enumdef-operationtype", "dfnText": "OperationType", "refSections": [{"refs": [{"id": "ref-for-enumdef-operationtype"}, {"id": "ref-for-enumdef-operationtype\u2460"}], "title": "5.1. Definitions"}, {"refs": [{"id": "ref-for-enumdef-operationtype\u2461"}], "title": "5.2. Modifications to request"}], "external": false};
window.dfnpanelData['dictdef-privatetoken'] = {"dfnID": "dictdef-privatetoken", "url": "#dictdef-privatetoken", "dfnText": "PrivateToken", "refSections": [{"refs": [{"id": "ref-for-dictdef-privatetoken"}, {"id": "ref-for-dictdef-privatetoken\u2460"}], "title": "5.1. Definitions"}], "external": false};
window.dfnpanelData['dom-privatetoken-operation'] = {"dfnID": "dom-privatetoken-operation", "url": "#dom-privatetoken-operation", "dfnText": "operation", "refSections": [{"refs": [{"id": "ref-for-dom-privatetoken-operation"}, {"id": "ref-for-dom-privatetoken-operation\u2460"}, {"id": "ref-for-dom-privatetoken-operation\u2461"}, {"id": "ref-for-dom-privatetoken-operation\u2462"}], "title": "5.2. Modifications to request"}], "external": false};
window.dfnpanelData['dom-privatetoken-refreshpolicy'] = {"dfnID": "dom-privatetoken-refreshpolicy", "url": "#dom-privatetoken-refreshpolicy", "dfnText": "refreshPolicy", "refSections": [{"refs": [{"id": "ref-for-dom-privatetoken-refreshpolicy"}], "title": "5.2. Modifications to request"}], "external": false};
window.dfnpanelData['dom-privatetoken-issuers'] = {"dfnID": "dom-privatetoken-issuers", "url": "#dom-privatetoken-issuers", "dfnText": "issuers", "refSections": [{"refs": [{"id": "ref-for-dom-privatetoken-issuers"}, {"id": "ref-for-dom-privatetoken-issuers\u2460"}, {"id": "ref-for-dom-privatetoken-issuers\u2461"}], "title": "5.2. Modifications to request"}], "external": false};
window.dfnpanelData['dom-requestinit-privatetoken'] = {"dfnID": "dom-requestinit-privatetoken", "url": "#dom-requestinit-privatetoken", "dfnText": "privateToken", "refSections": [{"refs": [{"id": "ref-for-dom-requestinit-privatetoken"}, {"id": "ref-for-dom-requestinit-privatetoken\u2460"}, {"id": "ref-for-dom-requestinit-privatetoken\u2461"}, {"id": "ref-for-dom-requestinit-privatetoken\u2462"}, {"id": "ref-for-dom-requestinit-privatetoken\u2463"}, {"id": "ref-for-dom-requestinit-privatetoken\u2464"}, {"id": "ref-for-dom-requestinit-privatetoken\u2465"}, {"id": "ref-for-dom-requestinit-privatetoken\u2466"}, {"id": "ref-for-dom-requestinit-privatetoken\u2467"}], "title": "5.2. Modifications to request"}], "external": false};
window.dfnpanelData['request-private-token-refresh-policy'] = {"dfnID": "request-private-token-refresh-policy", "url": "#request-private-token-refresh-policy", "dfnText": "private token refresh policy", "refSections": [{"refs": [{"id": "ref-for-request-private-token-refresh-policy"}, {"id": "ref-for-request-private-token-refresh-policy\u2460"}], "title": "5.2. Modifications to request"}, {"refs": [{"id": "ref-for-request-private-token-refresh-policy\u2461"}], "title": "7. Redeeming Tokens"}], "external": false};
window.dfnpanelData['request-private-token-operation'] = {"dfnID": "request-private-token-operation", "url": "#request-private-token-operation", "dfnText": "private token operation", "refSections": [{"refs": [{"id": "ref-for-request-private-token-operation"}, {"id": "ref-for-request-private-token-operation\u2460"}, {"id": "ref-for-request-private-token-operation\u2461"}, {"id": "ref-for-request-private-token-operation\u2462"}], "title": "5.2. Modifications to request"}, {"refs": [{"id": "ref-for-request-private-token-operation\u2463"}, {"id": "ref-for-request-private-token-operation\u2464"}, {"id": "ref-for-request-private-token-operation\u2465"}, {"id": "ref-for-request-private-token-operation\u2466"}], "title": "5.3. Modifications to http-network-or-cache fetch"}], "external": false};
window.dfnpanelData['request-private-token-issuers'] = {"dfnID": "request-private-token-issuers", "url": "#request-private-token-issuers", "dfnText": "private token issuers", "refSections": [{"refs": [{"id": "ref-for-request-private-token-issuers"}, {"id": "ref-for-request-private-token-issuers\u2460"}, {"id": "ref-for-request-private-token-issuers\u2461"}], "title": "5.2. Modifications to request"}, {"refs": [{"id": "ref-for-request-private-token-issuers\u2462"}, {"id": "ref-for-request-private-token-issuers\u2463"}], "title": "7.2. Redemption Records"}], "external": false};
window.dfnpanelData['request-pstpretokens'] = {"dfnID": "request-pstpretokens", "url": "#request-pstpretokens", "dfnText": "pstPretokens", "refSections": [{"refs": [{"id": "ref-for-request-pstpretokens"}], "title": "6.1. Creating An Issue Request"}, {"refs": [{"id": "ref-for-request-pstpretokens\u2460"}], "title": "6.3. Handling Issue Responses"}], "external": false};
window.dfnpanelData['append-private-state-token-issue-request-headers'] = {"dfnID": "append-private-state-token-issue-request-headers", "url": "#append-private-state-token-issue-request-headers", "dfnText": "append private state token issue request headers", "refSections": [{"refs": [{"id": "ref-for-append-private-state-token-issue-request-headers"}], "title": "5.3. Modifications to http-network-or-cache fetch"}], "external": false};
window.dfnpanelData['handle-an-issue-response'] = {"dfnID": "handle-an-issue-response", "url": "#handle-an-issue-response", "dfnText": "handle an issue response", "refSections": [{"refs": [{"id": "ref-for-handle-an-issue-response"}], "title": "5.4. Modifications to HTTP fetch steps"}], "external": false};
window.dfnpanelData['set-redemption-headers'] = {"dfnID": "set-redemption-headers", "url": "#set-redemption-headers", "dfnText": "set redemption headers", "refSections": [{"refs": [{"id": "ref-for-set-redemption-headers"}, {"id": "ref-for-set-redemption-headers\u2460"}], "title": "7. Redeeming Tokens"}], "external": false};
window.dfnpanelData['append-private-state-token-redemption-request-headers'] = {"dfnID": "append-private-state-token-redemption-request-headers", "url": "#append-private-state-token-redemption-request-headers", "dfnText": "append private state token redemption request headers", "refSections": [{"refs": [{"id": "ref-for-append-private-state-token-redemption-request-headers"}], "title": "5.3. Modifications to http-network-or-cache fetch"}], "external": false};
window.dfnpanelData['handle-a-redeem-response'] = {"dfnID": "handle-a-redeem-response", "url": "#handle-a-redeem-response", "dfnText": "handle a redeem response", "refSections": [{"refs": [{"id": "ref-for-handle-a-redeem-response"}], "title": "5.4. Modifications to HTTP fetch steps"}, {"refs": [{"id": "ref-for-handle-a-redeem-response\u2460"}], "title": "7.2. Redemption Records"}], "external": false};
window.dfnpanelData['redemption-record'] = {"dfnID": "redemption-record", "url": "#redemption-record", "dfnText": "Redemption Record", "refSections": [{"refs": [{"id": "ref-for-redemption-record"}], "title": "5.1. Definitions"}, {"refs": [{"id": "ref-for-redemption-record\u2460"}, {"id": "ref-for-redemption-record\u2461"}], "title": "7. Redeeming Tokens"}, {"refs": [{"id": "ref-for-redemption-record\u2462"}, {"id": "ref-for-redemption-record\u2463"}, {"id": "ref-for-redemption-record\u2464"}], "title": "7.1. Handling Redeem Responses"}, {"refs": [{"id": "ref-for-redemption-record\u2465"}, {"id": "ref-for-redemption-record\u2466"}, {"id": "ref-for-redemption-record\u2467"}], "title": "7.2. Redemption Records"}, {"refs": [{"id": "ref-for-redemption-record\u2468"}], "title": "8.2. Redemption Record Query"}, {"refs": [{"id": "ref-for-redemption-record\u2460\u24ea"}], "title": "9.1. The 'Sec-Private-State-Token' Header Field"}, {"refs": [{"id": "ref-for-redemption-record\u2460\u2460"}], "title": "9.2. The 'Sec-Private-State-Token-Lifetime' Header Field"}, {"refs": [{"id": "ref-for-redemption-record\u2460\u2461"}], "title": "9.4. The 'Sec-Redemption-Record' Header Field"}], "external": false};
window.dfnpanelData['append-private-state-token-redemption-record-headers'] = {"dfnID": "append-private-state-token-redemption-record-headers", "url": "#append-private-state-token-redemption-record-headers", "dfnText": "append private state token redemption record headers", "refSections": [{"refs": [{"id": "ref-for-append-private-state-token-redemption-record-headers"}], "title": "5.3. Modifications to http-network-or-cache fetch"}, {"refs": [{"id": "ref-for-append-private-state-token-redemption-record-headers\u2460"}], "title": "7.2. Redemption Records"}], "external": false};
window.dfnpanelData['dom-document-hasprivatetokens'] = {"dfnID": "dom-document-hasprivatetokens", "url": "#dom-document-hasprivatetokens", "dfnText": "hasPrivateTokens(issuer, type)", "refSections": [{"refs": [{"id": "ref-for-dom-document-hasprivatetokens"}], "title": "7.3. Changes to Document"}], "external": false};
window.dfnpanelData['dom-document-hasredemptionrecord'] = {"dfnID": "dom-document-hasredemptionrecord", "url": "#dom-document-hasredemptionrecord", "dfnText": "hasRedemptionRecord(issuer, type)", "refSections": [{"refs": [{"id": "ref-for-dom-document-hasredemptionrecord"}], "title": "7.3. Changes to Document"}], "external": false};
window.dfnpanelData['http-headerdef-sec-private-state-token'] = {"dfnID": "http-headerdef-sec-private-state-token", "url": "#http-headerdef-sec-private-state-token", "dfnText": "Sec-Private-State-Token", "refSections": [{"refs": [{"id": "ref-for-http-headerdef-sec-private-state-token"}], "title": "6.1. Creating An Issue Request"}, {"refs": [{"id": "ref-for-http-headerdef-sec-private-state-token\u2460"}, {"id": "ref-for-http-headerdef-sec-private-state-token\u2461"}], "title": "6.2. Issuer Signing Tokens"}, {"refs": [{"id": "ref-for-http-headerdef-sec-private-state-token\u2462"}, {"id": "ref-for-http-headerdef-sec-private-state-token\u2463"}, {"id": "ref-for-http-headerdef-sec-private-state-token\u2464"}, {"id": "ref-for-http-headerdef-sec-private-state-token\u2465"}], "title": "6.3. Handling Issue Responses"}, {"refs": [{"id": "ref-for-http-headerdef-sec-private-state-token\u2466"}], "title": "7. Redeeming Tokens"}, {"refs": [{"id": "ref-for-http-headerdef-sec-private-state-token\u2467"}, {"id": "ref-for-http-headerdef-sec-private-state-token\u2468"}, {"id": "ref-for-http-headerdef-sec-private-state-token\u2460\u24ea"}, {"id": "ref-for-http-headerdef-sec-private-state-token\u2460\u2460"}], "title": "7.1. Handling Redeem Responses"}, {"refs": [{"id": "ref-for-http-headerdef-sec-private-state-token\u2460\u2461"}], "title": "7.2. Redemption Records"}, {"refs": [{"id": "ref-for-http-headerdef-sec-private-state-token\u2460\u2462"}], "title": "9.1. The 'Sec-Private-State-Token' Header Field"}, {"refs": [{"id": "ref-for-http-headerdef-sec-private-state-token\u2460\u2463"}], "title": "9.2. The 'Sec-Private-State-Token-Lifetime' Header Field"}, {"refs": [{"id": "ref-for-http-headerdef-sec-private-state-token\u2460\u2464"}], "title": "12. IANA Considerations"}], "external": false};
window.dfnpanelData['http-headerdef-sec-private-state-token-lifetime'] = {"dfnID": "http-headerdef-sec-private-state-token-lifetime", "url": "#http-headerdef-sec-private-state-token-lifetime", "dfnText": "Sec-Private-State-Token-Lifetime", "refSections": [{"refs": [{"id": "ref-for-http-headerdef-sec-private-state-token-lifetime"}], "title": "7. Redeeming Tokens"}, {"refs": [{"id": "ref-for-http-headerdef-sec-private-state-token-lifetime\u2460"}, {"id": "ref-for-http-headerdef-sec-private-state-token-lifetime\u2461"}], "title": "7.1. Handling Redeem Responses"}, {"refs": [{"id": "ref-for-http-headerdef-sec-private-state-token-lifetime\u2462"}, {"id": "ref-for-http-headerdef-sec-private-state-token-lifetime\u2463"}], "title": "7.2. Redemption Records"}, {"refs": [{"id": "ref-for-http-headerdef-sec-private-state-token-lifetime\u2464"}], "title": "12. IANA Considerations"}], "external": false};
window.dfnpanelData['http-headerdef-sec-private-state-token-crypto-version'] = {"dfnID": "http-headerdef-sec-private-state-token-crypto-version", "url": "#http-headerdef-sec-private-state-token-crypto-version", "dfnText": "Sec-Private-State-Token-Crypto-Version", "refSections": [{"refs": [{"id": "ref-for-http-headerdef-sec-private-state-token-crypto-version"}], "title": "6.1. Creating An Issue Request"}, {"refs": [{"id": "ref-for-http-headerdef-sec-private-state-token-crypto-version\u2460"}], "title": "6.2. Issuer Signing Tokens"}, {"refs": [{"id": "ref-for-http-headerdef-sec-private-state-token-crypto-version\u2461"}], "title": "7. Redeeming Tokens"}, {"refs": [{"id": "ref-for-http-headerdef-sec-private-state-token-crypto-version\u2462"}], "title": "12. IANA Considerations"}], "external": false};
window.dfnpanelData['http-headerdef-sec-redemption-record'] = {"dfnID": "http-headerdef-sec-redemption-record", "url": "#http-headerdef-sec-redemption-record", "dfnText": "Sec-Redemption-Record", "refSections": [{"refs": [{"id": "ref-for-http-headerdef-sec-redemption-record"}], "title": "7.2. Redemption Records"}], "external": false};</script>
<script>/* script-dom-helper */
function query(sel) { return document.querySelector(sel); }

function queryAll(sel) { return [...document.querySelectorAll(sel)]; }

function iter(obj) {
	if(!obj) return [];
	var it = obj[Symbol.iterator];
	if(it) return it;
	return Object.entries(obj);
}

function mk(tagname, attrs, ...children) {
	const el = document.createElement(tagname);
	for(const [k,v] of iter(attrs)) {
		if(k.slice(0,3) == "_on") {
			const eventName = k.slice(3);
			el.addEventListener(eventName, v);
		} else if(k[0] == "_") {
			// property, not attribute
			el[k.slice(1)] = v;
		} else {
			if(v === false || v == null) {
        continue;
      } else if(v === true) {
        el.setAttribute(k, "");
        continue;
      } else {
  			el.setAttribute(k, v);
      }
		}
	}
	append(el, children);
	return el;
}

/* Create shortcuts for every known HTML element */
[
  "a",
  "abbr",
  "acronym",
  "address",
  "applet",
  "area",
  "article",
  "aside",
  "audio",
  "b",
  "base",
  "basefont",
  "bdo",
  "big",
  "blockquote",
  "body",
  "br",
  "button",
  "canvas",
  "caption",
  "center",
  "cite",
  "code",
  "col",
  "colgroup",
  "datalist",
  "dd",
  "del",
  "details",
  "dfn",
  "dialog",
  "div",
  "dl",
  "dt",
  "em",
  "embed",
  "fieldset",
  "figcaption",
  "figure",
  "font",
  "footer",
  "form",
  "frame",
  "frameset",
  "head",
  "header",
  "h1",
  "h2",
  "h3",
  "h4",
  "h5",
  "h6",
  "hr",
  "html",
  "i",
  "iframe",
  "img",
  "input",
  "ins",
  "kbd",
  "label",
  "legend",
  "li",
  "link",
  "main",
  "map",
  "mark",
  "meta",
  "meter",
  "nav",
  "nobr",
  "noscript",
  "object",
  "ol",
  "optgroup",
  "option",
  "output",
  "p",
  "param",
  "pre",
  "progress",
  "q",
  "s",
  "samp",
  "script",
  "section",
  "select",
  "small",
  "source",
  "span",
  "strike",
  "strong",
  "style",
  "sub",
  "summary",
  "sup",
  "table",
  "tbody",
  "td",
  "template",
  "textarea",
  "tfoot",
  "th",
  "thead",
  "time",
  "title",
  "tr",
  "u",
  "ul",
  "var",
  "video",
  "wbr",
  "xmp",
].forEach(tagname=>{
	mk[tagname] = (...args) => mk(tagname, ...args);
});

function* nodesFromChildList(children) {
	for(const child of children.flat(Infinity)) {
		if(child instanceof Node) {
			yield child;
		} else {
			yield new Text(child);
		}
	}
}
function append(el, ...children) {
	for(const child of nodesFromChildList(children)) {
		if(el instanceof Node) el.appendChild(child);
		else el.push(child);
	}
	return el;
}

function insertAfter(el, ...children) {
	for(const child of nodesFromChildList(children)) {
		el.parentNode.insertBefore(child, el.nextSibling);
	}
	return el;
}

function clearContents(el) {
	el.innerHTML = "";
	return el;
}

function parseHTML(markup) {
	if(markup.toLowerCase().trim().indexOf('<!doctype') === 0) {
		const doc = document.implementation.createHTMLDocument("");
		doc.documentElement.innerHTML = markup;
		return doc;
	} else {
		const el = mk.template({});
		el.innerHTML = markup;
		return el.content;
	}
}</script>